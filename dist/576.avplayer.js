"use strict";(self.webpackChunkAVPlayer=self.webpackChunkAVPlayer||[]).push([[576],{41576:(e,i,t)=>{t.r(i),t.d(i,{default:()=>S});var a=t(134),s=t(54001),d=t.n(s),n=t(80662),o=t.n(n),r=t(13724),h=t(82800),m=t(95335),l=t(4624),u=t(78417),c=t(77580),g=t(86932),f="src/avnetwork/ioLoader/DashIOLoader.ts";class S extends h.A{constructor(...e){super(...e),(0,a.A)(this,"info",void 0),(0,a.A)(this,"range",void 0),(0,a.A)(this,"mediaPlayList",void 0),(0,a.A)(this,"fetchedMap",void 0),(0,a.A)(this,"fetchedHistoryList",void 0),(0,a.A)(this,"audioLoader",void 0),(0,a.A)(this,"videoLoader",void 0),(0,a.A)(this,"audioSegmentIndex",void 0),(0,a.A)(this,"videoSegmentIndex",void 0),(0,a.A)(this,"audioCurrentUri",void 0),(0,a.A)(this,"videoCurrentUri",void 0),(0,a.A)(this,"audioSelectedIndex",void 0),(0,a.A)(this,"videoSelectedIndex",void 0),(0,a.A)(this,"audioSegments",void 0),(0,a.A)(this,"videoSegments",void 0),(0,a.A)(this,"audioInitSegmentPadding",void 0),(0,a.A)(this,"videoInitSegmentPadding",void 0),(0,a.A)(this,"subtitleInitSegmentPadding",void 0),(0,a.A)(this,"audioInitedSegment",void 0),(0,a.A)(this,"videoInitedSegment",void 0),(0,a.A)(this,"fetchMediaPlayListPromise",void 0),(0,a.A)(this,"minBuffer",void 0)}async fetchMediaPlayList(e){if(!e){if(this.fetchMediaPlayListPromise)return;this.fetchMediaPlayListPromise=new(d())((i=>{e=i}))}const i={method:"GET",headers:{},mode:"cors",cache:"default",referrerPolicy:"no-referrer-when-downgrade"};this.info.headers&&m.__(this.info.headers,((e,t)=>{i.headers[t]=e})),this.info.withCredentials&&(i.credentials="include"),this.info.referrerPolicy&&(i.referrerPolicy=this.info.referrerPolicy);try{const s=await fetch(this.info.url,i),d=await s.text();if(this.mediaPlayList=(0,u.A)(d,this.info.url),this.minBuffer=this.mediaPlayList.minBufferTime,this.options.isLive){var t,a;const i=this.mediaPlayList.minBufferTime/this.mediaPlayList.maxSegmentDuration,s=Math.max(this.mediaPlayList.mediaList.audio&&(null===(t=this.mediaPlayList.mediaList.audio[0])||void 0===t?void 0:t.mediaSegments.length)||0,this.mediaPlayList.mediaList.video&&(null===(a=this.mediaPlayList.mediaList.video[0])||void 0===a?void 0:a.mediaSegments.length)||0);if(s<i)return await new r.A((i-s)*this.mediaPlayList.maxSegmentDuration),l.R8(`wait for min buffer time, buffer: ${s*this.mediaPlayList.maxSegmentDuration}, need: ${i*this.mediaPlayList.maxSegmentDuration}`,f,131),this.fetchMediaPlayList(e)}if("vod"===this.mediaPlayList.type?this.options.isLive=!1:this.options.isLive=!0,this.mediaPlayList.mediaList.audio.length){const e=this.mediaPlayList.mediaList.audio[this.audioSelectedIndex];e.file?this.audioSegments=[e.file]:this.options.isLive&&this.audioInitedSegment===e.initSegment?this.audioSegments=e.mediaSegments.map((e=>e.url)):(this.audioSegments=[e.initSegment].concat(e.mediaSegments.map((e=>e.url))),this.audioInitedSegment=e.initSegment)}if(this.mediaPlayList.mediaList.video.length){this.videoSelectedIndex=this.mediaPlayList.mediaList.video.length-1;const e=this.mediaPlayList.mediaList.video[this.videoSelectedIndex];e.file?this.videoSegments=[e.file]:this.options.isLive&&this.videoInitedSegment===e.initSegment?this.videoSegments=e.mediaSegments.map((e=>e.url)):(this.videoSegments=[e.initSegment].concat(e.mediaSegments.map((e=>e.url))),this.videoInitedSegment=e.initSegment)}return e(),this.fetchMediaPlayListPromise=null,this.status=2,this.retryCount=0,this.mediaPlayList}catch(i){if(this.retryCount<this.options.retryCount)return this.retryCount++,l.z3(`failed fetch mpd file, retry(${this.retryCount}/3)`,f,189),await new r.A(2===this.status?this.options.retryInterval:5),this.fetchMediaPlayList(e);this.status=3,e(),l.h2(`DashLoader: exception, fetch slice error, error: ${i.message}`,f,197)}}async open(e,i){0===this.status&&(this.info=e,this.range=i,this.range.to||(this.range.to=-1),this.range.from=Math.max(this.range.from,0),this.audioSegmentIndex=0,this.videoSegmentIndex=0,this.audioSelectedIndex=0,this.videoSelectedIndex=0,this.fetchedMap=new(o()),this.fetchedHistoryList=[],this.status=1,this.retryCount=0,await this.fetchMediaPlayList())}async readAudio(e){let i=0;if(this.audioLoader){if(i=await this.audioLoader.read(e),-1048576!==i)return i;if(this.options.isLive)this.fetchedMap.set(this.audioCurrentUri,!0),10===this.fetchedHistoryList.length&&this.fetchedMap.delete(this.fetchedHistoryList.shift()),this.fetchedHistoryList.push(this.audioCurrentUri);else if(this.audioSegmentIndex++,this.audioSegmentIndex>=this.audioSegments.length)return-1048576;this.audioLoader=null}if(this.options.isLive){const i=this.audioSegments.filter((e=>!this.fetchedMap.get(e)));if(!i.length){if(this.mediaPlayList.isEnd)return-1048576;const i=(this.mediaPlayList.duration||this.mediaPlayList.minimumUpdatePeriod)-((0,g.A)()-this.mediaPlayList.timestamp)/1e3;if(i>0&&await new r.A(i),this.fetchMediaPlayListPromise){if(await this.fetchMediaPlayListPromise,3===this.status)return-1048576}else await this.fetchMediaPlayList();return this.readAudio(e)}return this.audioCurrentUri=i[0],this.audioLoader=new c.A(m.X$({},this.options,{disableSegment:!0,loop:!1})),await this.audioLoader.open({url:this.audioCurrentUri},{from:0,to:-1}),this.audioLoader.read(e)}return this.audioLoader=new c.A(m.X$({},this.options,{disableSegment:!0,loop:!1})),this.audioInitSegmentPadding?(await this.audioLoader.open({url:this.audioInitSegmentPadding},{from:0,to:-1}),this.audioInitSegmentPadding=null,this.audioSegmentIndex--):await this.audioLoader.open({url:this.audioSegments[this.audioSegmentIndex]},{from:0,to:-1}),this.audioLoader.read(e)}async readVideo(e){let i=0;if(this.videoLoader){if(i=await this.videoLoader.read(e),-1048576!==i)return i;if(this.options.isLive)this.fetchedMap.set(this.videoCurrentUri,!0),10===this.fetchedHistoryList.length&&this.fetchedMap.delete(this.fetchedHistoryList.shift()),this.fetchedHistoryList.push(this.videoCurrentUri);else if(this.videoSegmentIndex++,this.videoSegmentIndex>=this.videoSegments.length)return-1048576;this.videoLoader=null}if(this.options.isLive){const i=this.videoSegments.filter((e=>!this.fetchedMap.get(e)));if(!i.length){if(this.mediaPlayList.isEnd)return-1048576;const i=(this.mediaPlayList.duration||this.mediaPlayList.minimumUpdatePeriod)-((0,g.A)()-this.mediaPlayList.timestamp)/1e3;if(i>0&&await new r.A(Math.max(i,2)),this.fetchMediaPlayListPromise){if(await this.fetchMediaPlayListPromise,3===this.status)return-1048576}else await this.fetchMediaPlayList();return this.readVideo(e)}return this.videoCurrentUri=i[0],this.videoLoader=new c.A(m.X$({},this.options,{disableSegment:!0,loop:!1})),await this.videoLoader.open({url:this.videoCurrentUri},{from:0,to:-1}),this.videoLoader.read(e)}return this.videoLoader=new c.A(m.X$({},this.options,{disableSegment:!0,loop:!1})),this.videoInitSegmentPadding?(await this.videoLoader.open({url:this.videoInitSegmentPadding},{from:0,to:-1}),this.videoInitSegmentPadding=null,this.videoSegmentIndex--):await this.videoLoader.open({url:this.videoSegments[this.videoSegmentIndex]},{from:0,to:-1}),this.videoLoader.read(e)}async read(e,i){return"audio"===i.mediaType?this.readAudio(e):this.readVideo(e)}async seek(e,i){this.audioLoader&&"audio"===i.mediaType&&(await this.audioLoader.abort(),this.audioLoader=null),this.videoLoader&&"video"===i.mediaType&&(await this.videoLoader.abort(),this.videoLoader=null);let t=Number(e);if(this.audioSegments&&"audio"===i.mediaType){let e=0;const i=this.mediaPlayList.mediaList.audio[this.audioSelectedIndex].mediaSegments;if(null!=i&&i.length)for(let a=0;a<i.length;a++)if(t>=1e3*i[a].start&&t<1e3*i[a].end){e=a;break}this.audioSegmentIndex=e+(this.mediaPlayList.mediaList.audio[this.audioSelectedIndex].initSegment?1:0)}if(this.videoSegments&&"video"===i.mediaType){let e=0;const i=this.mediaPlayList.mediaList.video[this.videoSelectedIndex].mediaSegments;if(null!=i&&i.length)for(let a=0;a<i.length;a++)if(t>=1e3*i[a].start&&t<1e3*i[a].end){e=a;break}this.videoSegmentIndex=e+(this.mediaPlayList.mediaList.video[this.videoSelectedIndex].initSegment?1:0)}4===this.status&&(this.status=2)}async size(){return BigInt(0)}async abort(){this.videoLoader&&(await this.videoLoader.abort(),this.videoLoader=null),this.audioLoader&&(await this.audioLoader.abort(),this.audioLoader=null)}async stop(){await this.abort(),this.status=0}getDuration(){return this.mediaPlayList.duration}hasVideo(){var e;return(null===(e=this.mediaPlayList)||void 0===e?void 0:e.mediaList.video.length)>0}hasAudio(){var e;return(null===(e=this.mediaPlayList)||void 0===e?void 0:e.mediaList.audio.length)>0}hasSubtitle(){var e;return(null===(e=this.mediaPlayList)||void 0===e?void 0:e.mediaList.subtitle.length)>0}getVideoList(){return this.hasVideo()?{list:this.mediaPlayList.mediaList.video.map((e=>({width:e.width,height:e.height,frameRate:e.frameRate}))),selectedIndex:this.videoSelectedIndex}:{list:[],selectedIndex:0}}getAudioList(){return this.hasAudio()?{list:this.mediaPlayList.mediaList.audio.map((e=>({lang:e.lang}))),selectedIndex:this.audioSelectedIndex}:{list:[],selectedIndex:0}}getSubtitleList(){return this.hasSubtitle()?{list:this.mediaPlayList.mediaList.subtitle.map((e=>({lang:e.lang,codecs:e.codecs}))),selectedIndex:0}:{list:[],selectedIndex:0}}selectVideo(e){if(e!==this.videoSelectedIndex&&this.hasVideo()&&e>=0&&e<this.mediaPlayList.mediaList.video.length){this.videoSelectedIndex=e;const i=this.mediaPlayList.mediaList.video[this.videoSelectedIndex];i.file?this.videoSegments=[i.file]:(this.videoSegments=[i.initSegment].concat(i.mediaSegments.map((e=>e.url))),this.videoInitSegmentPadding=i.initSegment)}}selectAudio(e){if(e!==this.audioSelectedIndex&&this.hasAudio()&&e>=0&&e<this.mediaPlayList.mediaList.audio.length){this.audioSelectedIndex=e;const i=this.mediaPlayList.mediaList.audio[this.audioSelectedIndex];i.file?this.audioSegments=[i.file]:(this.audioSegments=[i.initSegment].concat(i.mediaSegments.map((e=>e.url))),this.audioInitSegmentPadding=i.initSegment)}}selectSubtitle(e){}getMinBuffer(){return this.minBuffer}}},78417:(e,i,t)=>{t.d(i,{A:()=>g});var a=t(88032),s=t.n(a),d=t(29967),n=t.n(d),o=t(79331),r=t(67672),h=t(62100),m=t(86932);function l(e){let i=0,t=0,a=0;return(e=e.slice(e.indexOf("PT")+2)).indexOf("H")>-1&&e.indexOf("M")>-1&&e.indexOf("S")>-1?(i=s()(e.slice(0,e.indexOf("H"))),t=s()(e.slice(e.indexOf("H")+1,e.indexOf("M"))),a=s()(e.slice(e.indexOf("M")+1,e.indexOf("S")))):e.indexOf("H")<0&&e.indexOf("M")>0&&e.indexOf("S")>-1?(t=s()(e.slice(0,e.indexOf("M"))),a=s()(e.slice(e.indexOf("M")+1,e.indexOf("S")))):e.indexOf("H")<0&&e.indexOf("M")<0&&e.indexOf("S")>-1&&(a=s()(e.slice(0,e.indexOf("S")))),3600*i+60*t+a}function u(e,i){return(Array(i).join("0")+e).slice(-i)}function c(e){if(!e)return 0;if(e.indexOf("/")>-1){const i=e.split("/");return s()(i[0])/s()(i[1])}return s()(e)}function g(e,i){const t={source:e,mediaList:{audio:[],video:[],subtitle:[]},type:"live",isEnd:!1,duration:0,minBufferTime:0,maxSegmentDuration:0,minimumUpdatePeriod:0,timestamp:(0,m.A)()},a=[],d=(g=e,g?(0,o.A)(g):null).MPD;var g;"static"===d.type&&(t.type="vod",t.isEnd=!0),d.minBufferTime&&(t.minBufferTime=l(d.minBufferTime)),d.maxSegmentDuration&&(t.maxSegmentDuration=l(d.maxSegmentDuration)),d.minimumUpdatePeriod&&(t.minimumUpdatePeriod=l(d.minimumUpdatePeriod)),d.mediaPresentationDuration&&(t.duration=l(d.mediaPresentationDuration));let f="";d.BaseURL&&(f=d.BaseURL);const S=r.YO(d.Period)?d.Period[0]:d.Period;return!t.duration&&S&&S.duration&&(t.duration=l(S.duration)),(r.YO(S.AdaptationSet)?S.AdaptationSet:[S.AdaptationSet]).forEach(((e,d)=>{let o="video/mp4",m="avc1.64001E",l=640,g=360,S=640,L=360,p=25,v="1:1",y="1",P=588633,x=f,A="und";e.BaseURL&&(x+=e.BaseURL),e.lang&&(A=e.lang),e.mimeType?(o=e.mimeType,"video/mp4"===o?(m=e.codecs,l=s()(e.width),g=s()(e.height),e.maxWidth&&(S=s()(e.maxWidth)),e.maxHeight&&(L=s()(e.maxHeight)),e.frameRate&&(p=c(e.frameRate)),v=e.sar,y=e.startWithSAP,P=s()(e.bandwidth)):"audio/mp4"===o&&(m=e.codecs,y=e.startWithSAP,P=s()(e.bandwidth))):(e.maxWidth&&(S=s()(e.maxWidth)),e.maxHeight&&(L=s()(e.maxHeight)),e.frameRate&&(p=c(e.frameRate))),(r.YO(e.Representation)?e.Representation:[e.Representation]).forEach(((d,c)=>{a.indexOf(d.id)>-1&&(d.id=(n()(a[a.length-1])+1).toString()),a.push(d.id);let f="";const I=[];let w=0,b=0,O=i.slice(0,i.lastIndexOf("/")+1)+x;d.mimeType&&(o=d.mimeType),"video/mp4"===o?(d.codecs&&(m=d.codecs),d.width&&(l=s()(d.width)),d.height&&(g=s()(d.height)),d.maxWidth&&(S=s()(d.maxWidth)),d.maxHeight&&(L=s()(d.maxHeight)),d.frameRate&&(p=s()(d.frameRate)),d.sar&&(v=d.sar),d.startWithSAP&&(y=d.startWithSAP),d.bandwidth&&(P=s()(d.bandwidth))):(d.codecs&&(m=d.codecs),d.startWithSAP&&(y=d.startWithSAP),d.bandwidth&&(P=s()(d.bandwidth))),d.BaseURL&&(O+=d.BaseURL);let T=!1;if((e.ContentProtection||d.ContentProtection)&&(T=!0),d.SegmentBase)"video/mp4"===o?t.mediaList.video.push({id:d.id,file:O,mimeType:o,codecs:m,width:l,height:g,maxWidth:S,maxHeight:L,frameRate:p,sar:v,startWithSAP:"1"===y,bandwidth:P,timescale:w,duration:b,encrypted:T}):"audio/mp4"===o?t.mediaList.audio.push({id:d.id,file:O,mimeType:o,codecs:m,startWithSAP:"1"===y,bandwidth:P,timescale:w,duration:b,encrypted:T,lang:A}):"application/mp4"===o&&t.mediaList.subtitle.push({id:d.id,file:O,mimeType:o,codecs:m,startWithSAP:"1"===y,bandwidth:P,timescale:w,duration:b,encrypted:T,lang:A});else{let i;if(e.SegmentTemplate&&(i=r.YO(e.SegmentTemplate)?e.SegmentTemplate[0]:e.SegmentTemplate),d.SegmentTemplate&&(i=r.YO(d.SegmentTemplate)?d.SegmentTemplate[0]:d.SegmentTemplate),i){const e=n()(i.startNumber);if(f=i.initialization,w=s()(i.timescale||"1"),i.duration&&!i.SegmentTimeline){b=s()(i.duration);let a=b/w;const n=e+Math.ceil((t.duration||a)/a)-1;for(let s=e;s<=n;s++){const o=a*(s-e);let r=a*(s-e+1);s===n&&(a=t.duration-a*(n-e),r=t.duration),I.push({idx:s,start:o,end:r,url:O+i.media.replace(/\$RepresentationID\$/g,d.id).replace(/\$Number(%(\d+)d)?\$/g,((e,i,t)=>t?u(s,+t):(0,h.A)(s))),segmentDuration:a})}}else if(i.SegmentTimeline&&i.SegmentTimeline.S){const t=r.YO(i.SegmentTimeline.S)?i.SegmentTimeline.S:[i.SegmentTimeline.S];let a=0,o=e;for(let e=0;e<t.length;e++){let r=s()(t[e].d);t[e].t&&(a=s()(t[0].t));let m=1;t[e].r&&(m=n()(t[e].r)+1);for(let e=0;e<m;e++)I.push({idx:o,start:a/w,end:(a+r)/w,url:O+i.media.replace(/\$RepresentationID\$/g,d.id).replace(/\$Number(%(\d+)d)?\$/g,((e,i,t)=>t?u(o,+t):(0,h.A)(o))).replace(/\$Time\$/g,(0,h.A)(a)),segmentDuration:r/w}),o++,a+=r}}}else if(d.SegmentList){const e=r.YO(d.SegmentList.SegmentURL)?d.SegmentList.SegmentURL:[d.SegmentList.SegmentURL];let i=0,t=s()(d.SegmentList.duration);for(let a=0;a<e.length;a++)I.push({idx:a,start:i/w,end:(i+t)/w,url:O+e[a].media,segmentDuration:t/w}),i+=t}"video/mp4"===o?t.mediaList.video.push({id:d.id,baseURL:O,initSegment:O+f.replace(/\$RepresentationID\$/g,d.id).replace(/\$Bandwidth\$/g,(0,h.A)(P)),mediaSegments:I,mimeType:o,codecs:m,width:l,height:g,maxWidth:S,maxHeight:L,frameRate:p,sar:v,startWithSAP:"1"===y,bandwidth:P,timescale:w,duration:b,encrypted:T}):"audio/mp4"===o?t.mediaList.audio.push({id:d.id,baseURL:O,initSegment:O+f.replace(/\$RepresentationID\$/g,d.id).replace(/\$Bandwidth\$/g,(0,h.A)(P)),mediaSegments:I,mimeType:o,codecs:m,startWithSAP:"1"===y,bandwidth:P,timescale:w,duration:b,encrypted:T,lang:A}):"application/mp4"===o&&t.mediaList.subtitle.push({id:d.id,baseURL:O,initSegment:O+f.replace(/\$RepresentationID\$/g,d.id).replace(/\$Bandwidth\$/g,(0,h.A)(P)),mediaSegments:I,mimeType:o,codecs:m,startWithSAP:"1"===y,bandwidth:P,timescale:w,duration:b,encrypted:T,lang:A})}}))})),["video","audio"].forEach((e=>{t.mediaList[e].sort(((e,i)=>e.bandwidth-i.bandwidth))})),t}},79331:(e,i,t)=>{t.d(i,{A:()=>n});var a=t(68632),s=t.n(a);const d={aloneValueName:"_@attribute"};function n(e,i=d){const t={...d,...i};return function(e,i){const t={};let a;for(;a=e.match(/<[^\/][^>]*>/);){let d,o=a[0],r=o.substring(1,o.length-1),h=e.indexOf(o.replace("<","</"));-1==h&&(d=o.match(/[^<][\S+$]*/))&&(r=d[0],h=e.indexOf("</"+r),-1==h&&(h=e.indexOf("<\\/"+r)));let m=e.substring(o.length,h);const l=m.match(/<[^\/][^>]*>/)?n(m,i):m;void 0===t[r]?t[r]=l:s()(t[r])?t[r].push(l):t[r]=[t[r],l],e=e.substring(2*o.length+1+m.length)}return t}(e=function(e,i){return e=function(e,i){const t=e.match(/<[^\/][^>][^<]+\s+.[^<]+[=][^<]+>([^<]+)/g);if(!t)return e;for(let a=0;a<t.length;a++){const s=t[a],d=s.substring(0,s.indexOf(">")+1)+"<"+i+">"+s.substring(s.indexOf(">")+1)+"</"+i+">";e=e.replace(s,d)}return e}(e=function(e){const i=e.match(/<[^/][^>]*\/>/g);if(!i)return e;for(let t=0;t<i.length;t++){const a=i[t],s=a.match(/[^<][\S+$]*/);if(s){const i=s[0],t="</"+i+">",d=o(i,a)+t;e=e.replace(a,d)}}return e}(e=(e=(e=(e=e.replace(/<!--[\s\S]*?-->/g,"")).replace(/[\n\t\r]/g,"")).replace(/>[ \t]+</g,"><")).replace(/<\?[^>]*\?>/g,"")),i),e=function(e){const i=e.match(/<[^\/><]\S+\s+[^<]+[=][^<]+>/g);if(!i)return e;for(let t=0;t<i.length;t++){const a=i[t],s=a.match(/[^<]\S*/);if(s){const i=o(s[0],a);e=e.replace(a,i)}}return e}(e)}(e,t.aloneValueName),t)}function o(e,i){let t="<"+e+">";const a=i.match(/([^"'\s]+)\s*=\s*((?:"[^"]+")|(?:'[^']+'))/g);if(!a)return t;for(let e=0;e<a.length;e++){const i=a[e],s=i.substring(0,i.indexOf("=")).trim(),d=i[i.length-1];t+="<"+s+">"+i.substring(i.indexOf(d)+1,i.lastIndexOf(d))+"</"+s+">"}return t}}}]);