"use strict";(self.webpackChunkAVPlayer=self.webpackChunkAVPlayer||[]).push([[556],{8469:(t,e,a)=>{a.d(e,{En:()=>n,Ij:()=>d,XC:()=>o,hY:()=>r});var i=a(7231);const s={96e3:0,88200:1,64e3:2,48e3:3,44100:4,32e3:5,24e3:6,22050:7,16e3:8,12e3:9,11025:10,8e3:11,7350:12},r=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350,i.N_,i.N_,i.N_],n=[i.N_,1,2,3,4,5,6,7];function o(t,e){if(!e&&t.sideData[1]&&(e=t.sideData[1]),e){const{profile:a,sampleRate:s,channels:o}=function(t){let e=i.N_,a=i.N_,s=i.N_;var o,d;return t.length>=2&&(e=t[0]>>3&31,a=null!==(o=r[(7&t[0])<<1|t[1]>>7])&&void 0!==o?o:48e3,s=null!==(d=n[t[1]>>3&15])&&void 0!==d?d:2),{profile:e,sampleRate:a,channels:s}}(e);t.codecpar.profile=a,t.codecpar.sampleRate=s,t.codecpar.chLayout.nbChannels=o,t.codecpar.channels=o}}function d(t){const e=s[t.sampleRate],a=t.chLayout.nbChannels,i=new Uint8Array(2);return i[0]=(31&t.profile)<<3|(14&e)>>1,i[1]=(1&e)<<7|(15&a)<<3,i}},412:(t,e,a)=>{a.d(e,{Ui:()=>r,XC:()=>s});var i=a(7246);function s(t,e){if(!e&&t.sideData[1]&&(e=t.sideData[1]),e&&e.length>=4){const a=r(e);t.codecpar.profile=a.profile,t.codecpar.level=a.level}}function r(t){const e=new i.A(t.length);e.appendBuffer(t),e.readU1(),e.readU(7);const a=e.readU(3),s=e.readU(5),r=e.readU1();let n=e.readU1()?10:8;return e.readU1()&&(n=12),{profile:a,level:s,tier:r,bitDepth:n,monochrome:e.readU1(),chromaSubsamplingX:e.readU1(),chromaSubsamplingY:e.readU1(),chromaSamplePosition:e.readU(2)}}},620:(t,e,a)=>{a.d(e,{Jk:()=>z,XC:()=>v,ci:()=>b,oT:()=>U});var i=a(3939),s=a(932),r=a(2739),n=a(729),o=a(1865),d=a(7246),c=a(4624),l=a(4686),f=a(1517),p=a(264),h=a(7837),u=a(3991),m="src/avformat/codecs/h264.ts";const w=3;function g(t,e,a=[]){t.length>32&&(c.R8(`h264 metadata's sps max length is 32, but get ${t.length}`,m,159),t=t.slice(0,32)),t.length>256&&(c.R8(`h264 metadata's pps max length is 256, but get ${t.length}`,m,163),t=t.slice(0,256));let i=7;i=t.reduce(((t,e)=>t+2+e.length),i),i=e.reduce(((t,e)=>t+2+e.length),i);const s=t[0],o=k(s);66!==o.profile&&77!==o.profile&&88!==o.profile&&(i+=4,a.length&&(i=a.reduce(((t,e)=>t+2+e.length),i)));const d=new Uint8Array(i),l=new n.A(d);return l.writeUint8(1),l.writeUint8(s[1]),l.writeUint8(s[2]),l.writeUint8(s[3]),l.writeUint8(252|w),l.writeUint8(224|31&t.length),r.__(t,(t=>{l.writeUint16(t.length),l.writeBuffer(t)})),l.writeUint8(e.length),r.__(e,(t=>{l.writeUint16(t.length),l.writeBuffer(t)})),66!==o.profile&&77!==o.profile&&88!==o.profile&&(l.writeUint8(252|o.chromaFormatIdc),l.writeUint8(248|o.bitDepthLumaMinus8),l.writeUint8(248|o.bitDepthChromaMinus8),a.length&&r.__(a,(t=>{l.writeUint16(t.length),l.writeBuffer(t)}))),d}function U(t){let e,a=(0,p.py)(t),i=!1;if(a.length>1){const t=[],i=[],s=[];a.forEach((e=>{const a=31&e[0];7===a?t.push(e):8===a?i.push(e):13===a&&s.push(e)})),t.length&&i.length&&(e=g(t,i,s)),a=a.filter((t=>{const e=31&t[0];return 9!==e&&8!==e&&7!==e&&13!==e}))}const s=a.reduce(((t,e)=>t+w+1+e.length),0),o=(0,h.sY)(s),d=(0,l.s3)(o,s),c=new n.A(d);return r.__(a,(t=>{3===w?c.writeUint32(t.length):2===w?c.writeUint24(t.length):1===w?c.writeUint16(t.length):c.writeUint8(t.length),c.writeBuffer(t.subarray(0)),5==(31&t[0])&&(i=!0)})),{bufferPointer:o,length:s,key:i,extradata:e}}function z(t,e){var a;if(!(1&i.f[15](t+36)))return;const s=(0,f.iI)(t);if((0,p.Bs)(s))return;const r=null!==(a=e.metadata.naluLengthSizeMinusOne)&&void 0!==a?a:w;let n=[],d=[],c=[],u=[];const m=new o.A(s);for(;m.remainingSize()>0;){let t=0;t=3===r?m.readUint32():2===r?m.readUint24():1===r?m.readUint16():m.readUint8();const e=s.subarray(0|Number(0xffffffffn&m.getPos()),(0|Number(0xffffffffn&m.getPos()))+t);m.skip(t);const a=31&e[0];7===a?n.push(e):8===a?d.push(e):13===a?c.push(e):u.push(e)}if(n.length||d.length){const e=g(n,d,c),a=(0,h.sY)(e.length);(0,l.lW)(a,e.length,e),(0,f.Ow)(t,1,a,e.length)}}function b(t,e=!1){if(!(1&i.f[15](t+36)||e))return;const a=(0,f.iI)(t);if(!(0,p.Bs)(a))return;let r=(0,p.py)(a);if(r.length>1){const e=[],a=[],n=[];if(r.forEach((t=>{const i=31&t[0];7===i?e.push(t):8===i?a.push(t):13===i&&n.push(t)})),e.length&&a.length){const r=g(e,a,n),o=(0,h.sY)(r.length);(0,l.lW)(o,r.length,r),(0,f.Ow)(t,1,o,r.length),s.M[15](t+36,1|i.f[15](t+36))}}}function v(t,e){if(!e&&t.sideData[1]&&(e=t.sideData[1]),e&&e.length>=6){t.metadata.naluLengthSizeMinusOne=3&e[4];const{spss:a}=function(t){const e=new o.A(t);e.skip(5);const a=[],i=[],s=[],r=31&e.readUint8();for(let t=0;t<r;t++){const t=e.readUint16();a.push(e.readBuffer(t))}const n=e.readUint8();for(let t=0;t<n;t++){const t=e.readUint16();i.push(e.readBuffer(t))}if(e.remainingSize()>4){e.skip(3);const t=e.readUint8();if(t>0)for(let a=0;a<t;a++){const t=e.readUint16();s.push(e.readBuffer(t))}}return{spss:a,ppss:i,spsExts:s}}(e);if(a.length){const{profile:e,level:i,width:s,height:r}=k(a[0]);t.codecpar.profile=e,t.codecpar.level=i,t.codecpar.width=s,t.codecpar.height=r}}}function k(t){if(!t||t.length<3)return;let e=0;0===t[0]&&0===t[1]&&0===t[2]&&1===t[3]&&(e=4);const a=(0,p.BN)(t.subarray(e)),i=new d.A(a.length);i.appendBuffer(a),i.readU1(),i.readU(2),i.readU(5);const s=i.readU(8);i.readU1(),i.readU1(),i.readU1(),i.readU1(),i.readU1(),i.readU1(),i.readU(2);const r=i.readU(8);u.xb(i);let n=1,o=0,c=0;if((100==s||110==s||122==s||244==s||44==s||83==s||86==s||118==s||128==s||138==s||139==s||134==s||135==s)&&(n=u.xb(i),3===n&&i.readU1(),o=u.xb(i),c=u.xb(i),i.readU1(),i.readU1())){const t=new Array(8);for(let e=0;e<(3!=n?8:12);e++)t[e]=i.readU1()}u.xb(i);const l=u.xb(i);if(0===l)u.xb(i);else if(1===l){i.readU1(),u.$x(i),u.$x(i);const t=u.xb(i);for(let e=0;e<t;e++)u.$x(i)}u.xb(i),i.readU1();const f=u.xb(i),h=u.xb(i),m=i.readU1();let w=16*(f+1),g=(2-m)*(h+1)*16;m||i.readU1(),i.readU1();const U=i.readU1();if(U){let t=1,e=2-U;1===n?(t=2,e=2*(2-U)):2===U&&(t=2,e=2-U),w-=t*(u.xb(i)+u.xb(i)),g-=e*(u.xb(i)+u.xb(i))}return{profile:s,level:r,width:w,height:g,chromaFormatIdc:n,bitDepthLumaMinus8:o,bitDepthChromaMinus8:c}}},3e3:(t,e,a)=>{a.d(e,{Jk:()=>g,XC:()=>z,ci:()=>U,oT:()=>w});var i=a(3939),s=a(932),r=a(2739),n=a(729),o=a(1865),d=a(7246),c=a(4686),l=a(264),f=a(1517),p=a(7837),h=a(3991);const u=3;function m(t,e,a){const i=e[0];let s=23;t.length&&(s+=3,s=t.reduce(((t,e)=>t+2+e.length),s)),e.length&&(s+=3,s=e.reduce(((t,e)=>t+2+e.length),s)),a.length&&(s+=3,s=a.reduce(((t,e)=>t+2+e.length),s));const o=new Uint8Array(s),d=new n.A(o,!0),c=b(i);d.writeUint8(1),d.writeUint8(i[1]),d.writeUint8(i[2]),d.writeUint8(i[3]),d.writeUint8(i[4]),d.writeUint8(i[5]),d.writeUint8(i[6]),d.writeUint8(i[7]),d.writeUint8(i[8]),d.writeUint8(i[9]),d.writeUint8(i[10]),d.writeUint8(i[11]),d.writeUint8(c.level),d.writeUint8(1020),d.writeUint8(0),d.writeUint8(16320),d.writeUint8(16320|c.chromaFormatIdc),d.writeUint8(8160|c.bitDepthLumaMinus8),d.writeUint8(8160|c.bitDepthChromaMinus8),d.writeUint16(0),d.writeUint8(8|(1&i[0])<<2|u);let l=0;return t.length&&l++,e.length&&l++,a.length&&l++,d.writeUint8(l),t.length&&(d.writeUint8(160),d.writeUint16(t.length),r.__(t,(t=>{d.writeUint16(t.length),d.writeBuffer(t)}))),e.length&&(d.writeUint8(161),d.writeUint16(e.length),r.__(e,(t=>{d.writeUint16(t.length),d.writeBuffer(t)}))),a.length&&(d.writeUint8(162),d.writeUint16(a.length),r.__(a,(t=>{d.writeUint16(t.length),d.writeBuffer(t)}))),o}function w(t){let e,a=!1,i=(0,l.py)(t);if(i.length>2){const t=[],a=[],s=[];i.forEach((e=>{const i=e[0]>>>1&63;32===i?t.push(e):33===i?a.push(e):34===i&&s.push(e)})),t.length&&a.length&&s.length&&(e=m(t,a,s),i=i.filter((t=>{const e=t[0]>>>1&63;return 32!==e&&33!==e&&34!==e&&35!==e})))}const s=i.reduce(((t,e)=>t+u+1+e.length),0),o=(0,p.sY)(s),d=(0,c.s3)(o,s),f=new n.A(d);return r.__(i,(t=>{3===u?f.writeUint32(t.length):2===u?f.writeUint24(t.length):1===u?f.writeUint16(t.length):f.writeUint8(t.length),f.writeBuffer(t.subarray(0));const e=t[0]>>>1&63;19!==e&&20!==e&&21!==e||(a=!0)})),{bufferPointer:o,length:s,extradata:e,key:a}}function g(t,e){var a;if(!(1&i.f[15](t+36)))return;const s=(0,f.iI)(t);if((0,l.Bs)(s))return;const r=null!==(a=e.metadata.naluLengthSizeMinusOne)&&void 0!==a?a:u;let n=[],d=[],h=[];const w=new o.A(s);for(;w.remainingSize()>0;){let t=0;t=3===r?w.readUint32():2===r?w.readUint24():1===r?w.readUint16():w.readUint8();const e=s.subarray(0|Number(0xffffffffn&w.getPos()),(0|Number(0xffffffffn&w.getPos()))+t);w.skip(t);const a=e[0]>>>1&63;33===a?d.push(e):34===a?h.push(e):32===a&&n.push(e)}if(d.length||h.length||n.length){const e=m(n,d,h),a=(0,p.sY)(e.length);(0,c.lW)(a,e.length,e),(0,f.Ow)(t,1,a,e.length)}}function U(t,e=!1){if(!(1&i.f[15](t+36)||e))return;const a=(0,f.iI)(t);if(!(0,l.Bs)(a))return;let r=(0,l.py)(a);if(r.length>2){const e=[],a=[],n=[];if(r.forEach((t=>{const i=t[0]>>>1&63;32===i?e.push(t):33===i?a.push(t):34===i&&n.push(t)})),e.length&&a.length&&n.length){const r=m(e,a,n),o=(0,p.sY)(r.length);(0,c.lW)(o,r.length,r),(0,f.Ow)(t,1,o,r.length),s.M[15](t+36,1|i.f[15](t+36))}}}function z(t,e){if(!e&&t.sideData[1]&&(e=t.sideData[1]),e&&e.length>=6){t.metadata.naluLengthSizeMinusOne=3&e[21];const{spss:a}=function(t){const e=new o.A(t,!0);e.skip(22);let a=[],i=[],s=[];const r=e.readUint8();for(let t=0;t<r;t++){const t=63&e.readUint8(),r=e.readUint16(),n=[];for(let t=0;t<r;t++){const t=e.readUint16();n.push(e.readBuffer(t))}32===t?a=n:33===t?i=n:34===t&&(s=n)}return{vpss:a,spss:i,ppss:s}}(e);if(a.length){const{profile:e,level:i,width:s,height:r}=b(a[0]);t.codecpar.profile=e,t.codecpar.level=i,t.codecpar.width=s,t.codecpar.height=r}}}function b(t){if(!t||t.length<3)return;let e=0;0===t[0]&&0===t[1]&&0===t[2]&&1===t[3]&&(e=4);let a=0,i=0,s=0,r=0,n=0,o=0,c=1,f=0,p=0,u=0,m=0;const w=(0,l.BN)(t.subarray(e)),g=new d.A(w.length);g.appendBuffer(w),g.readU1(),g.readU(6),g.readU(6),g.readU(3),g.readU(4);const U=g.readU(3);if(g.readU1(),U<=6){f=g.readU(2),p=g.readU1(),a=g.readU(5),u=g.readU(32),m=g.readU(48),i=g.readU(8);const t=new Array(6),e=new Array(6);for(let a=0;a<U;a++)t[a]=g.readU1(),e[a]=g.readU1();if(U>0)for(let t=U;t<8;t++)g.readU(2);for(let a=0;a<U;a++)t[a]&&(g.readU(2),g.readU(1),g.readU(5),g.readU(32),g.readU(1),g.readU(1),g.readU(1),g.readU(1),g.readU(44)),e[a]&&g.readU(8);h.xb(g),c=h.xb(g),3===c&&g.readU(1),s=h.xb(g),r=h.xb(g);let d=0,l=0,w=0,z=0;g.readU1()&&(d=h.xb(g),l=h.xb(g),w=h.xb(g),z=h.xb(g)),n=h.xb(g),o=h.xb(g);let b=2,v=2;0===c?b=v=0:2===c?(b=2,v=1):3===c&&(b=v=1),s-=b*(1<<n+1)*(d+l),r-=v*(1<<n+1)*(w+z)}return{profile:a,level:i,width:s,height:r,chromaFormatIdc:c,bitDepthLumaMinus8:n,bitDepthChromaMinus8:o,generalProfileSpace:f,generalTierFlag:p,generalProfileCompatibilityFlag:u,constraintFlags:m}}},5451:(t,e,a)=>{a.d(e,{Ij:()=>c,XC:()=>d,kt:()=>o});var i=a(1865),s=a(729),r=a(4328);const n=[480,960,1920,2880,480,960,1920,2880,480,960,1920,2880,480,960,480,960,120,240,480,960,120,240,480,960,120,240,480,960,120,240,480,960];function o(t){let e=0,a=0,i=0;if(t.length<1)return 0;switch(e=t[0],a=n[e>>3],3&e){case 0:i=1;break;case 1:case 2:i=2;break;case 3:if(t.length<2)return 0;i=63&t[1]}return i*a}function d(t,e){if(!e&&t.sideData[1]&&(e=t.sideData[1]),e&&e.length>=19){const a=new i.A(e,!1);a.skip(9),t.codecpar.chLayout.nbChannels=a.readUint8(),t.codecpar.channels=t.codecpar.chLayout.nbChannels,t.codecpar.initialPadding=a.readUint16(),t.codecpar.sampleRate=a.readUint32(),t.codecpar.seekPreroll=Number((0,r.k)(BigInt(80),{den:1e3,num:1},{den:48e3,num:1}))}}function c(t){const e=new Uint8Array(19),a=new s.A(e,!1);return a.writeString("OpusHead"),a.writeUint8(1),a.writeUint8(t.chLayout.nbChannels),a.writeUint16(t.initialPadding),a.writeUint32(t.sampleRate),e}},8919:(t,e,a)=>{a.d(e,{U:()=>r,X:()=>s});var i=a(7246);function s(t,e){if(!e&&t.sideData[1]&&(e=t.sideData[1]),e&&e.length>=6){const a=r(e);t.codecpar.profile=a.profile,t.codecpar.level=a.level}}function r(t){const e=new i.A(t.length);return e.appendBuffer(t.subarray(4)),{profile:e.readU(8),level:e.readU(8),bitDepth:e.readU(4),chromaSubsampling:e.readU(3),fullRangeFlag:e.readU1(),colorPrimaries:e.readU(8),colorTrc:e.readU(8),colorSpace:e.readU(8)}}},5947:(t,e,a)=>{a.d(e,{A:()=>s});var i=a(1026);class s{constructor(){(0,i.A)(this,"type",-1),(0,i.A)(this,"onStreamAdd",void 0)}destroy(t){}}},5844:(t,e,a)=>{a.r(e),a.d(e,{default:()=>it});var i=a(1026),s=a(3939),r=a(932),n=a(4624),o=a(9705),d=a(5977),c=a(1071),l="src/avformat/formats/mov/parsing/stts.ts",f=a(662),p=a.n(f),h="src/avformat/formats/mov/parsing/stz2.ts",u=a(4677),m=a(6660),w=a(7837),g=a(4686),U=a(620);async function z(t,e,a,i){const s=t.getPos();e.codecpar.codecId=27;const r=(0,w.sY)(a.size),o=await t.readBuffer(a.size,(0,g.JW)(r,a.size));i.foundMoov?(e.sideData[1]=o.slice(),(0,w.Eb)(r)):(e.codecpar.extradata=r,e.codecpar.extradataSize=a.size,e.sideData[1]=o.slice()),U.XC(e,e.sideData[1]);const d=a.size-Number(t.getPos()-s);d>0?await t.skip(d):d<0&&n.z3(`read avcc error, size: ${a.size}, read: ${a.size-d}`,"src/avformat/formats/mov/parsing/avcc.ts",63)}var b=a(3e3);async function v(t,e,a,i){const s=t.getPos();e.codecpar.codecId=173;const r=(0,w.sY)(a.size),o=await t.readBuffer(a.size,(0,g.JW)(r,a.size));i.foundMoov?(e.sideData[1]=o.slice(),(0,w.Eb)(r)):(e.codecpar.extradata=r,e.codecpar.extradataSize=a.size,e.sideData[1]=o.slice()),b.XC(e,e.sideData[1]);const d=a.size-Number(t.getPos()-s);d>0?await t.skip(d):d<0&&n.z3(`read hevc error, size: ${a.size}, read: ${a.size-d}`,"src/avformat/formats/mov/parsing/hvcc.ts",63)}var k=a(8919);async function I(t,e,a,i){const s=t.getPos();e.codecpar.codecId=167;const r=(0,w.sY)(a.size),o=await t.readBuffer(a.size,(0,g.JW)(r,a.size));i.foundMoov?(e.sideData[1]=o.slice(),(0,w.Eb)(r)):(e.codecpar.extradata=r,e.codecpar.extradataSize=a.size,e.sideData[1]=o.slice()),k.X(e,e.sideData[1]);const d=a.size-Number(t.getPos()-s);d>0?await t.skip(d):d<0&&n.z3(`read vpcc error, size: ${a.size}, read: ${a.size-d}`,"src/avformat/formats/mov/parsing/vpcc.ts",63)}var x=a(412);async function P(t,e,a,i){const s=t.getPos();e.codecpar.codecId=226;const r=(0,w.sY)(a.size),o=await t.readBuffer(a.size,(0,g.JW)(r,a.size));i.foundMoov?(e.sideData[1]=o.slice(),(0,w.Eb)(r)):(e.codecpar.extradata=r,e.codecpar.extradataSize=a.size,e.sideData[1]=o.slice()),x.XC(e,e.sideData[1]);const d=a.size-Number(t.getPos()-s);d>0?await t.skip(d):d<0&&n.z3(`read avcc error, size: ${a.size}, read: ${a.size-d}`,"src/avformat/formats/mov/parsing/av1c.ts",63)}var y=a(8469),A=a(5451),B="src/avformat/formats/mov/parsing/esds.ts";async function S(t){let e=0;for(let a=0;a<4;a++){const a=await t.readUint8();if(e=e<<7|127&a,!(128&a))break}return e}async function M(t,e,a,i){const s=t.getPos();await t.skip(4);let r=t.getPos()+BigInt(Math.floor(a.size-4));for(;t.getPos()<r;){let a=await t.readUint8(),s=await S(t);if(0!==s)if(3===a){let r=t.getPos()+BigInt(Math.floor(s));if(await t.skip(2),await t.skip(1),a=await t.readUint8(),s=await S(t),0===s){n.R8("esds invalid ES descriptor size 0, skip",B,85),await t.skip(Number(r-t.getPos()));continue}if(4===a)if(e.codecpar.codecId=m.Q9[await t.readUint8()],await t.skip(1),await t.skip(3),await t.skip(4),await t.skip(4),t.getPos()<r-BigInt(5))if(a=await t.readUint8(),s=await S(t),5===a){const a=(0,w.sY)(s),r=await t.readBuffer(s,(0,g.JW)(a,s));i.foundMoov?(e.sideData[1]=r.slice(),(0,w.Eb)(a)):(e.codecpar.extradata=a,e.codecpar.extradataSize=s,86018===e.codecpar.codecId?y.XC(e,r.slice()):86076===e.codecpar.codecId&&A.XC(e,r.slice()))}else await t.skip(Number(r-t.getPos()));else await t.skip(Number(r-t.getPos()));else await t.skip(Math.min(s,Number(r-t.getPos())))}else await t.skip(Math.min(s,Number(r-t.getPos())));else n.R8("esds invalid descriptor size 0, skip",B,68),await t.skip(Number(r-t.getPos()))}const o=a.size-Number(t.getPos()-s);o>0?await t.skip(o):o<0&&n.z3(`read vpcc error, size: ${a.size}, read: ${a.size-o}`,B,153)}var D="src/avformat/formats/mov/parsing/wave.ts";async function N(t,e,a,i){const s=t.getPos(),r=s+BigInt(Math.floor(a.size));for(;t.getPos()<r;){const a=await t.readUint32(),s=await t.readUint32();0!==a?s===(0,d.A)("mp4a")?await M(t,e,{type:s,size:a-8},i):await t.skip(Math.min(a-8,Number(r-t.getPos()))):(n.R8("wave invalid box size 0, skip",D,47),await t.skip(Number(r-t.getPos())))}const o=a.size-Number(t.getPos()-s);o>0?await t.skip(o):o<0&&n.z3(`read vpcc error, size: ${a.size}, read: ${a.size-o}`,D,73)}var C="src/avformat/formats/mov/parsing/dfla.ts";async function R(t,e,a,i){const s=t.getPos();e.codecpar.codecId=86028,await t.skip(1),await t.skip(3);const r=await t.readUint8(),o=128&r,d=127&r,c=await t.readUint24();if(0===d&&34===c){const a=(0,w.sY)(c),s=await t.readBuffer(c,(0,g.JW)(a,c));i.foundMoov?(e.sideData[1]=s.slice(),(0,w.Eb)(a)):(e.codecpar.extradata=a,e.codecpar.extradataSize=c)}else n.z3("streaminfo must be first FLACMetadataBlock",C,67);o||n.R8("non streaminfo FLACMetadataBlock(s) ignored",C,71);const l=a.size-Number(t.getPos()-s);l>0?await t.skip(l):l<0&&n.z3(`read vpcc error, size: ${a.size}, read: ${a.size-l}`,C,79)}var $=a(1865),F=a(729);async function E(t,e,a,i){const s=t.getPos();e.codecpar.codecId=86076,await t.skip(1);const r=(0,w.sY)(a.size+8),o=(0,g.JW)(r,a.size+8),d=new $.A(o),c=new F.A(o,!1);c.writeString("OpusHead"),c.writeUint8(1),await t.readBuffer(a.size-1,(0,g.JW)(r+9,a.size-1)),d.seek(10),c.seek(10),c.writeUint16(d.readUint16()),c.writeUint32(d.readUint32()),c.writeUint16(d.readUint16()),i.foundMoov?(e.sideData[1]=o.slice(),(0,w.Eb)(r)):(e.codecpar.extradata=r,e.codecpar.extradataSize=o.length,A.XC(e,o.slice()));const l=a.size-Number(t.getPos()-s);l>0?await t.skip(l):l<0&&n.z3(`read dops error, size: ${a.size}, read: ${a.size-l}`,"src/avformat/formats/mov/parsing/dops.ts",81)}var L="src/avformat/formats/mov/parsing/colr.ts";async function T(t,e,a,i){const s=t.getPos();let r=await t.readString(4);if("nclx"===r||"nclc"===r||"prof"===r)if("prof"===r){const i=await t.readBuffer(a.size-4);e.sideData[28]=i}else{let a=await t.readUint16(),i=await t.readUint16(),s=await t.readUint16();if("nclx"===r){const a=await t.readUint8()>>7;e.codecpar.colorRange=a?2:1}a>=23&&(a=2),i>=19&&(i=2),s>=15&&(s=2),e.codecpar.colorPrimaries=a,e.codecpar.colorTrc=i,e.codecpar.colorSpace=s}else n.R8(`unsupported color_parameter_type: ${r}`,L,79);const o=a.size-Number(t.getPos()-s);o>0?await t.skip(o):o<0&&n.z3(`read vpcc error, size: ${a.size}, read: ${a.size-o}`,L,87)}var _="src/avformat/formats/mov/parsing/stsd.ts";const O={[(0,d.A)("stts")]:async function(t,e,a,i){const s=t.getPos(),r=await t.readUint8();await t.skip(3);const o=e.privData,d=[],c=[],f=await t.readUint32();let p=1;if(0===r)for(let e=0;e<f;e++)d.push(await t.readUint32()),p=await t.readInt32(),p<0&&n.R8("File uses negative stts sample delta, using value 1 instead, sync may be lost!",l,53),c.push(p);o.sttsSampleCounts=d,o.sttsSampleDeltas=c;const h=a.size-Number(t.getPos()-s);h>0?await t.skip(h):h<0&&n.z3(`read stts error, size: ${a.size}, read: ${a.size-h}`,l,67)},[(0,d.A)("ctts")]:async function(t,e,a,i){const s=t.getPos(),r=e.privData;await t.skip(4);const o=[],d=[],c=await t.readUint32();for(let e=0;e<c;e++)o.push(await t.readUint32()),d.push(await t.readInt32());r.cttsSampleCounts=o,r.cttsSampleOffsets=d;const l=a.size-Number(t.getPos()-s);l>0?await t.skip(l):l<0&&n.z3(`read ctts error, size: ${a.size}, read: ${a.size-l}`,"src/avformat/formats/mov/parsing/ctts.ts",59)},[(0,d.A)("stss")]:async function(t,e,a,i){const s=t.getPos(),r=await t.readUint8();await t.skip(3);const o=new(p()),d=await t.readUint32();if(0===r)for(let e=0;e<d;e++)o.set(await t.readUint32(),!0);e.privData.stssSampleNumbersMap=o;const c=a.size-Number(t.getPos()-s);c>0?await t.skip(c):c<0&&n.z3(`read stss error, size: ${a.size}, read: ${a.size-c}`,"src/avformat/formats/mov/parsing/stss.ts",57)},[(0,d.A)("stsz")]:async function(t,e,a,i){const s=t.getPos(),r=await t.readUint8();t.skip(3);const o=[];let d=0,c=0;if(0===r){d=await t.readUint32(),c=await t.readUint32();for(let e=0;e<c;e++)0===d?o.push(await t.readUint32()):o[e]=d}e.privData.sampleSizes=o;const l=a.size-Number(t.getPos()-s);l>0?await t.skip(l):l<0&&n.z3(`read stsz error, size: ${a.size}, read: ${a.size-l}`,"src/avformat/formats/mov/parsing/stsz.ts",65)},[(0,d.A)("stz2")]:async function(t,e,a,i){const s=t.getPos(),r=await t.readUint8();await t.skip(3);const o=[];let d=0,c=0;if(0===r)if(await t.skip(3),c=await t.readUint8(),d=await t.readUint32(),4===c)for(let e=0;e<d;e+=2){const a=await t.readUint8();o[e]=a>>4&15,o[e+1]=15&a}else if(8===c)for(let e=0;e<d;e++)o[e]=await t.readUint8();else if(16===c)for(let e=0;e<d;e++)o[e]=await t.readUint16();else n.z3("Error in length field in stz2 box",h,67);e.privData.sampleSizes=o;const l=a.size-Number(t.getPos()-s);l>0?await t.skip(l):l<0&&n.z3(`read stz2 error, size: ${a.size}, read: ${a.size-l}`,h,78)},[(0,d.A)("stsc")]:async function(t,e,a,i){const s=t.getPos(),r=await t.readUint8();await t.skip(3);const o=e.privData,d=[],c=[],l=[],f=await t.readUint32();if(0===r)for(let e=0;e<f;e++)d.push(await t.readUint32()),c.push(await t.readUint32()),l.push(await t.readUint32());o.stscFirstChunk=d,o.stscSamplesPerChunk=c,o.stscSampleDescriptionIndex=l;const p=a.size-Number(t.getPos()-s);p>0?await t.skip(p):p<0&&n.z3(`read stsc error, size: ${a.size}, read: ${a.size-p}`,"src/avformat/formats/mov/parsing/stsc.ts",65)},[(0,d.A)("stco")]:async function(t,e,a,i){const s=t.getPos(),r=await t.readUint8();await t.skip(3);const o=[],d=await t.readUint32();if(0===r)for(let e=0;e<d;e++)o.push(BigInt(Math.floor(await t.readUint32())));e.privData.chunkOffsets=o;const c=a.size-Number(t.getPos()-s);c>0?await t.skip(c):c<0&&n.z3(`read stco error, size: ${a.size}, read: ${a.size-c}`,"src/avformat/formats/mov/parsing/stco.ts",56)},[(0,d.A)("co64")]:async function(t,e,a,i){const s=t.getPos(),r=await t.readUint8();t.skip(3);const o=[],d=await t.readUint32();if(0===r)for(let e=0;e<d;e++)o.push(await t.readUint64());e.privData.chunkOffsets=o;const c=a.size-Number(t.getPos()-s);c>0?await t.skip(c):c<0&&n.z3(`read co64 error, size: ${a.size}, read: ${a.size-c}`,"src/avformat/formats/mov/parsing/co64.ts",56)},[(0,d.A)("mdhd")]:async function(t,e,a,i){const s=t.getPos(),r=await t.readUint8();await t.skip(3);let o=BigInt(0),d=BigInt(0),c=0,l=BigInt(0);1===r?(o=await t.readUint64(),d=await t.readUint64(),c=await t.readUint32(),l=await t.readUint64()):(o=BigInt(Math.floor(await t.readUint32())),d=BigInt(Math.floor(await t.readUint32())),c=await t.readUint32(),l=BigInt(Math.floor(await t.readUint32()))),e.duration=l,e.timeBase.den=c,e.timeBase.num=1,e.metadata.creationTime=o,e.metadata.modificationTime=d;const f=await t.readUint16(),p=[];p[0]=f>>10&31,p[1]=f>>5&31,p[2]=31&f;const h=String.fromCharCode(p[0]+96,p[1]+96,p[2]+96);e.metadata.language=f,e.metadata.languageString=h,await t.skip(2);const u=a.size-Number(t.getPos()-s);u>0?await t.skip(u):u<0&&n.z3(`read mdhd error, size: ${a.size}, read: ${a.size-u}`,"src/avformat/formats/mov/parsing/mdhd.ts",83)},[(0,d.A)("mvhd")]:async function(t,e,a,i){const s=t.getPos(),r=await t.readUint8();await t.skip(3),1===r?(i.creationTime=await t.readUint64(),i.modificationTime=await t.readUint64(),i.timescale=await t.readUint32(),i.duration=await t.readUint64()):(i.creationTime=BigInt(Math.floor(await t.readUint32())),i.modificationTime=BigInt(Math.floor(await t.readUint32())),i.timescale=await t.readUint32(),i.duration=BigInt(Math.floor(await t.readUint32()))),i.rate=await t.readUint32(),i.volume=await t.readUint16()>>>8,t.skip(10),i.matrix=new Uint32Array(9);for(let e=0;e<9;e++)i.matrix[e]=await t.readUint32();t.skip(24),i.nextTrackId=await t.readUint32();const o=a.size-Number(t.getPos()-s);o>0?await t.skip(o):o<0&&n.z3(`read mvhd error, size: ${a.size}, read: ${a.size-o}`,"src/avformat/formats/mov/parsing/mvhd.ts",70)},[(0,d.A)("tkhd")]:async function(t,e,a,i){const s=e.privData,r=t.getPos(),o=await t.readUint8();s.flags=await t.readUint24(),1===o?(e.metadata.creationTime=await t.readUint64(),e.metadata.modificationTime=await t.readUint64(),s.trackId=await t.readUint32(),t.skip(4),s.duration=await t.readUint64()):(e.metadata.creationTime=BigInt(Math.floor(await t.readUint32())),e.metadata.modificationTime=BigInt(Math.floor(await t.readUint32())),s.trackId=await t.readUint32(),t.skip(4),s.duration=BigInt(Math.floor(await t.readUint32()))),t.skip(8),s.layer=await t.readInt16(),s.alternateGroup=await t.readInt16(),s.volume=await t.readInt16()>>8,t.skip(2),s.matrix=new Uint32Array(9);for(let e=0;e<9;e++)s.matrix[e]=await t.readUint32();s.width=await t.readUint32()>>16,s.height=await t.readUint32()>>16;const d=a.size-Number(t.getPos()-r);d>0?await t.skip(d):d<0&&n.z3(`read tkhd error, size: ${a.size}, read: ${a.size-d}`,"src/avformat/formats/mov/parsing/tkhd.ts",77)},[(0,d.A)("hdlr")]:async function(t,e,a,i){const s=t.getPos(),r=await t.readUint8();if(await t.skip(3),0===r){await t.skip(4);const s=await t.readString(4),r=m.f3[s];(0,u.A)(r)&&(e.codecpar.codecType=r),await t.skip(4),await t.skip(4),await t.skip(4);const n=a.size-24;if(n>0){const a=!i.isom&&await t.peekUint8()===n-1;a&&await t.skip(1),e.metadata.handlerName=await t.readString(n-(a?1:0))}}const o=a.size-Number(t.getPos()-s);o>0?await t.skip(o):o<0&&n.z3(`read hdlr error, size: ${a.size}, read: ${a.size-o}`,"src/avformat/formats/mov/parsing/hdlr.ts",77)},[(0,d.A)("stsd")]:async function(t,e,a,i){const s=t.getPos(),r=await t.readUint8();await t.skip(3);const o=e.privData,c=await t.readUint32();for(let a=0;a<c;a++){const a=await t.readUint32(),s=await t.readUint32(),c=t.getPos()+BigInt(Math.floor(a-8));if(m.uf[s]&&(e.codecpar.codecId=m.uf[s]),0===a){n.R8("stsd entry invalid box size 0, skip",_,69),await t.skip(Number(c-t.getPos()));break}if(a>=16?(await t.skip(6),await t.skip(2)):a<=7&&n.h2(`invalid size: ${a} in stsd`,_,82),0===e.codecpar.codecType){await t.skip(2),await t.skip(2),e.metadata.vendorId=await t.readString(4),await t.skip(4),await t.skip(4),e.codecpar.width=await t.readUint16(),e.codecpar.height=await t.readUint16(),await t.skip(4),await t.skip(4),await t.skip(4),await t.skip(2);let a=await t.readUint8();for(a>31&&(a=31),e.metadata.encoder=await t.readString(a),a<31&&await t.skip(31-a),await t.skip(2),await t.skip(2);t.getPos()<c;){const a=await t.readUint32(),s=await t.readUint32();0!==a?s===(0,d.A)("avcC")?await z(t,e,{type:s,size:a-8},i):s===(0,d.A)("hvcC")?await v(t,e,{type:s,size:a-8},i):s===(0,d.A)("av1C")?await P(t,e,{type:s,size:a-8},i):s===(0,d.A)("vpcC")?await I(t,e,{type:s,size:a-8},i):s===(0,d.A)("esds")?await M(t,e,{type:s,size:a-8},i):s===(0,d.A)("wave")?await N(t,e,{type:s,size:a-8},i):s===(0,d.A)("colr")?await T(t,e,{type:s,size:a-8}):await t.skip(Math.min(a-8,Number(c-t.getPos()))):(n.R8("stsd video invalid box size 0, skip",_,131),await t.skip(Number(c-t.getPos())))}}else if(1===e.codecpar.codecType){const a=await t.readUint16();for(await t.skip(2),e.metadata.vendorId=await t.readString(4),e.codecpar.chLayout.nbChannels=await t.readUint16(),e.codecpar.channels=e.codecpar.chLayout.nbChannels,e.codecpar.bitsPerCodedSample=await t.readUint16(),o.audioCid=await t.readUint16(),await t.skip(2),e.codecpar.sampleRate=await t.readUint32()>>>16,(!i.isom||0===r&&a>0)&&(1===r?(o.samplesPerFrame=await t.readUint32(),await t.skip(4),o.bytesPerFrame=await t.readUint32(),await t.skip(4)):2===r&&(await t.skip(4),e.codecpar.sampleRate=Number(await t.readUint64()),e.codecpar.chLayout.nbChannels=await t.readUint32(),e.codecpar.channels=e.codecpar.chLayout.nbChannels,await t.skip(4),e.codecpar.bitsPerCodedSample=await t.readUint32(),await t.skip(4),o.bytesPerFrame=await t.readUint32(),o.samplesPerFrame=await t.readUint32()));t.getPos()<c;){const a=await t.readUint32(),s=await t.readUint32();0!==a?s===(0,d.A)("esds")?await M(t,e,{type:s,size:a-8},i):s===(0,d.A)("dfLa")?await R(t,e,{type:s,size:a-8},i):s===(0,d.A)("dOps")?await E(t,e,{type:s,size:a-8},i):await t.skip(Math.min(a-8,Number(c-t.getPos()))):(n.R8("stsd audio invalid box size 0, skip",_,273),await t.skip(Number(c-t.getPos())))}}else 3===e.codecpar.codecType?((s===(0,d.A)("stpp")||s===(0,d.A)("wvtt")||s===(0,d.A)("tx3g")||s===(0,d.A)("text")||s===(0,d.A)("c608"))&&e.codecpar.codecId,await t.skip(Math.min(a-8,Number(c-t.getPos())))):await t.skip(Math.min(a-8,Number(c-t.getPos())))}const l=a.size-Number(t.getPos()-s);l>0?await t.skip(l):l<0&&n.z3(`read stsd error, size: ${a.size}, read: ${a.size-l}`,_,341)},[(0,d.A)("trex")]:async function(t,e,a,i){const s=t.getPos();await t.readUint8(),await t.skip(3);const r=await t.readUint32();await t.skip(4);const o=await t.readUint32(),d=await t.readUint32(),c=await t.readUint32();i.trexs.push({trackId:r,duration:o,size:d,flags:c});const l=a.size-Number(t.getPos()-s);l>0?await t.skip(l):l<0&&n.z3(`read trex error, size: ${a.size}, read: ${a.size-l}`,"src/avformat/formats/mov/parsing/trex.ts",61)},[(0,d.A)("mfhd")]:async function(t,e,a,i){const s=t.getPos();await t.readUint8(),await t.skip(3),i.currentFragment.sequence=await t.readUint32();const r=a.size-Number(t.getPos()-s);r>0?await t.skip(r):r<0&&n.z3(`read vpcc error, size: ${a.size}, read: ${a.size-r}`,"src/avformat/formats/mov/parsing/mfhd.ts",49)},[(0,d.A)("tfhd")]:async function(t,e,a,i){const s=t.getPos(),r=(await t.readUint8(),await t.readUint24()),o=await t.readUint32(),d=i.currentFragment.currentTrack;d.trackId=o,d&&(1&r&&(d.baseDataOffset=await t.readUint64()),2&r&&await t.skip(4),8&r&&(d.defaultSampleDuration=await t.readUint32()),16&r&&(d.defaultSampleSize=await t.readUint32()),32&r&&(d.defaultSampleFlags=await t.readUint32()),131072&r&&(d.baseIsMoof=!0));const c=a.size-Number(t.getPos()-s);c>0?await t.skip(c):c<0&&n.z3(`read vpcc error, size: ${a.size}, read: ${a.size-c}`,"src/avformat/formats/mov/parsing/tfhd.ts",75)},[(0,d.A)("tfdt")]:async function(t,e,a,i){const s=t.getPos(),r=await t.readUint8();await t.skip(3);const o=i.currentFragment.currentTrack;o&&(o.baseMediaDecodeTime=1===r?await t.readUint64():BigInt(Math.floor(await t.readUint32())));const d=a.size-Number(t.getPos()-s);d>0?await t.skip(d):d<0&&n.z3(`read vpcc error, size: ${a.size}, read: ${a.size-d}`,"src/avformat/formats/mov/parsing/tfdt.ts",57)},[(0,d.A)("trun")]:async function(t,e,a,i){const s=t.getPos(),r=await t.readUint8(),o=await t.readUint24(),d=i.currentFragment.currentTrack;if(d){d.sampleCount=await t.readUint32(),1&o&&(d.dataOffset=await t.readInt32()),4&o&&(d.firstSampleFlags=await t.readUint32());for(let e=0;e<d.sampleCount;e++)256&o&&d.sampleDurations.push(await t.readUint32()),512&o&&d.sampleSizes.push(await t.readUint32()),1024&o&&d.sampleFlags.push(await t.readUint32()),2048&o&&(0===r?d.sampleCompositionTimeOffset.push(await t.readUint32()):d.sampleCompositionTimeOffset.push(await t.readInt32()))}const c=a.size-Number(t.getPos()-s);c>0?await t.skip(c):c<0&&n.z3(`read vpcc error, size: ${a.size}, read: ${a.size-c}`,"src/avformat/formats/mov/parsing/trun.ts",79)}};function W(t,e,a){const i=t.privData,s=a.trexs.find((t=>t.trackId===e.trackId));let r=e.baseDataOffset+BigInt(Math.floor(e.dataOffset));e.baseIsMoof&&(r+=a.currentFragment.pos);let n=e.baseMediaDecodeTime;const o=e.sampleSizes,d=e.sampleDurations,c=e.sampleFlags,l=e.sampleCompositionTimeOffset;if(!o.length)for(let t=0;t<e.sampleCount;t++)o.push(e.defaultSampleSize||s.size);if(!d.length)for(let t=0;t<e.sampleCount;t++)d.push(e.defaultSampleDuration||s.duration);if(!c.length)for(let t=0;t<e.sampleCount;t++)c.push(e.defaultSampleFlags||s.flags);if(!l.length)for(let t=0;t<e.sampleCount;t++)l.push(0);const f=[];for(let t=0;t<e.sampleCount;t++){const a={dts:n,pts:n+BigInt(Math.floor(l[t])),pos:r,size:o[t],duration:d[t],flags:0};n+=BigInt(Math.floor(a.duration)),r+=BigInt(Math.floor(a.size));let i=c[t];0===t&&e.firstSampleFlags&&(i=e.firstSampleFlags),16842752&i||(a.flags|=1),f.push(a)}i.samplesIndex=f}function Y(t){const e=t.privData,a=e.chunkOffsets,i=e.sampleSizes,s=e.cttsSampleCounts,r=e.cttsSampleOffsets,n=e.stscFirstChunk,o=e.stscSamplesPerChunk,d=e.stssSampleNumbersMap,c=e.sttsSampleCounts,l=e.sttsSampleDeltas;if(!a.length)return;let f=0,p=0,h=0,u=0,m=0,w=0,g=BigInt(0),U=0,z=BigInt(0);const b=[];for(let e=0;e<a.length;e++)for(g=a[e],f<n.length-1&&n[f+1]===e+1&&f++,w=o[f];w>0;){const e={dts:z,pts:z,pos:g,size:i[U],duration:0,flags:0};(d&&d.has(U+1)||1===t.codecpar.codecType)&&(e.flags|=1),r&&(e.pts=e.dts+BigInt(Math.floor(r[u])),m++,m===s[u]&&(u++,m=0)),U&&(b[U-1].duration=Number(e.dts-b[U-1].dts)),g+=BigInt(Math.floor(e.size)),z+=BigInt(Math.floor(l[p])),h++,h===c[p]&&(p++,h=0),U++,b.push(e),w--}b[U-1].duration=b[U-2].duration,e.samplesIndex=b}var X=a(3384),J=a(8106),V=a(7231),j="src/avformat/formats/mov/imov.ts";async function q(t,e,a,i){const s=t.getPos()+BigInt(Math.floor(a.size));for(;t.getPos()<s;){const a=await t.readUint32(),s=await t.readUint32();if(a<8)return void n.z3(`invalid box size ${a}`,j,76);O[s]?await O[s](t,e,{type:s,size:a-8},i):c.gQ.some((t=>(0,d.A)(t)===s))?await q(t,e,{type:s,size:a-8},i):await t.skip(a-8)}}async function K(t,e,a,i){const s=t.getPos()+BigInt(Math.floor(i.size));for(;t.getPos()<s;){const i=await t.readUint32(),s=await t.readUint32();if(i<8)return void n.z3(`invalid box, type: ${s}, size ${i}`,j,124);if(O[s])await O[s](t,null,{type:s,size:i-8},a);else if(s===(0,d.A)("trak"))if(!a.foundMoov||a.fragment){const r=e.createStream();if(r.privData=(0,J.A)(),await q(t,r,{type:s,size:i-8},a),a.fragment){const t=r.privData,a=e.streams.find((e=>{const a=e.privData;if(e.index!==r.index&&a.trackId===t.trackId)return!0}));a?(r.sideData[1]&&(a.sideData[1]=r.sideData[1],a.codecpar.extradata&&(0,w.Eb)(a.codecpar.extradata),a.codecpar.extradataSize=a.sideData[1].length,a.codecpar.extradata=(0,w.sY)(a.codecpar.extradataSize),(0,g.lW)(a.codecpar.extradata,a.codecpar.extradataSize,a.sideData[1]),r.codecpar.width===V.N_&&t.width>0&&(a.codecpar.width=t.width),r.codecpar.width===V.N_&&t.height>0&&(a.codecpar.height=t.height)),e.removeStream(r),e.streamIndex--):(r.codecpar.width===V.N_&&t.width>0&&(r.codecpar.width=t.width),r.codecpar.width===V.N_&&t.height>0&&(r.codecpar.height=t.height))}else Y(r)}else await t.skip(i-8);else s===(0,d.A)("mvex")?(a.fragment=!0,await q(t,null,{type:s,size:i-8},a)):await t.skip(i-8)}}async function Q(t,e,a,i){const s=t.getPos()+BigInt(Math.floor(i.size));for(;t.getPos()<s;){const i=await t.readUint32(),s=await t.readUint32();if(i<8)return void n.z3(`invalid box, type: ${s}, size ${i}`,j,229);if(O[s])await O[s](t,null,{type:s,size:i-8},a);else if(s===(0,d.A)("traf")){const r=(0,X.A)();a.currentFragment.currentTrack=r,await q(t,null,{type:s,size:i-8},a),a.currentFragment.tracks.push(r),a.currentFragment.currentTrack=null;const n=e.streams.find((t=>t.privData.trackId===r.trackId));if(n){const t=n.privData;r.streamIndex=n.index,W(n,r,a),t.currentSample=0,t.sampleEnd=!1}}else await t.skip(i-8)}}var G=a(5947),H=a(4328),Z=a(9690),tt=a(2739),et=a(1517),at="src/avformat/formats/IMovFormat.ts";class it extends G.A{constructor(t={}){super(),(0,i.A)(this,"type",1),(0,i.A)(this,"context",void 0),(0,i.A)(this,"options",void 0),this.options=t,this.context=(0,Z.A)()}init(t){t.ioReader&&t.ioReader.setEndian(!0)}async readHeader(t){try{let e=0,a=await t.ioReader.readUint32(),i=await t.ioReader.readUint32();if(i!==(0,d.A)("ftyp"))return n.z3("the file format is not mp4",at,82),o.LR;await async function(t,e,a){const i=t.getPos()+BigInt(Math.floor(a.size));for(e.majorBrand=await t.readUint32(),e.minorVersion=await t.readUint32(),e.majorBrand===(0,d.A)("qt  ")&&(e.isom=!0);t.getPos()<i;)e.compatibleBrand.push(await t.readUint32())}(t.ioReader,this.context,{type:i,size:a-8});let s=BigInt(0);for(;!this.context.foundMoov;){const e=t.ioReader.getPos();if(a=await t.ioReader.readUint32(),i=await t.ioReader.readUint32(),a<8)return n.z3(`invalid box size ${a}`,at,99),o.LR;i===(0,d.A)("mdat")?(this.context.foundMdat||(s=e),this.context.foundMdat=!0,await t.ioReader.seek(e+BigInt(Math.floor(a)))):i===(0,d.A)("moov")?(await K(t.ioReader,t,this.context,{size:a-8,type:i}),this.context.foundMoov=!0):await t.ioReader.seek(e+BigInt(Math.floor(a)))}if(!this.context.fragment&&!this.context.foundMdat){const e=await t.ioReader.peekUint64()>>BigInt(32);Number(e)===(0,d.A)("moof")&&(this.context.fragment=!0)}if(this.context.fragment&&1&t.ioReader.flags){const e=t.ioReader.getPos(),a=await t.ioReader.fileSize();if(a>BigInt(16)){await t.ioReader.seek(a-BigInt(12));let i=await t.ioReader.readUint32();if(i===(0,d.A)("mfro")){await t.ioReader.skip(4);const e=await t.ioReader.readUint32();await t.ioReader.seek(a-BigInt(Math.floor(e)));const s=await t.ioReader.readUint32();i=await t.ioReader.readUint32(),i===(0,d.A)("mfra")&&await async function(t,e,a,i){const s=t.getPos()+BigInt(Math.floor(i.size));for(;t.getPos()<s;){const i=await t.fileSize(),s=await t.readUint32();if(await t.readUint32()!==(0,d.A)("tfra"))return void n.z3("invalid tfra box data",j,293);const r=await t.readUint8();await t.skip(3);const o=await t.readUint32(),c=await t.readUint32(),l=await t.readUint32(),f=e.streams.find((t=>t.privData.trackId===o));if(f){const i=f.privData;let s,n;for(let e=0;e<l;e++){1===r?(s=await t.readUint64(),n=await t.readUint64()):(s=BigInt(Math.floor(await t.readUint32())),n=BigInt(Math.floor(await t.readUint32()))),i.fragIndexes.push({pos:n,time:s});for(let e=0;e<1+(c>>4&3);e++)await t.skip(1);for(let e=0;e<1+(c>>2&3);e++)await t.skip(1);for(let e=0;e<1+(3&c);e++)await t.skip(1)}if(i.fragIndexes.length){await t.seek(i.fragIndexes[i.fragIndexes.length-1].pos);const s=await t.readUint32(),r=await t.readUint32();if(r===(0,d.A)("moof")&&(a.currentFragment={pos:BigInt(0),size:s,sequence:0,tracks:[],currentTrack:null},await Q(t,e,a,{size:s,type:r}),i.samplesIndex.length)){const t=i.samplesIndex[i.samplesIndex.length-1];f.duration=t.pts+BigInt(Math.floor(t.duration))}}}await t.seek(i+BigInt(Math.floor(s)),!1,!1)}a.currentFragment=null}(t.ioReader,t,this.context,{size:s-8,type:i})}await t.ioReader.seek(e)}}return!this.context.fragment&&this.context.foundMdat&&await t.ioReader.seek(s),e}catch(e){return n.z3(e.message,at,161),this.context.foundMoov||n.z3("moov not found",at,164),t.ioReader.error}}async readAVPacket_(t,e){const{sample:a,stream:i}=function(t,e){let a,i,s,r,n,o,d=BigInt(0);if(t.streams.forEach((t=>{const e=t.privData;if(!e.samplesIndex||!e.samplesIndex.length)return e.sampleEnd=!0,!0;e.sampleEnd||s&&!(e.samplesIndex[e.currentSample].pos<s.pos)||(s=e.samplesIndex[e.currentSample],r=t),e.sampleEnd||n&&!((0,H.k)(e.samplesIndex[e.currentSample].dts,t.timeBase,V.KR)<d)||(n=e.samplesIndex[e.currentSample],d=(0,H.k)(n.dts,t.timeBase,V.KR),o=t)})),s&&n){const t=(0,H.k)(s.dts,r.timeBase,V.KR),e=(0,H.k)(n.dts,o.timeBase,V.KR);Math.abs(Number(t-e))<1e6?(a=s,i=r):(a=n,i=o)}else s?(a=s,i=r):n&&(a=n,i=o);if(i&&(i.privData.currentSample++,i.privData.currentSample>=i.privData.samplesIndex.length&&(i.privData.sampleEnd=!0)),e.fragment){const a=!!t.streams.find((t=>!1===t.privData.sampleEnd));a||(e.currentFragment=null)}return{sample:a,stream:i}}(t,this.context);if(!a)return-1048576;{r.M[15](e+32,i.index),r.M[17](e+16,a.dts),r.M[17](e+8,a.pts),r.M[17](e+48,BigInt(Math.floor(a.duration))),r.M[15](e+36,s.f[15](e+36)|a.flags),r.M[17](e+56,a.pos),r.M[15](e+76,i.timeBase.den),r.M[15](e+72,i.timeBase.num),i.startTime===V.Dh&&(i.startTime=s.f[17](e+8)||s.f[17](e+16)),await t.ioReader.seek(s.f[17](e+56));const n=a.size,o=(0,w.sY)(n);if((0,et.NX)(e,o,n),await t.ioReader.readBuffer(n,(0,g.JW)(o,n)),27!==i.codecpar.codecId&&173!==i.codecpar.codecId||r.M[15](e+80,1),i.sideData[1]){const t=i.sideData[1].length,a=(0,w.sY)(t);(0,et.Ow)(e,1,a,t),(0,g.lW)(a,t,i.sideData[1]),delete i.sideData[1]}}return 0}async readAVPacket(t,e){try{if(this.context.fragment&&!this.context.currentFragment)for(;!this.context.currentFragment;){const e=t.ioReader.getPos(),a=await t.ioReader.readUint32(),i=await t.ioReader.readUint32();i===(0,d.A)("moof")?(this.context.currentFragment={pos:e,size:a,sequence:0,tracks:[],currentTrack:null},await Q(t.ioReader,t,this.context,{type:i,size:a-8})):i===(0,d.A)("moov")?await K(t.ioReader,t,this.context,{size:a-8,type:i}):await t.ioReader.skip(a-8)}return await this.readAVPacket_(t,e)}catch(e){return-1048576!==t.ioReader.error&&n.z3(e.message,at,261),t.ioReader.error}}async seek(t,e,a,i){const s=a,r=e.privData;if(16&i&&this.context.fragment){const i=(0,H.k)(a,e.timeBase,V.i0);return await t.ioReader.seek(i,!0),this.context.currentFragment=null,BigInt(0)}if(this.context.fragment){if(r.fragIndexes.length){let e=tt.El(r.fragIndexes,(t=>t.time>s?-1:t.time===s?0:1));if(e>-1)return await t.ioReader.seek(r.fragIndexes[e].pos,!0),this.context.currentFragment=null,BigInt(0)}return BigInt(o.E$)}let n=tt.El(r.samplesIndex,(t=>t.dts>s?-1:t.dts===s?0:1));if(n>-1&&0===e.codecpar.codecType){let t=n;for(;t>=0;t--)if(1&r.samplesIndex[t].flags){n=t;break}t<0&&(n=-1)}return n>-1?(r.currentSample=n,r.sampleEnd=!1,tt.__(t.streams,(t=>{if(t!==e){const a=t.privData;let i=!1,s=(0,H.k)(r.samplesIndex[r.currentSample].pts,e.timeBase,t.timeBase);tt.__(a.samplesIndex,((t,e)=>{if(t.pts>=s)return a.currentSample=e,i=!0,!1})),i?a.sampleEnd=!1:(a.sampleEnd=!0,a.currentSample=a.samplesIndex.length)}})),BigInt(0)):BigInt(o.LR)}getAnalyzeStreamsCount(){return 0}}},1071:(t,e,a)=>{a.d(e,{_l:()=>i,gQ:()=>s});const i=["hmhd","nmhd","iods","xml ","url ","bxml","ipro","mere","stts","ctts","stss","stsz","stz2","stsc","stco","co64","stsd","dref","mvhd","tkhd","mdhd","hdlr"],s=["moov","trak","edts","mdia","minf","dinf","stbl","mvex","moof","traf","vttc","tref","iref","mfra","hnti","hinf","strd","sinf","rinf","schi","trgr","udta","iprp","ipco","strk","meco"]},3384:(t,e,a)=>{function i(){return{trackId:0,baseDataOffset:BigInt(0),defaultSampleDuration:0,defaultSampleSize:0,defaultSampleFlags:0,baseMediaDecodeTime:BigInt(0),sampleCount:0,dataOffset:0,dataOffsetPos:BigInt(0),firstSampleFlags:0,sampleDurations:[],sampleSizes:[],sampleFlags:[],sampleCompositionTimeOffset:[],baseIsMoof:!1,ioWriter:null,buffers:[]}}a.d(e,{A:()=>i})},9690:(t,e,a)=>{a.d(e,{A:()=>s});var i=a(7231);function s(){return{isom:!1,timescale:i.N_,duration:i.Dh,foundMoov:!1,foundMdat:!1,majorBrand:0,minorVersion:0,compatibleBrand:[],creationTime:BigInt(0),modificationTime:BigInt(0),rate:i.N_,volume:i.N_,matrix:null,nextTrackId:1,fragment:!1,trexs:[],currentFragment:null,boxsPositionInfo:[],holdMoovPos:BigInt(0),currentChunk:null}}},8106:(t,e,a)=>{a.d(e,{A:()=>s});var i=a(7231);function s(){return{chunkOffsets:null,cttsSampleCounts:null,cttsSampleOffsets:null,stscFirstChunk:null,stscSamplesPerChunk:null,stscSampleDescriptionIndex:null,stssSampleNumbersMap:null,stssSampleNumbers:null,sampleSizes:null,sttsSampleCounts:null,sttsSampleDeltas:null,timescale:0,duration:BigInt(0),trackId:i.N_,layer:0,alternateGroup:0,volume:0,matrix:null,width:0,height:0,audioCid:0,samplesPerFrame:0,bytesPerFrame:0,currentSample:0,sampleEnd:!1,samplesIndex:[],fragIndexes:[],lastPts:BigInt(0),lastDts:BigInt(0),startDts:BigInt(0),startCT:0,lastDuration:0,chunkCount:0,firstWrote:!1,lastStscCount:0,perStreamGrouping:!1,index:0,flags:0}}},6660:(t,e,a)=>{a.d(e,{Q9:()=>r,f3:()=>n,uf:()=>o,zs:()=>s});var i=a(5977);const s={86018:64,86017:105,86076:173,86028:193,86021:221,12:32,27:33,173:35,167:177,0:0},r={32:12,33:27,35:173,177:167,64:86018,102:86018,103:86018,104:86018,105:86017,107:86017,173:86076,193:86028,221:86021,0:0},n={vide:0,soun:1,clcp:3,sbtl:3,subt:3,subp:3,text:3},o={[(0,i.A)("mp4a")]:86018,1836253269:86017,[(0,i.A)("Opus")]:86076,[(0,i.A)("fLaC")]:86028,[(0,i.A)("spex")]:86051,[(0,i.A)("SPXN")]:86051,[(0,i.A)("ac-3")]:86019,[(0,i.A)("sac3")]:86019,[i.A.mp4v]:12,[(0,i.A)("av01")]:226,[(0,i.A)("vp08")]:139,[(0,i.A)("vp09")]:167,[(0,i.A)("avc1")]:27,[(0,i.A)("hev1")]:173,[(0,i.A)("hvc1")]:173,[(0,i.A)("text")]:94213,[(0,i.A)("tx3g")]:94213}},5977:(t,e,a)=>{a.d(e,{A:()=>r});var i=a(4624),s="src/avformat/function/mktag.ts";function r(t){4!==t.length&&i.R8(`tag length is not 4, tag: ${t}`,s,30);let e=0;for(let a=0;a<4;a++)e=e<<8|t.charCodeAt(a);return e}},null:()=>{},3991:(t,e,a)=>{function i(t){let e=0,a=0;for(;a<32&&0===t.readU1();)a++;return e=t.readU(a),e+=(1<<a)-1,e}function s(t){let e=i(t);return e=1&e?(e+1)/2:-e/2,e}a.d(e,{$x:()=>s,xb:()=>i})},264:(t,e,a)=>{function i(t){return t.length>4&&0===t[0]&&0===t[1]&&(1===t[2]||0===t[2]&&1===t[3])}function s(t,e){let a=0;for(let i=e;i<t.length;i++)switch(t[i]){case 0:a++;break;case 1:if(a>=2)return{offset:i-Math.min(a,3),startCode:Math.min(a+1,4)};a=0;break;default:a=0}return{offset:-1,startCode:0}}function r(t){const e=[];let a=s(t,0),i={offset:-1,startCode:0};for(;i=s(t,a.offset+a.startCode),i.offset>-1;)e.push(t.subarray(a.offset+a.startCode,i.offset,!0)),a=i;return e.push(t.subarray(a.offset+a.startCode,void 0,!0)),e}function n(t,e=0,a){a||(a=t.length);const i=new Uint8Array(t.length);let s=0,r=0;for(let n=0;n<t.length;n++){if(n>=e&&n<a)if(0===t[n])s++;else if(3===t[n]&&2===s&&n+1<t.length&&t[n+1]<=3){if(n++,n===t.length)break;s=0===t[n]?1:0}else s=0;i[r++]=t[n]}return i.slice(0,r)}a.d(e,{BN:()=>n,Bs:()=>i,py:()=>r})},7246:(t,e,a)=>{a.d(e,{A:()=>r});var i=a(1026),s=a(4624);class r{constructor(t=1048576){(0,i.A)(this,"buffer",void 0),(0,i.A)(this,"pointer",void 0),(0,i.A)(this,"bitsLeft",void 0),(0,i.A)(this,"size",void 0),(0,i.A)(this,"endPointer",void 0),(0,i.A)(this,"error",void 0),(0,i.A)(this,"onFlush",void 0),this.pointer=0,this.bitsLeft=8,this.size=t,this.endPointer=0,this.error=0,this.buffer=new Uint8Array(this.size)}peekU1(){let t=0;(this.remainingLength()<1||1===this.remainingLength()&&0===this.bitsLeft)&&this.flush();let e=this.pointer,a=this.bitsLeft;return 0===a&&(e++,a=8),t=this.buffer[e]>>a-1&1,t}readU1(){let t=0;return(this.remainingLength()<1||1===this.remainingLength()&&0===this.bitsLeft)&&this.flush(),this.bitsLeft--,t=this.buffer[this.pointer]>>this.bitsLeft&1,0===this.bitsLeft&&(this.pointer++,this.bitsLeft=8),t}readU(t){let e=0;for(let a=0;a<t;a++)e|=this.readU1()<<t-a-1;return e}remainingLength(){return this.endPointer-this.pointer}flush(){if(!this.onFlush)throw this.error=-1048575,Error("IOReader error, flush failed because of no flush callback");if(0===this.bitsLeft&&this.pointer++,!(this.size-this.remainingLength()<=0))if(this.pointer<this.endPointer){this.buffer.set(this.buffer.subarray(this.pointer,this.endPointer),0);const t=this.onFlush(this.buffer.subarray(this.endPointer-this.pointer,this.size));if(t<0)throw this.error=t,Error("IOReader error, flush failed");this.endPointer=this.endPointer-this.pointer+t,this.pointer=0}else{const t=this.onFlush(this.buffer);if(this.endPointer=t,this.pointer=0,this.bitsLeft=8,t<0)throw this.error=t,Error("IOReader error, flush failed")}}getBuffer(){return this.buffer}appendBuffer(t){if(this.size-this.endPointer>=t.length)this.buffer.set(t,this.endPointer),this.endPointer+=t.length;else if(this.buffer.set(this.buffer.subarray(this.pointer,this.endPointer),0),this.endPointer=this.endPointer-this.pointer,this.pointer=0,this.size-this.endPointer>=t.length)this.buffer.set(t,this.endPointer),this.endPointer+=t.length;else{const e=Math.min(this.size-this.endPointer,t.length);this.buffer.set(t.subarray(0,e),this.endPointer),this.endPointer+=e,s.R8("BSReader, call appendBuffer but the buffer's size is lagger then the remaining size","src/common/io/BitReader.ts",170)}}clear(){this.pointer=this.endPointer=0,this.bitsLeft=8,this.error=0}skipPadding(){this.bitsLeft<8&&(this.bitsLeft=8,this.pointer++)}}},729:(t,e,a)=>{a.d(e,{A:()=>n});var i=a(1026),s=a(4624),r=a(11);class n{constructor(t,e=!0){(0,i.A)(this,"data",void 0),(0,i.A)(this,"buffer",void 0),(0,i.A)(this,"byteStart",void 0),(0,i.A)(this,"pos",void 0),(0,i.A)(this,"size",void 0),(0,i.A)(this,"littleEndian",void 0),this.buffer=t,this.data=t instanceof Uint8Array?new DataView(t.buffer):t.view,this.byteStart=t instanceof Uint8Array?t.byteOffset:0,this.pos=0,this.size=t.byteLength,this.littleEndian=!e}writeUint8(t){this.data.setUint8(this.pos+++this.byteStart,t)}writeUint16(t){this.data.setUint16(this.pos+this.byteStart,t,this.littleEndian),this.pos+=2}writeUint24(t){const e=3840&t,a=240&t,i=15&t;this.littleEndian?(this.writeUint8(i),this.writeUint8(a),this.writeUint8(e)):(this.writeUint8(e),this.writeUint8(a),this.writeUint8(i))}writeUint32(t){this.data.setUint32(this.pos+this.byteStart,t,this.littleEndian),this.pos+=4}writeUint64(t){const e=t&BigInt(4294967295),a=(t&BigInt(4294967295)<<BigInt(32))>>BigInt(32);this.littleEndian?(this.writeUint32(Number(e)),this.writeUint32(Number(a))):(this.writeUint32(Number(a)),this.writeUint32(Number(e)))}writeInt8(t){this.data.setInt8(this.pos+++this.byteStart,t)}writeInt16(t){this.data.setInt16(this.pos+this.byteStart,t,this.littleEndian),this.pos+=2}writeInt32(t){this.data.setInt32(this.pos+this.byteStart,t,this.littleEndian),this.pos+=4}writeInt64(t){const e=t&BigInt(4294967295),a=(t&BigInt(4294967295)<<BigInt(32))>>BigInt(32);this.littleEndian?(this.writeInt32(Number(e)),this.writeInt32(Number(a))):(this.writeInt32(Number(a)),this.writeInt32(Number(e)))}writeFloat(t){this.data.setFloat32(this.pos+this.byteStart,t,this.littleEndian),this.pos+=4}writeDouble(t){this.data.setFloat64(this.pos+this.byteStart,t,this.littleEndian),this.pos+=8}getPos(){return this.pos}seek(t){t>this.size&&(t=this.size),this.pos=Math.max(0,t)}skip(t){this.seek(this.pos+t)}back(t){this.seek(this.pos-t)}remainingSize(){return this.size-this.pos}writeBuffer(t){let e=t.length;this.remainingSize()<e&&(e=this.remainingSize(),s.R8(`the remaining buffer size is smaller then the wrote buffer, hope set ${t.length}, but set ${e}`,"src/common/io/BufferWriter.ts",211)),this.buffer.set(t,this.pos),this.pos+=t.length}writeString(t){const e=r.l(t);return this.writeBuffer(e),e.length}getWroteBuffer(){return this.buffer.subarray(0,this.pos)}resetBuffer(t,e=!0){this.buffer=t,this.data=t instanceof Uint8Array?new DataView(t.buffer):t.view,this.byteStart=t instanceof Uint8Array?t.byteOffset:0,this.pos=0,this.size=t.byteLength,this.littleEndian=!e}}}}]);