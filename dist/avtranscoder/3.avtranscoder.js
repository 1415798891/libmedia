"use strict";(self.webpackChunkAVTranscoder=self.webpackChunkAVTranscoder||[]).push([[3],{64436:(t,e,i)=>{i.d(e,{A:()=>o});var r=i(134),n=i(63939),a=i(37837),s=i(71766);class o{constructor(){(0,r.A)(this,"inCodecpar",void 0),(0,r.A)(this,"inTimeBase",void 0),(0,r.A)(this,"outCodecpar",void 0)}init(t,e){return this.inCodecpar=(0,a.Gy)(168),(0,s.Yi)(this.inCodecpar,t),this.inTimeBase={den:n.f[15](e+4),num:n.f[15](e)},0}destroy(){this.inCodecpar&&((0,s.dn)(this.inCodecpar),this.inCodecpar=0)}}},26173:(t,e,i)=>{i.d(e,{A:()=>m});var r=i(134),n=i(63939),a=i(50932),s=i(64436),o=i(71517),c=i(20620),h=i(53e3),d=i(55611),l=i(14686),f=i(9705),u=i(60264),p=i(37837),U=i(4624);class m extends s.A{constructor(...t){super(...t),(0,r.A)(this,"cache",void 0),(0,r.A)(this,"cached",void 0)}init(t,e){return super.init(t,e),this.cache=(0,o._5)(),this.cached=!1,0}destroy(){super.destroy(),(0,o.Qe)(this.cache),this.cache=0}sendAVPacket(t){const e=(0,l.JW)(n.f[20](t+24),n.f[15](t+28));if(1!==n.f[15](t+80)&&(0,u.Bs)(e)){let i;if((0,o.zu)(this.cache,t),27===n.f[15](this.inCodecpar+4)||12===n.f[15](this.inCodecpar+4)?i=c.oT(e):173===n.f[15](this.inCodecpar+4)?i=h.oT(e):196===n.f[15](this.inCodecpar+4)?i=d.oT(e):U.h2(`not support for codecId: ${n.f[15](this.inCodecpar+4)}`,"src/avformat/bsf/h2645/Annexb2AvccFilter.ts",93),a.M[15](this.cache+80,1),(0,o.NX)(this.cache,i.bufferPointer,i.length),i.key&&a.M[15](this.cache+36,1|n.f[15](this.cache+36)),i.extradata){const t=(0,p.sY)(i.extradata.length);(0,l.lW)(t,i.extradata.length,i.extradata),(0,o.Ow)(this.cache,1,t,i.extradata.length)}}else(0,o.rN)(this.cache,t);return this.cached=!0,0}receiveAVPacket(t){return this.cached?((0,o.Up)(t),(0,o.rN)(t,this.cache),this.cached=!1,0):f.LR}}},20620:(t,e,i)=>{i.d(e,{Jk:()=>P,OD:()=>I,XC:()=>B,ci:()=>S,k9:()=>b,oT:()=>y,tZ:()=>w});var r=i(63939),n=i(50932),a=i(72739),s=i(729),o=i(31865),c=i(37246),h=i(4624),d=i(14686),l=i(71517),f=i(60264),u=i(37837),p=i(23991),U="src/avformat/codecs/h264.ts";const m=3,w={66:"Constrained Baseline",77:"Main",100:"High",110:"High10",122:"High422",244:"High444"},g=[{level:10,maxResolution:25344,maxFrameRate:15},{level:11,maxResolution:25344,maxFrameRate:30},{level:12,maxResolution:101376,maxFrameRate:30},{level:13,maxResolution:101376,maxFrameRate:30},{level:20,maxResolution:101376,maxFrameRate:30},{level:21,maxResolution:202752,maxFrameRate:30},{level:22,maxResolution:414720,maxFrameRate:30},{level:30,maxResolution:414720,maxFrameRate:30},{level:31,maxResolution:921600,maxFrameRate:30},{level:32,maxResolution:1310720,maxFrameRate:60},{level:40,maxResolution:2097152,maxFrameRate:30},{level:41,maxResolution:2097152,maxFrameRate:60},{level:42,maxResolution:2228224,maxFrameRate:60},{level:50,maxResolution:8912896,maxFrameRate:30},{level:51,maxResolution:8912896,maxFrameRate:60},{level:52,maxResolution:8912896,maxFrameRate:120},{level:60,maxResolution:35651584,maxFrameRate:30},{level:61,maxResolution:35651584,maxFrameRate:60},{level:62,maxResolution:35651584,maxFrameRate:120}];function b(t,e,i){const r=t*e;for(const t of g)if(r<=t.maxResolution&&i<=t.maxFrameRate)return t.level}function x(t){const e=new o.A(t);e.skip(5);const i=[],r=[],n=[],a=31&e.readUint8();for(let t=0;t<a;t++){const t=e.readUint16();i.push(e.readBuffer(t))}const s=e.readUint8();for(let t=0;t<s;t++){const t=e.readUint16();r.push(e.readBuffer(t))}if(e.remainingSize()>4){e.skip(3);const t=e.readUint8();if(t>0)for(let i=0;i<t;i++){const t=e.readUint16();n.push(e.readBuffer(t))}}return{spss:i,ppss:r,spsExts:n}}function v(t,e,i=[]){t.length>32&&(h.R8(`h264 metadata's sps max length is 32, but get ${t.length}`,U,199),t=t.slice(0,32)),t.length>256&&(h.R8(`h264 metadata's pps max length is 256, but get ${t.length}`,U,203),t=t.slice(0,256));let r=7;r=t.reduce(((t,e)=>t+2+e.length),r),r=e.reduce(((t,e)=>t+2+e.length),r);const n=t[0],o=A(n);66!==o.profile&&77!==o.profile&&88!==o.profile&&(r+=4,i.length&&(r=i.reduce(((t,e)=>t+2+e.length),r)));const c=new Uint8Array(r),d=new s.A(c);return d.writeUint8(1),d.writeUint8(n[1]),d.writeUint8(n[2]),d.writeUint8(n[3]),d.writeUint8(252|m),d.writeUint8(224|31&t.length),a.__(t,(t=>{d.writeUint16(t.length),d.writeBuffer(t)})),d.writeUint8(e.length),a.__(e,(t=>{d.writeUint16(t.length),d.writeBuffer(t)})),66!==o.profile&&77!==o.profile&&88!==o.profile&&(d.writeUint8(252|o.chromaFormatIdc),d.writeUint8(248|o.bitDepthLumaMinus8),d.writeUint8(248|o.bitDepthChromaMinus8),i.length&&a.__(i,(t=>{d.writeUint16(t.length),d.writeBuffer(t)}))),c}function y(t){let e,i=(0,f.py)(t),r=!1;if(i.length>1){const t=[],r=[],n=[];i.forEach((e=>{const i=31&e[0];7===i?t.push(e):8===i?r.push(e):13===i&&n.push(e)})),t.length&&r.length&&(e=v(t,r,n)),i=i.filter((t=>{const e=31&t[0];return 9!==e&&8!==e&&7!==e&&13!==e}))}const n=i.reduce(((t,e)=>t+m+1+e.length),0),o=(0,u.sY)(n),c=(0,d.s3)(o,n),h=new s.A(c);return a.__(i,(t=>{3===m?h.writeUint32(t.length):2===m?h.writeUint24(t.length):1===m?h.writeUint16(t.length):h.writeUint8(t.length),h.writeBuffer(t.subarray(0)),5==(31&t[0])&&(r=!0)})),{bufferPointer:o,length:n,key:r,extradata:e}}function I(t,e){const i=e?3&e[4]:m;let r=[],n=[],c=[],h=!1;if(e){const t=x(e);r=t.spss,n=t.ppss,c=t.spsExts,h=!0}const l=[],f=[],p=new o.A(t);for(;p.remainingSize()>0;){let e=0;e=3===i?p.readUint32():2===i?p.readUint24():1===i?p.readUint16():p.readUint8();const r=t.subarray(0|Number(0xffffffffn&p.getPos()),(0|Number(0xffffffffn&p.getPos()))+e);p.skip(e);const n=31&r[0];6===n?f.push(r):9!==n&&l.push(r)}let U=r.reduce(((t,e)=>t+4+e.length),0);U=n.reduce(((t,e)=>t+4+e.length),U),U=c.reduce(((t,e)=>t+4+e.length),U),U=f.reduce(((t,e)=>t+4+e.length),U),U=l.reduce(((t,e,i)=>t+(i?3:4)+e.length),U);const w=(0,u.sY)(U+6),g=new s.A((0,d.s3)(w,U+6));return g.writeUint8(0),g.writeUint8(0),g.writeUint8(0),g.writeUint8(1),g.writeUint8(9),g.writeUint8(240),a.__(f,(t=>{g.writeUint8(0),g.writeUint8(0),g.writeUint8(0),g.writeUint8(1),g.writeBuffer(t)})),a.__(r,(t=>{g.writeUint8(0),g.writeUint8(0),g.writeUint8(0),g.writeUint8(1),g.writeBuffer(t)})),a.__(n,(t=>{g.writeUint8(0),g.writeUint8(0),g.writeUint8(0),g.writeUint8(1),g.writeBuffer(t)})),a.__(c,(t=>{g.writeUint8(0),g.writeUint8(0),g.writeUint8(0),g.writeUint8(1),g.writeBuffer(t)})),a.__(l,((t,e)=>{g.writeUint8(0),g.writeUint8(0),e||g.writeUint8(0),g.writeUint8(1),g.writeBuffer(t),5==(31&t[0])&&(h=!0)})),{bufferPointer:w,length:U+6,key:h}}function P(t,e){var i;if(!(1&r.f[15](t+36)))return;const n=(0,l.iI)(t);if((0,f.Bs)(n))return;const a=null!==(i=e.metadata.naluLengthSizeMinusOne)&&void 0!==i?i:m;let s=[],c=[],h=[],p=[];const U=new o.A(n);for(;U.remainingSize()>0;){let t=0;t=3===a?U.readUint32():2===a?U.readUint24():1===a?U.readUint16():U.readUint8();const e=n.subarray(0|Number(0xffffffffn&U.getPos()),(0|Number(0xffffffffn&U.getPos()))+t);U.skip(t);const i=31&e[0];7===i?s.push(e):8===i?c.push(e):13===i?h.push(e):p.push(e)}if(s.length||c.length){const e=v(s,c,h),i=(0,u.sY)(e.length);(0,d.lW)(i,e.length,e),(0,l.Ow)(t,1,i,e.length)}}function S(t,e=!1){if(!(1&r.f[15](t+36)||e))return;const i=(0,l.iI)(t);if(!(0,f.Bs)(i))return;let a=(0,f.py)(i);if(a.length>1){const e=[],i=[],s=[];if(a.forEach((t=>{const r=31&t[0];7===r?e.push(t):8===r?i.push(t):13===r&&s.push(t)})),e.length&&i.length){const a=v(e,i,s),o=(0,u.sY)(a.length);(0,d.lW)(o,a.length,a),(0,l.Ow)(t,1,o,a.length),n.M[15](t+36,1|r.f[15](t+36))}}}function B(t,e){if(!e&&t.sideData[1]&&(e=t.sideData[1]),e&&e.length>=6){t.metadata.naluLengthSizeMinusOne=3&e[4];const{spss:i}=x(e);if(i.length){const{profile:e,level:r,width:n,height:a}=A(i[0]);t.codecpar.profile=e,t.codecpar.level=r,t.codecpar.width=n,t.codecpar.height=a}}}function A(t){if(!t||t.length<3)return;let e=0;0===t[0]&&0===t[1]&&0===t[2]&&1===t[3]&&(e=4);const i=(0,f.BN)(t.subarray(e)),r=new c.A(i.length);r.appendBuffer(i),r.readU1(),r.readU(2),r.readU(5);const n=r.readU(8);r.readU1(),r.readU1(),r.readU1(),r.readU1(),r.readU1(),r.readU1(),r.readU(2);const a=r.readU(8);p.xb(r);let s=1,o=0,h=0;if((100==n||110==n||122==n||244==n||44==n||83==n||86==n||118==n||128==n||138==n||139==n||134==n||135==n)&&(s=p.xb(r),3===s&&r.readU1(),o=p.xb(r),h=p.xb(r),r.readU1(),r.readU1())){const t=new Array(8);for(let e=0;e<(3!=s?8:12);e++)t[e]=r.readU1()}p.xb(r);const d=p.xb(r);if(0===d)p.xb(r);else if(1===d){r.readU1(),p.$x(r),p.$x(r);const t=p.xb(r);for(let e=0;e<t;e++)p.$x(r)}p.xb(r),r.readU1();const l=p.xb(r),u=p.xb(r),U=r.readU1();let m=16*(l+1),w=(2-U)*(u+1)*16;U||r.readU1(),r.readU1();const g=r.readU1();if(g){let t=1,e=2-g;1===s?(t=2,e=2*(2-g)):2===g&&(t=2,e=2-g),m-=t*(p.xb(r)+p.xb(r)),w-=e*(p.xb(r)+p.xb(r))}return{profile:n,level:a,width:m,height:w,chromaFormatIdc:s,bitDepthLumaMinus8:o,bitDepthChromaMinus8:h}}},53e3:(t,e,i)=>{i.d(e,{Jk:()=>y,OD:()=>v,XC:()=>P,ci:()=>I,dT:()=>p,k9:()=>m,oT:()=>x});var r=i(63939),n=i(50932),a=i(72739),s=i(729),o=i(31865),c=i(37246),h=i(14686),d=i(60264),l=i(71517),f=i(37837),u=i(23991);const p={1:"Main",2:"Main10",3:"MainStillPicture",4:"Main444"},U=[{level:10,maxLumaSamplesPerSecond:552960,maxLumaPictureSize:36864,maxBitRate:{main:128,main10:150}},{level:20,maxLumaSamplesPerSecond:3686400,maxLumaPictureSize:122880,maxBitRate:{main:1500,main10:1875}},{level:21,maxLumaSamplesPerSecond:7372800,maxLumaPictureSize:245760,maxBitRate:{main:3e3,main10:3750}},{level:30,maxLumaSamplesPerSecond:16588800,maxLumaPictureSize:552960,maxBitRate:{main:6e3,main10:7500}},{level:31,maxLumaSamplesPerSecond:33177600,maxLumaPictureSize:983040,maxBitRate:{main:1e4,main10:12500}},{level:40,maxLumaSamplesPerSecond:66846720,maxLumaPictureSize:2228224,maxBitRate:{main:12e3,main10:15e3}},{level:41,maxLumaSamplesPerSecond:133693440,maxLumaPictureSize:2228224,maxBitRate:{main:2e4,main10:25e3}},{level:50,maxLumaSamplesPerSecond:267386880,maxLumaPictureSize:8912896,maxBitRate:{main:25e3,main10:4e4}},{level:51,maxLumaSamplesPerSecond:534773760,maxLumaPictureSize:8912896,maxBitRate:{main:4e4,main10:6e4}},{level:52,maxLumaSamplesPerSecond:1069547520,maxLumaPictureSize:35651584,maxBitRate:{main:6e4,main10:1e5}},{level:60,maxLumaSamplesPerSecond:1069547520,maxLumaPictureSize:35651584,maxBitRate:{main:6e4,main10:1e5}},{level:61,maxLumaSamplesPerSecond:2139095040,maxLumaPictureSize:89128960,maxBitRate:{main:12e4,main10:24e4}},{level:62,maxLumaSamplesPerSecond:4278190080,maxLumaPictureSize:356515840,maxBitRate:{main:24e4,main10:48e4}}];function m(t,e,i,r,n){const a=1===t?"main":"main10",s=e*i*r;for(const t of U)if(s<=t.maxLumaSamplesPerSecond&&e*i<=t.maxLumaPictureSize&&n<=t.maxBitRate[a])return t.level}const w=3;function g(t){const e=new o.A(t,!0);e.skip(22);let i=[],r=[],n=[];const a=e.readUint8();for(let t=0;t<a;t++){const t=63&e.readUint8(),a=e.readUint16(),s=[];for(let t=0;t<a;t++){const t=e.readUint16();s.push(e.readBuffer(t))}32===t?i=s:33===t?r=s:34===t&&(n=s)}return{vpss:i,spss:r,ppss:n}}function b(t,e,i){const r=e[0];let n=23;t.length&&(n+=3,n=t.reduce(((t,e)=>t+2+e.length),n)),e.length&&(n+=3,n=e.reduce(((t,e)=>t+2+e.length),n)),i.length&&(n+=3,n=i.reduce(((t,e)=>t+2+e.length),n));const o=new Uint8Array(n),c=new s.A(o,!0),h=S(r);c.writeUint8(1),c.writeUint8(r[1]),c.writeUint8(r[2]),c.writeUint8(r[3]),c.writeUint8(r[4]),c.writeUint8(r[5]),c.writeUint8(r[6]),c.writeUint8(r[7]),c.writeUint8(r[8]),c.writeUint8(r[9]),c.writeUint8(r[10]),c.writeUint8(r[11]),c.writeUint8(h.level),c.writeUint8(1020),c.writeUint8(0),c.writeUint8(16320),c.writeUint8(16320|h.chromaFormatIdc),c.writeUint8(8160|h.bitDepthLumaMinus8),c.writeUint8(8160|h.bitDepthChromaMinus8),c.writeUint16(0),c.writeUint8(8|(1&r[0])<<2|w);let d=0;return t.length&&d++,e.length&&d++,i.length&&d++,c.writeUint8(d),t.length&&(c.writeUint8(160),c.writeUint16(t.length),a.__(t,(t=>{c.writeUint16(t.length),c.writeBuffer(t)}))),e.length&&(c.writeUint8(161),c.writeUint16(e.length),a.__(e,(t=>{c.writeUint16(t.length),c.writeBuffer(t)}))),i.length&&(c.writeUint8(162),c.writeUint16(i.length),a.__(i,(t=>{c.writeUint16(t.length),c.writeBuffer(t)}))),o}function x(t){let e,i=!1,r=(0,d.py)(t);if(r.length>2){const t=[],i=[],n=[];r.forEach((e=>{const r=e[0]>>>1&63;32===r?t.push(e):33===r?i.push(e):34===r&&n.push(e)})),t.length&&i.length&&n.length&&(e=b(t,i,n),r=r.filter((t=>{const e=t[0]>>>1&63;return 32!==e&&33!==e&&34!==e&&35!==e})))}const n=r.reduce(((t,e)=>t+w+1+e.length),0),o=(0,f.sY)(n),c=(0,h.s3)(o,n),l=new s.A(c);return a.__(r,(t=>{3===w?l.writeUint32(t.length):2===w?l.writeUint24(t.length):1===w?l.writeUint16(t.length):l.writeUint8(t.length),l.writeBuffer(t.subarray(0));const e=t[0]>>>1&63;19!==e&&20!==e&&21!==e||(i=!0)})),{bufferPointer:o,length:n,extradata:e,key:i}}function v(t,e){const i=e?3&e[21]:w;let r=[],n=[],c=[],d=!1;if(e){const t=g(e);r=t.vpss,n=t.spss,c=t.ppss,d=!0}const l=[],u=new o.A(t);for(;u.remainingSize()>0;){let t=0;t=3===i?u.readUint32():2===i?u.readUint24():1===i?u.readUint16():u.readUint8(),l.push(u.readBuffer(t))}let p=r.reduce(((t,e)=>t+4+e.length),0);p=n.reduce(((t,e)=>t+4+e.length),p),p=c.reduce(((t,e)=>t+4+e.length),p),p=l.reduce(((t,e,i)=>t+(i?3:4)+e.length),p);const U=(0,f.sY)(p+7),m=(0,h.s3)(U,p+7),b=new s.A(m);return b.writeUint8(0),b.writeUint8(0),b.writeUint8(0),b.writeUint8(1),b.writeUint8(70),b.writeUint8(0),b.writeUint8(240),a.__(r,(t=>{b.writeUint8(0),b.writeUint8(0),b.writeUint8(0),b.writeUint8(1),b.writeBuffer(t)})),a.__(n,(t=>{b.writeUint8(0),b.writeUint8(0),b.writeUint8(0),b.writeUint8(1),b.writeBuffer(t)})),a.__(c,(t=>{b.writeUint8(0),b.writeUint8(0),b.writeUint8(0),b.writeUint8(1),b.writeBuffer(t)})),a.__(l,((t,e)=>{b.writeUint8(0),b.writeUint8(0),e||b.writeUint8(0),b.writeUint8(1),b.writeBuffer(t);const i=t[0]>>>1&63;19!==i&&20!==i&&21!==i||(d=!0)})),{bufferPointer:U,length:p+7,key:d}}function y(t,e){var i;if(!(1&r.f[15](t+36)))return;const n=(0,l.iI)(t);if((0,d.Bs)(n))return;const a=null!==(i=e.metadata.naluLengthSizeMinusOne)&&void 0!==i?i:w;let s=[],c=[],u=[];const p=new o.A(n);for(;p.remainingSize()>0;){let t=0;t=3===a?p.readUint32():2===a?p.readUint24():1===a?p.readUint16():p.readUint8();const e=n.subarray(0|Number(0xffffffffn&p.getPos()),(0|Number(0xffffffffn&p.getPos()))+t);p.skip(t);const i=e[0]>>>1&63;33===i?c.push(e):34===i?u.push(e):32===i&&s.push(e)}if(c.length||u.length||s.length){const e=b(s,c,u),i=(0,f.sY)(e.length);(0,h.lW)(i,e.length,e),(0,l.Ow)(t,1,i,e.length)}}function I(t,e=!1){if(!(1&r.f[15](t+36)||e))return;const i=(0,l.iI)(t);if(!(0,d.Bs)(i))return;let a=(0,d.py)(i);if(a.length>2){const e=[],i=[],s=[];if(a.forEach((t=>{const r=t[0]>>>1&63;32===r?e.push(t):33===r?i.push(t):34===r&&s.push(t)})),e.length&&i.length&&s.length){const a=b(e,i,s),o=(0,f.sY)(a.length);(0,h.lW)(o,a.length,a),(0,l.Ow)(t,1,o,a.length),n.M[15](t+36,1|r.f[15](t+36))}}}function P(t,e){if(!e&&t.sideData[1]&&(e=t.sideData[1]),e&&e.length>=6){t.metadata.naluLengthSizeMinusOne=3&e[21];const{spss:i}=g(e);if(i.length){const{profile:e,level:r,width:n,height:a}=S(i[0]);t.codecpar.profile=e,t.codecpar.level=r,t.codecpar.width=n,t.codecpar.height=a}}}function S(t){if(!t||t.length<3)return;let e=0;0===t[0]&&0===t[1]&&0===t[2]&&1===t[3]&&(e=4);let i=0,r=0,n=0,a=0,s=0,o=0,h=1,l=0,f=0,p=0,U=0;const m=(0,d.BN)(t.subarray(e)),w=new c.A(m.length);w.appendBuffer(m),w.readU1(),w.readU(6),w.readU(6),w.readU(3),w.readU(4);const g=w.readU(3);if(w.readU1(),g<=6){l=w.readU(2),f=w.readU1(),i=w.readU(5),p=w.readU(32),U=w.readU(48),r=w.readU(8);const t=new Array(6),e=new Array(6);for(let i=0;i<g;i++)t[i]=w.readU1(),e[i]=w.readU1();if(g>0)for(let t=g;t<8;t++)w.readU(2);for(let i=0;i<g;i++)t[i]&&(w.readU(2),w.readU(1),w.readU(5),w.readU(32),w.readU(1),w.readU(1),w.readU(1),w.readU(1),w.readU(44)),e[i]&&w.readU(8);u.xb(w),h=u.xb(w),3===h&&w.readU(1),n=u.xb(w),a=u.xb(w);let c=0,d=0,m=0,b=0;w.readU1()&&(c=u.xb(w),d=u.xb(w),m=u.xb(w),b=u.xb(w)),s=u.xb(w),o=u.xb(w);let x=2,v=2;0===h?x=v=0:2===h?(x=2,v=1):3===h&&(x=v=1),n-=x*(1<<s+1)*(c+d),a-=v*(1<<s+1)*(m+b)}return{profile:i,level:r,width:n,height:a,chromaFormatIdc:h,bitDepthLumaMinus8:s,bitDepthChromaMinus8:o,generalProfileSpace:l,generalTierFlag:f,generalProfileCompatibilityFlag:p,constraintFlags:U}}},55611:(t,e,i)=>{i.d(e,{Jk:()=>v,OD:()=>x,Ui:()=>S,XC:()=>I,ci:()=>y,oT:()=>b});var r=i(63939),n=i(50932),a=i(72739),s=i(729),o=i(31865),c=i(37246),h=i(14686),d=i(60264),l=i(71517),f=i(37837),u=i(23991),p=i(83314);const U=3;function m(t){const e=t.readU(9),i=t.readU(3),r=t.readU(2),n=t.readU(2),a=t.readU(3);t.readU(5),t.readU(2);const s=t.readU(6),o=t.readU(7),c=t.readU(1),h=t.readU(8),d=t.readU(1),l=t.readU(1),f=[],u=[];if(s){for(let e=0;e<s-1;e++)f[e]=t.readU(8);f[s-1]=t.readU(6)}else t.readU(6);if(i>1){let e=0;for(let r=i-2;r>=0;--r)e|=t.readU(1)<<r;for(let e=i;e<=8&&i>1;++e)t.readU(1);for(let r=i-2;r>=0;--r)e&1<<r&&(u[r]=t.readU(8))}const p=t.readU(8),U=[];if(p)for(let e=0;e<p;e++)U.push(t.readU(8));return{olsIdx:e,numSublayers:i,bitDepthMinus8:a,chromaFormatIdc:n,constantFrameRate:r,generalProfileIdc:o,generalTierFlag:c,generalLevelIdc:h,ptlFrameOnlyConstraintFlag:d,ptlMultilayerEnabledFlag:l,generalConstraintInfo:f,sublayerLevelIdc:u,generalSubProfileIdc:U,maxPictureWidth:t.readU(16),maxPictureHeight:t.readU(16),avgFramerate:t.readU(16)}}function w(t){const e=new o.A(t,!0);if(1&e.readUint8()){const i=new c.A;i.appendBuffer(t.subarray(1)),m(i),e.skip(i.getPos())}let i=[],r=[],n=[];const a=e.readUint8();for(let t=0;t<a;t++){const t=31&e.readUint8();let a=1;13!==t&&12!==t&&(a=e.readUint16());const s=[];for(let t=0;t<a;t++){const t=e.readUint16();s.push(e.readBuffer(t))}14===t?i=s:15===t?r=s:16===t&&(n=s)}return{vpss:i,spss:r,ppss:n}}function g(t,e,i){const r=e[0];let n;if(r){const t=P(r),e=new p.A;if(e.writeU(9,0),e.writeU(3,t.spsMaxSublayersMinus1+1),e.writeU(2,1),e.writeU(2,t.chromaFormatIdc),e.writeU(3,t.bitDepthMinus8),e.writeU(5,31),e.writeU(2,3),e.writeU(6,t.generalConstraintInfo.length),e.writeU(7,t.profile),e.writeU1(t.tierFlag),e.writeU(8,t.level),e.writeU1(t.ptlFrameOnlyConstraintFlag),e.writeU1(t.ptlMultilayerEnabledFlag),t.generalConstraintInfo.length){for(let i=0;i<t.generalConstraintInfo.length-1;i++)e.writeU(8,t.generalConstraintInfo[i]);e.writeU(6,t.generalConstraintInfo[t.generalConstraintInfo.length-1])}else e.writeU(6,63);if(t.spsMaxSublayersMinus1+1>1){let i=0;for(let e=t.spsMaxSublayersMinus1-1;e>=0;e--)i=i<<1|t.ptlSublayerLevelPresentFlag[e];e.writeU(8,i)}for(let i=t.spsMaxSublayersMinus1-1;i>=0;i--)t.ptlSublayerLevelPresentFlag[i]&&e.writeU(8,t.sublayerLevelIdc[i]);e.writeU(8,t.generalSubProfileIdc.length);for(let i=0;i<t.generalSubProfileIdc.length;i++)e.writeU(32,t.sublayerLevelIdc[i]);e.writeU(16,t.width),e.writeU(16,t.height),e.writeU(16,0),e.padding(),n=e.getBuffer().subarray(0,e.getPointer())}let o=1+(n?n.length:0);t.length&&(o+=3,o=t.reduce(((t,e)=>t+2+e.length),o)),e.length&&(o+=3,o=e.reduce(((t,e)=>t+2+e.length),o)),i.length&&(o+=3,o=i.reduce(((t,e)=>t+2+e.length),o));const c=new Uint8Array(o),h=new s.A(c,!0);h.writeUint8(U<<1|(n?1:0)|248),n&&h.writeBuffer(n);let d=0;return t.length&&d++,e.length&&d++,i.length&&d++,h.writeUint8(d),t.length&&(h.writeUint8(142),h.writeUint16(t.length),a.__(t,(t=>{h.writeUint16(t.length),h.writeBuffer(t)}))),e.length&&(h.writeUint8(143),h.writeUint16(e.length),a.__(e,(t=>{h.writeUint16(t.length),h.writeBuffer(t)}))),i.length&&(h.writeUint8(144),h.writeUint16(i.length),a.__(i,(t=>{h.writeUint16(t.length),h.writeBuffer(t)}))),c}function b(t){let e,i=!1,r=(0,d.py)(t);if(r.length>2){const t=[],i=[],n=[];r.forEach((e=>{const r=e[0]>>>1&63;14===r?t.push(e):15===r?i.push(e):16===r&&n.push(e)})),t.length&&i.length&&n.length&&(e=g(t,i,n),r=r.filter((t=>{const e=t[0]>>>1&63;return 14!==e&&15!==e&&16!==e&&20!==e})))}const n=r.reduce(((t,e)=>t+U+1+e.length),0),o=(0,f.sY)(n),c=(0,h.s3)(o,n),l=new s.A(c);return a.__(r,(t=>{3===U?l.writeUint32(t.length):2===U?l.writeUint24(t.length):1===U?l.writeUint16(t.length):l.writeUint8(t.length),l.writeBuffer(t.subarray(0));const e=t[0]>>>1&63;8!==e&&7!==e&&9!==e&&10!==e||(i=!0)})),{bufferPointer:o,length:n,extradata:e,key:i}}function x(t,e){const i=e?e[0]>>>1&3:U;let r=[],n=[],c=[],d=!1;if(e){const t=w(e);r=t.vpss,n=t.spss,c=t.ppss,d=!0}const l=[],u=new o.A(t);for(;u.remainingSize()>0;){let t=0;t=3===i?u.readUint32():2===i?u.readUint24():1===i?u.readUint16():u.readUint8(),l.push(u.readBuffer(t))}let p=r.reduce(((t,e)=>t+4+e.length),0);p=n.reduce(((t,e)=>t+4+e.length),p),p=c.reduce(((t,e)=>t+4+e.length),p),p=l.reduce(((t,e,i)=>t+(i?3:4)+e.length),p);const m=(0,f.sY)(p+7),g=(0,h.s3)(m,p+7),b=new s.A(g);return b.writeUint8(0),b.writeUint8(0),b.writeUint8(0),b.writeUint8(1),b.writeUint8(0),b.writeUint8(160),b.writeUint8(240),a.__(r,(t=>{b.writeUint8(0),b.writeUint8(0),b.writeUint8(0),b.writeUint8(1),b.writeBuffer(t)})),a.__(n,(t=>{b.writeUint8(0),b.writeUint8(0),b.writeUint8(0),b.writeUint8(1),b.writeBuffer(t)})),a.__(c,(t=>{b.writeUint8(0),b.writeUint8(0),b.writeUint8(0),b.writeUint8(1),b.writeBuffer(t)})),a.__(l,((t,e)=>{b.writeUint8(0),b.writeUint8(0),e||b.writeUint8(0),b.writeUint8(1),b.writeBuffer(t);const i=t[0]>>>1&63;8!==i&&7!==i&&9!==i&&10!==i||(d=!0)})),{bufferPointer:m,length:p+7,key:d}}function v(t,e){var i;if(!(1&r.f[15](t+36)))return;const n=(0,l.iI)(t);if((0,d.Bs)(n))return;const a=null!==(i=e.metadata.naluLengthSizeMinusOne)&&void 0!==i?i:U;let s=[],c=[],u=[];const p=new o.A(n);for(;p.remainingSize()>0;){let t=0;t=3===a?p.readUint32():2===a?p.readUint24():1===a?p.readUint16():p.readUint8();const e=n.subarray(0|Number(0xffffffffn&p.getPos()),(0|Number(0xffffffffn&p.getPos()))+t);p.skip(t);const i=e[0]>>>1&63;15===i?c.push(e):16===i?u.push(e):14===i&&s.push(e)}if(c.length||u.length||s.length){const e=g(s,c,u),i=(0,f.sY)(e.length);(0,h.lW)(i,e.length,e),(0,l.Ow)(t,1,i,e.length)}}function y(t,e=!1){if(!(1&r.f[15](t+36)||e))return;const i=(0,l.iI)(t);if(!(0,d.Bs)(i))return;let a=(0,d.py)(i);if(a.length>2){const e=[],i=[],s=[];if(a.forEach((t=>{const r=t[0]>>>1&63;14===r?e.push(t):15===r?i.push(t):16===r&&s.push(t)})),e.length&&i.length&&s.length){const a=g(e,i,s),o=(0,f.sY)(a.length);(0,h.lW)(o,a.length,a),(0,l.Ow)(t,1,o,a.length),n.M[15](t+36,1|r.f[15](t+36))}}}function I(t,e){if(!e&&t.sideData[1]&&(e=t.sideData[1]),e&&e.length>=6){t.metadata.naluLengthSizeMinusOne=e[0]>>>1&3;const{spss:i}=w(e);if(i.length){const{profile:e,level:r,width:n,height:a}=P(i[0]);t.codecpar.profile=e,t.codecpar.level=r,t.codecpar.width=n,t.codecpar.height=a}}}function P(t){if(!t||t.length<3)return;let e=0;0===t[0]&&0===t[1]&&0===t[2]&&1===t[3]&&(e=4);let i=0,r=0,n=0,a=0,s=0,o=1,h=0,l=0,f=0;const p=[],U=[],m=[],w=[],g=(0,d.BN)(t.subarray(e)),b=new c.A(g.length);b.appendBuffer(g),b.readU1(),b.readU1(),b.readU(6),b.readU(5),b.readU(3),b.readU(8);const x=b.readU(3);o=b.readU(2);const v=b.readU(2);if(b.readU(1)){if(i=b.readU(7),h=b.readU(1),r=b.readU(8),l=b.readU(1),f=b.readU(1),b.readU(1)){for(let t=0;t<8;t++)p[t]=b.readU(8);p[8]=b.readU(7);const t=b.readU(8);b.readU(t)}b.skipPadding();for(let t=x-1;t>=0;t--)U[t]=b.readU(1);b.skipPadding();for(let t=x-1;t>=0;t--)U[t]&&(m[t]=b.readU(8));const t=b.readU(8);if(t)for(let e=0;e<t;e++)w[e]=b.readU(32)}b.readU1(),b.readU1()&&b.readU1();const y=n=u.xb(b),I=a=u.xb(b);if(b.readU1()&&(u.xb(b),u.xb(b),u.xb(b),u.xb(b)),b.readU1()){const t=u.xb(b),e=v+5,i=1<<e,r=y/(1<<e),n=I/(1<<e),a=Math.ceil(Math.log2(r)),s=Math.ceil(Math.log2(n));let o=0,c=0,h=0;t>0&&(h=b.readU1(),c=b.readU1());for(let e=0;t>0&&e<=t;e++)c&&0!=e||(e>0&&y>i&&b.readU(a),e>0&&I>i&&b.readU(s),e<t&&y>i&&b.readU(a),e<t&&I>i&&b.readU(s)),h||b.readU(2);if(o=u.xb(b)+1,b.readU(1)&&b.readU(1))for(let e=0;e<=t;e++)b.readU(o)}return s=u.xb(b),{profile:i,level:r,width:n,height:a,chromaFormatIdc:o,bitDepthMinus8:s,generalProfileSpace:0,tierFlag:h,generalConstraintInfo:p,generalSubProfileIdc:w,ptlFrameOnlyConstraintFlag:l,ptlMultilayerEnabledFlag:f,spsMaxSublayersMinus1:x,ptlSublayerLevelPresentFlag:U,sublayerLevelIdc:m}}function S(t){const e=new c.A;return e.appendBuffer(t),1&e.readU(8)?m(e):{}}},4003:(t,e,i)=>{i.r(e),i.d(e,{default:()=>B});var r=i(134),n=i(61499),a=i(63939),s=i(9599),o=i(29170),c=i(51597),h=i(58121),d=i(68243),l=i(72739),f=i(95335),u=i(35028),p=i(94889),U=i(96157),m=i(95268),w=i(33854),g=i(92647),b=i(14686),x=i(4624),v=i(71517),y=i(44328),I=i(26173),P=i(77231),S="src/avformat/formats/OFlvFormat.ts";class B extends c.A{constructor(t={}){super(),(0,r.A)(this,"type",0),(0,r.A)(this,"context",void 0),(0,r.A)(this,"header",void 0),(0,r.A)(this,"script",void 0),(0,r.A)(this,"options",void 0),(0,r.A)(this,"annexb2AvccFilter",void 0),this.header=new h.A,this.script=new d.A,this.options=t,this.context={keyframeFilePositions:[],keyFrameTimes:[],lastkeyframelocation:0,lastkeyframetimestamp:BigInt(0),lasttimestamp:BigInt(0),framerate:0,filesize:0,audioSize:0,videosize:0,datasize:0,duration:0,scriptWrote:!1,frameCount:0,firstKeyframePositionWrote:!1,videoMetadataWrote:!1}}init(t){t.ioWriter&&t.ioWriter.setEndian(!0);const e=t.getStreamByMediaType(1),i=t.getStreamByMediaType(0);return e&&(this.header.hasAudio=!0,this.script.onMetaData.hasAudio=!0,86051===e.codecpar.codecId&&(16e3!==e.codecpar.sampleRate&&x.h2("flv speex only support 16000 sample rate",S,114),1!==e.codecpar.chLayout.nbChannels&&x.h2("flv speex only support 1 channel",S,117)),f.zy(u.FV,e.codecpar.codecId)&&(this.script.onMetaData.audiocodecid=u.FV[e.codecpar.codecId],this.script.onMetaData.stereo=e.codecpar.chLayout.nbChannels>1,this.script.onMetaData.audiosamplerate=e.codecpar.sampleRate||0,this.script.onMetaData.audiosamplesize=e.codecpar.frameSize||0),e.timeBase.den=1e3,e.timeBase.num=1),i&&(this.header.hasVideo=!0,this.script.onMetaData.hasVideo=!0,f.zy(u.FV,i.codecpar.codecId)&&(this.script.onMetaData.videocodecid=u.FV[i.codecpar.codecId],this.script.onMetaData.width=i.codecpar.width||0,this.script.onMetaData.height=i.codecpar.height||0,this.script.onMetaData.framerate=(0,y.lb)(i.codecpar.framerate)),i.timeBase.den=1e3,i.timeBase.num=1,this.annexb2AvccFilter=new I.A,this.annexb2AvccFilter.init(i.codecpar[n.o9],i.timeBase[n.o9])),0}destroy(t){super.destroy(t),this.annexb2AvccFilter&&(this.annexb2AvccFilter.destroy(),this.annexb2AvccFilter=null)}writeHeader(t){this.header.write(t.ioWriter),t.ioWriter.writeUint32(0),this.options.live&&(this.script.write(t.ioWriter),this.context.scriptWrote=!0);const e=t.getStreamByMediaType(1),i=t.getStreamByMediaType(0);if(e&&e.codecpar.extradata){if(86018===e.codecpar.codecId){const i=U.e(t.ioWriter,e,(0,b.s3)(e.codecpar.extradata,e.codecpar.extradataSize));this.context.filesize+=i+4,this.context.audioSize+=e.codecpar.extradataSize,this.context.datasize+=e.codecpar.extradataSize}this.script.onMetaData.hasMetadata=!0}if(i&&i.codecpar.extradata){if(27===i.codecpar.codecId||173===i.codecpar.codecId||196===i.codecpar.codecId||167===i.codecpar.codecId||225===i.codecpar.codecId||12===i.codecpar.codecId){const e=t.ioWriter.getPos(),r=173===i.codecpar.codecId||196===i.codecpar.codecId||167===i.codecpar.codecId||225===i.codecpar.codecId?w.e(t.ioWriter,i,(0,b.s3)(i.codecpar.extradata,i.codecpar.extradataSize),1):m.e(t.ioWriter,i,(0,b.s3)(i.codecpar.extradata,i.codecpar.extradataSize),1);this.context.filesize+=r+4,this.context.videosize+=i.codecpar.extradataSize,this.context.datasize+=i.codecpar.extradataSize,this.context.keyFrameTimes.push(0),this.context.keyframeFilePositions.push(Number(e)),this.context.videoMetadataWrote=!0}this.script.onMetaData.hasMetadata=!0}return 0}writeAVPacket(t,e){const i=t.getStreamByIndex(a.f[15](e+32));if(i){if(1===i.codecpar.codecType){const r=(0,v.rU)(e,1);if(r){const e=(0,b.s3)(a.f[20](r),a.f[15](r+4));86018===i.codecpar.codecId&&U.e(t.ioWriter,i,e)}if(a.f[15](e+28)){const r=t.ioWriter.getPos();p.xk(t.ioWriter,8,a.f[15](e+28)+1+u.IO[i.codecpar.codecId],(0,y.k)(a.f[17](e+16),(0,o.A)(e+72,s.P),i.timeBase)),p.BV(t.ioWriter,i),86018===i.codecpar.codecId&&U.x(t.ioWriter,1),t.ioWriter.writeBuffer((0,b.s3)(a.f[20](e+24),a.f[15](e+28)));const n=Number(t.ioWriter.getPos()-r);t.ioWriter.writeUint32(n),this.context.audioSize+=n,this.context.filesize+=n+4,this.context.lasttimestamp=(0,y.k)(a.f[17](e+8),(0,o.A)(e+72,s.P),i.timeBase),this.context.datasize+=a.f[15](e+28)||0}}else if(0===i.codecpar.codecType){27!==i.codecpar.codecId&&12!==i.codecpar.codecId&&173!==i.codecpar.codecId&&196!==i.codecpar.codecId||1===a.f[15](e+80)||(this.annexb2AvccFilter.sendAVPacket(e),this.annexb2AvccFilter.receiveAVPacket(e));const r=t.ioWriter.getPos(),n=(0,v.rU)(e,1);if(n){const e=(0,b.s3)(a.f[20](n),a.f[15](n+4));27===i.codecpar.codecId||12===i.codecpar.codecId?m.e(t.ioWriter,i,e,1):173!==i.codecpar.codecId&&196!==i.codecpar.codecId&&167!==i.codecpar.codecId&&225!==i.codecpar.codecId||w.e(t.ioWriter,i,(0,b.s3)(i.codecpar.extradata,i.codecpar.extradataSize),1)}if(a.f[15](e+28)){const n=t.ioWriter.getPos();if(27===i.codecpar.codecId||12===i.codecpar.codecId){p.xk(t.ioWriter,9,a.f[15](e+28)+1+u.IO[i.codecpar.codecId],(0,y.k)(a.f[17](e+16),(0,o.A)(e+72,s.P),i.timeBase)),p.ii(t.ioWriter,i,a.f[15](e+36));let r=0;a.f[17](e+8)!==P.Dh&&(r=0|Number(0xffffffffn&(0,y.k)(a.f[17](e+8)-a.f[17](e+16),(0,o.A)(e+72,s.P),i.timeBase))),m.x(t.ioWriter,1,r)}else if(173===i.codecpar.codecId||196===i.codecpar.codecId||167===i.codecpar.codecId||225===i.codecpar.codecId){const r=a.f[17](e+16)===a.f[17](e+8)||173!==i.codecpar.codecId&&196!==i.codecpar.codecId?3:1;if(p.xk(t.ioWriter,9,a.f[15](e+28)+1+u.IO[i.codecpar.codecId]+(1===r?3:0),(0,y.k)(a.f[17](e+16),(0,o.A)(e+72,s.P),i.timeBase)),p.VU(t.ioWriter,i,r,a.f[15](e+36)),w.d(t.ioWriter,i.codecpar.codecId),1===r){let r=0;a.f[17](e+8)!==P.Dh&&(r=0|Number(0xffffffffn&(0,y.k)(a.f[17](e+8)-a.f[17](e+16),(0,o.A)(e+72,s.P),i.timeBase))),t.ioWriter.writeUint24(r)}}t.ioWriter.writeBuffer((0,b.s3)(a.f[20](e+24),a.f[15](e+28)));const c=Number(t.ioWriter.getPos()-n);t.ioWriter.writeUint32(c),this.context.videosize+=c,this.context.filesize+=c+4,this.context.lasttimestamp=(0,y.k)(a.f[17](e+8),(0,o.A)(e+72,s.P),i.timeBase),this.context.datasize+=a.f[15](e+28)||0,this.context.frameCount++,1&a.f[15](e+36)&&(this.context.firstKeyframePositionWrote||!this.context.videoMetadataWrote?(this.context.lastkeyframetimestamp=(0,y.k)(a.f[17](e+8),(0,o.A)(e+72,s.P),i.timeBase),this.context.lastkeyframelocation=Number(r),this.context.keyFrameTimes.push(Number((Number(this.context.lastkeyframetimestamp)*(0,y.lb)(i.timeBase)).toFixed(2))),this.context.keyframeFilePositions.push(this.context.lastkeyframelocation)):this.context.firstKeyframePositionWrote=!0)}}return 0}x.R8(`can not found the stream width the packet's streamIndex: ${a.f[15](e+32)}, ignore it`,S,235)}writeTrailer(t){const e=t.getStreamByMediaType(0);if(e&&(27===e.codecpar.codecId||173===e.codecpar.codecId||196===e.codecpar.codecId||167===e.codecpar.codecId||225===e.codecpar.codecId||12===e.codecpar.codecId)){const i=173===e.codecpar.codecId||196===e.codecpar.codecId||167===e.codecpar.codecId||225===e.codecpar.codecId;p.xk(t.ioWriter,9,1+u.IO[e.codecpar.codecId],BigInt(0)),i?(p.VU(t.ioWriter,e,2,1),w.d(t.ioWriter,e.codecpar.codecId)):(p.ii(t.ioWriter,e,1),m.x(t.ioWriter,2,0)),t.ioWriter.writeUint32(12+u.IO[e.codecpar.codecId]),this.context.videosize+=12+u.IO[e.codecpar.codecId],this.context.filesize+=12+u.IO[e.codecpar.codecId]+4,this.script.onMetaData.canSeekToEnd=!0}if(this.context.scriptWrote)t.ioWriter.flush();else{t.ioWriter.flush(),this.script.onMetaData.filesize=this.context.filesize,this.script.onMetaData.audiosize=this.context.audioSize,this.script.onMetaData.videosize=this.context.videosize,this.script.onMetaData.datasize=this.context.datasize,this.script.onMetaData.lasttimestamp=this.context.lasttimestamp,this.options.hasKeyframes?(this.script.onMetaData.lastkeyframetimestamp=this.context.lastkeyframetimestamp,this.script.onMetaData.lastkeyframelocation=this.context.lastkeyframelocation,this.context.keyFrameTimes.length>1?(this.script.onMetaData.hasKeyframes=!0,this.script.onMetaData.keyframes={filepositions:this.context.keyframeFilePositions,times:this.context.keyFrameTimes}):this.script.onMetaData.hasKeyframes=!1):this.script.onMetaData.hasKeyframes=!1,this.script.onMetaData.duration=Number((Number(this.context.lasttimestamp)/1e3).toFixed(2)),this.script.onMetaData.audiodatarate=Number((this.context.audioSize/this.script.onMetaData.duration/1e3).toFixed(2)),this.script.onMetaData.videodatarate=Number((this.context.videosize/this.script.onMetaData.duration/1e3).toFixed(2)),this.script.onMetaData.framerate=Math.floor(this.context.frameCount/this.script.onMetaData.duration);const e=this.script.computeSize();l.__(this.context.keyframeFilePositions,((t,i)=>{this.context.keyframeFilePositions[i]=t+11+e+4})),this.script.onMetaData.keyframes&&(this.script.onMetaData.keyframes.filepositions=this.context.keyframeFilePositions),this.context.filesize+=11+e+4,this.script.onMetaData.filesize=this.context.filesize;const i=[],r=t.ioWriter.onFlush;t.ioWriter.onFlush=t=>(i.push(t.slice()),0),this.script.write(t.ioWriter),t.ioWriter.flush(),t.ioWriter.onFlush=r;const n=(0,g.A)(Uint8Array,i);r&&r(n,BigInt(13))}return 0}flush(t){return t.ioWriter.flush(),0}}},51597:(t,e,i)=>{i.d(e,{A:()=>n});var r=i(134);class n{constructor(){(0,r.A)(this,"type",-1)}destroy(t){}}},58121:(t,e,i)=>{i.d(e,{A:()=>n});var r=i(134);class n{constructor(){(0,r.A)(this,"signature",void 0),(0,r.A)(this,"version",void 0),(0,r.A)(this,"flags",void 0),(0,r.A)(this,"dataOffset",void 0),(0,r.A)(this,"hasVideo",void 0),(0,r.A)(this,"hasAudio",void 0),this.signature="FLV",this.version=1,this.flags=0,this.dataOffset=9,this.hasAudio=!1,this.hasVideo=!1}async read(t){this.signature=await t.readString(3),this.version=await t.readUint8(),this.flags=await t.readUint8(),this.dataOffset=await t.readUint32(),this.hasAudio=!!(4&this.flags),this.hasVideo=!!(1&this.flags)}write(t){this.flags=0,this.hasAudio&&(this.flags|=4),this.hasVideo&&(this.flags|=1),t.writeString(this.signature),t.writeUint8(this.version),t.writeUint8(this.flags),t.writeUint32(this.dataOffset)}}},68243:(t,e,i)=>{i.d(e,{A:()=>f});var r=i(134),n=i(35336),a=i(67672),s=i(72739),o=i(95335),c=i(92647),h=i(4624),d=i(94889),l=i(9705);class f{constructor(){(0,r.A)(this,"onMetaData",void 0),this.onMetaData={audiocodecid:10,canSeekToEnd:!1,width:0,height:0,stereo:!0,videocodecid:7}}async parseObject(t,e){return{key:await t.readString(await t.readUint16()),value:await this.parseValue(t,e)}}async parseValue(t,e){let i;switch(await t.readUint8()){case 0:i=await t.readDouble();break;case 1:i=!!await t.readUint8();break;case 2:i=await t.readString(await t.readUint16());break;case 3:for(i={};t.getPos()<e;){const{key:r,value:n}=await this.parseObject(t,e);if(i[r]=n,9==(16777215&await t.peekUint24())){await t.skip(3);break}}break;case 8:for(i={},await t.skip(4);t.getPos()<e;){const{key:r,value:n}=await this.parseObject(t,e);if(i[r]=n,9==(16777215&await t.peekUint24())){await t.skip(3);break}}break;case 9:i=null;break;case 10:i=[];const r=await t.readUint32();for(let n=0;n<r;n++)i.push(await this.parseValue(t,e));break;case 11:const n=await t.readDouble(),a=await t.readInt16();i=new Date(n+60*a*1e3);break;case 12:i=await t.readString(await t.readUint32())}return i}async read(t,e){const i=t.getPos(),r=i+BigInt(Math.floor(e)),n=await this.parseValue(t,r),a=await this.parseValue(t,r);this[n]=a;const s=Number(t.getPos()-i),o=await t.readUint32();return s+11!==o?(h.R8(`script size not match, size: ${s+11}, previousTagSize: ${o}`,"src/avformat/formats/flv/FlvScriptTag.ts",150),l.LR):0}writeValue(t,e){a.ai(e)?(t.writeUint8(0),t.writeDouble(e)):a.o(e)?(t.writeUint8(0),t.writeDouble(Number(e))):a.zM(e)?(t.writeUint8(1),t.writeUint8(e?1:0)):a.Yj(e)?e.length>=65536?(t.writeUint8(12),t.writeUint32(e.length),t.writeString(e)):(t.writeUint8(2),t.writeUint16(e.length),t.writeString(e)):a.YO(e)?(t.writeUint8(10),t.writeUint32(e.length),s.__(e,(e=>{this.writeValue(t,e)}))):a.Ik(e)?(t.writeUint8(3),o.__(e,((e,i)=>{t.writeUint16(i.length),t.writeString(i),this.writeValue(t,e)})),t.writeUint24(9)):e instanceof Date&&(t.writeUint8(11),t.writeDouble(e.getTime()),t.writeInt16(0))}computeSize(){const t=[],e=new n.A;return e.onFlush=e=>(t.push(e.slice()),0),this.writeValue(e,"onMetaData"),this.writeValue(e,this.onMetaData),e.flush(),(0,c.A)(Uint8Array,t).length}write(t){if(this.onMetaData){const e=[],i=new n.A;i.onFlush=t=>(e.push(t.slice()),0),this.writeValue(i,"onMetaData"),this.writeValue(i,this.onMetaData),i.flush();const r=(0,c.A)(Uint8Array,e),a=t.getPos();d.xk(t,18,r.length,BigInt(0)),t.writeBuffer(r),t.writeUint32(Number(t.getPos()-a))}}dts2Position(t){if(this.canSeek()){let e=-1;const i=this.onMetaData.keyframes.times,r=this.onMetaData.keyframes.filepositions;let n;for(n=0;n<i.length;n++){if(i[n]===t){e=n;break}if(i[n]>t){e=Math.max(n-1,0);break}}return n&&n===i.length&&(e=i.length-1),{pos:r[e],dts:i[e]}}return{pos:-1,dts:-1}}position2DTS(t){if(this.canSeek()){let i=-1;const r=this.onMetaData.keyframes.times,n=this.onMetaData.keyframes.filepositions;let a=0;for(a=0;a<n.length;a++)if(n[a]>t){i=a;break}var e;return a===n.length?null!==(e=this.onMetaData.duration)&&void 0!==e?e:r[r.length-1]:r[i]}return-1}canSeek(){return!!(this.onMetaData.keyframes&&this.onMetaData.keyframes.filepositions&&this.onMetaData.keyframes.filepositions.length)}}},96157:(t,e,i)=>{i.d(e,{e:()=>s,x:()=>a});var r=i(94889),n=i(35028);function a(t,e){t.writeUint8(e)}function s(t,e,i){const s=t.getPos();r.xk(t,8,i.length+1+n.IO[86018],BigInt(0)),r.BV(t,e),a(t,0),t.writeBuffer(i);const o=Number(t.getPos()-s);return t.writeUint32(o),o}},33854:(t,e,i)=>{i.d(e,{d:()=>a,e:()=>s});var r=i(94889),n=i(35028);function a(t,e){switch(e){case 173:t.writeString("hvc1");break;case 196:t.writeString("vvc1");break;case 167:t.writeString("vp09");break;case 225:t.writeString("av01")}}function s(t,e,i,s){const o=t.getPos();r.xk(t,9,i.length+1+n.IO[e.codecpar.codecId],BigInt(0)),(0,r.VU)(t,e,0,s),a(t,e.codecpar.codecId),t.writeBuffer(i);const c=Number(t.getPos()-o);return t.writeUint32(c),c}},95268:(t,e,i)=>{i.d(e,{e:()=>s,x:()=>a});var r=i(94889),n=i(35028);function a(t,e,i){t.writeUint8(e),t.writeUint24(i)}function s(t,e,i,s){const o=t.getPos();r.xk(t,9,i.length+1+n.IO[27],BigInt(0)),r.ii(t,e,s),a(t,0,0),t.writeBuffer(i);const c=Number(t.getPos()-o);return t.writeUint32(c),c}},35028:(t,e,i)=>{i.d(e,{FJ:()=>n,FV:()=>r,IO:()=>s,U5:()=>a});const r={86018:10,86017:2,86051:11,27:7,173:12,196:13,12:9},n={10:86018,2:86017,11:86051,1:69645,4:86049,5:86049,6:86049,7:65543,8:65542},a={7:27,12:173,13:196,9:12,2:4,3:86,4:92,5:106,6:131},s={86018:1,86017:1,86051:1,27:4,12:4,173:4,196:4,167:4,225:4}},94889:(t,e,i)=>{i.d(e,{BV:()=>a,VU:()=>o,ii:()=>s,xk:()=>n});var r=i(35028);function n(t,e,i,r){t.writeUint8(e),t.writeUint24(i),t.writeUint24(Number(r&BigInt(16777215))),t.writeUint8(Number(r>>BigInt(24)&BigInt(255))),t.writeUint24(0)}function a(t,e){let i=2;(86018===e.codecpar.codecId||e.codecpar.chLayout.nbChannels>1)&&(i|=1),86018===e.codecpar.codecId||e.codecpar.sampleRate>=44e3?i|=12:e.codecpar.sampleRate>=22e3?i|=8:e.codecpar.sampleRate>=11e3&&(i|=4),i|=r.FV[e.codecpar.codecId]<<4,t.writeUint8(i)}function s(t,e,i){let n=15&r.FV[e.codecpar.codecId];27!==e.codecpar.codecId&&173!==e.codecpar.codecId&&196!==e.codecpar.codecId||(n|=1&i?16:32),t.writeUint8(n)}function o(t,e,i,r){let n=15&i|128;27!==e.codecpar.codecId&&173!==e.codecpar.codecId&&196!==e.codecpar.codecId&&167!==e.codecpar.codecId&&225!==e.codecpar.codecId||(n|=1&r?16:32),t.writeUint8(n)}},23991:(t,e,i)=>{function r(t){let e=0,i=0;for(;i<32&&0===t.readU1();)i++;return e=t.readU(i),e+=(1<<i)-1,e}function n(t){let e=r(t);return e=1&e?(e+1)/2:-e/2,e}i.d(e,{$x:()=>n,xb:()=>r})},60264:(t,e,i)=>{function r(t){return t.length>4&&0===t[0]&&0===t[1]&&(1===t[2]||0===t[2]&&1===t[3])}function n(t,e){let i=0;for(let r=e;r<t.length;r++)switch(t[r]){case 0:i++;break;case 1:if(i>=2)return{offset:r-Math.min(i,3),startCode:Math.min(i+1,4)};i=0;break;default:i=0}return{offset:-1,startCode:0}}function a(t){const e=[];let i=n(t,0),r={offset:-1,startCode:0};for(;r=n(t,i.offset+i.startCode),r.offset>-1;)e.push(t.subarray(i.offset+i.startCode,r.offset,!0)),i=r;return e.push(t.subarray(i.offset+i.startCode,void 0,!0)),e}function s(t,e=0,i){i||(i=t.length);const r=new Uint8Array(t.length);let n=0,a=0;for(let s=0;s<t.length;s++){if(s>=e&&s<i)if(0===t[s])n++;else if(3===t[s]&&2===n&&s+1<t.length&&t[s+1]<=3){if(s++,s===t.length)break;n=0===t[s]?1:0}else n=0;r[a++]=t[s]}return r.slice(0,a)}i.d(e,{BN:()=>s,Bs:()=>r,py:()=>a})},37246:(t,e,i)=>{i.d(e,{A:()=>a});var r=i(134),n=i(4624);class a{constructor(t=1048576){(0,r.A)(this,"buffer",void 0),(0,r.A)(this,"pointer",void 0),(0,r.A)(this,"bitsLeft",void 0),(0,r.A)(this,"size",void 0),(0,r.A)(this,"endPointer",void 0),(0,r.A)(this,"error",void 0),(0,r.A)(this,"onFlush",void 0),this.pointer=0,this.bitsLeft=8,this.size=t,this.endPointer=0,this.error=0,this.buffer=new Uint8Array(this.size)}peekU1(){let t=0;(this.remainingLength()<1||1===this.remainingLength()&&0===this.bitsLeft)&&this.flush();let e=this.pointer,i=this.bitsLeft;return 0===i&&(e++,i=8),t=this.buffer[e]>>i-1&1,t}readU1(){let t=0;return(this.remainingLength()<1||1===this.remainingLength()&&0===this.bitsLeft)&&this.flush(),this.bitsLeft--,t=this.buffer[this.pointer]>>this.bitsLeft&1,0===this.bitsLeft&&(this.pointer++,this.bitsLeft=8),t}readU(t){let e=0;for(let i=0;i<t;i++)e|=this.readU1()<<t-i-1;return e}remainingLength(){return this.endPointer-this.pointer}getPos(){return this.pointer}skip(t){const e=(t-t%8)/8;this.pointer+=e;const i=t%8;this.bitsLeft<=i?(this.pointer++,this.bitsLeft=8-(i-this.bitsLeft)):this.bitsLeft-=i}flush(){if(!this.onFlush)throw this.error=-1048574,Error("IOReader error, flush failed because of no flush callback");if(0===this.bitsLeft&&this.pointer++,!(this.size-this.remainingLength()<=0))if(this.pointer<this.endPointer){this.buffer.set(this.buffer.subarray(this.pointer,this.endPointer),0);const t=this.onFlush(this.buffer.subarray(this.endPointer-this.pointer,this.size));if(t<0)throw this.error=t,Error("IOReader error, flush failed");this.endPointer=this.endPointer-this.pointer+t,this.pointer=0}else{const t=this.onFlush(this.buffer);if(this.endPointer=t,this.pointer=0,this.bitsLeft=8,t<0)throw this.error=t,Error("IOReader error, flush failed")}}getBuffer(){return this.buffer}appendBuffer(t){if(this.size-this.endPointer>=t.length)this.buffer.set(t,this.endPointer),this.endPointer+=t.length;else if(this.buffer.set(this.buffer.subarray(this.pointer,this.endPointer),0),this.endPointer=this.endPointer-this.pointer,this.pointer=0,this.size-this.endPointer>=t.length)this.buffer.set(t,this.endPointer),this.endPointer+=t.length;else{const e=Math.min(this.size-this.endPointer,t.length);this.buffer.set(t.subarray(0,e),this.endPointer),this.endPointer+=e,n.R8("BSReader, call appendBuffer but the buffer's size is lagger then the remaining size","src/common/io/BitReader.ts",190)}}clear(){this.pointer=this.endPointer=0,this.bitsLeft=8,this.error=0}skipPadding(){this.bitsLeft<8&&(this.bitsLeft=8,this.pointer++)}}},83314:(t,e,i)=>{i.d(e,{A:()=>n});var r=i(134);class n{constructor(t=1048576){(0,r.A)(this,"buffer",void 0),(0,r.A)(this,"pointer",void 0),(0,r.A)(this,"bitPointer",void 0),(0,r.A)(this,"size",void 0),(0,r.A)(this,"error",void 0),(0,r.A)(this,"onFlush",void 0),this.pointer=0,this.bitPointer=0,this.size=t,this.error=0,this.buffer=new Uint8Array(this.size)}writeU1(t){(this.remainingLength()<1||1===this.remainingLength()&&this.bitPointer>=8)&&this.flush(),1&t?this.buffer[this.pointer]|=1<<7-this.bitPointer:this.buffer[this.pointer]&=~(1<<7-this.bitPointer),this.bitPointer++,8===this.bitPointer&&(this.pointer++,this.bitPointer=0)}writeU(t,e){for(let i=0;i<t;i++)this.writeU1(e>>t-i-1&1)}remainingLength(){return this.size-this.pointer}flush(){if(!this.onFlush)throw this.error=-1048574,Error("BSWriter error, flush failed because of no flush callback");if(this.pointer)if(this.bitPointer&&this.pointer>1){const t=this.onFlush(this.buffer.subarray(0,this.pointer-1));if(0!==t)throw this.error=t,Error("BSWriter error, flush failed");this.buffer[0]=this.buffer[this.pointer]}else if(0===this.bitPointer){const t=this.onFlush(this.buffer.subarray(0,this.pointer));if(0!==t)throw this.error=t,Error("BSWriter error, flush failed")}this.pointer=0}padding(){for(;0!==this.bitPointer;)this.writeU1(0)}clear(){this.pointer=0,this.bitPointer=0,this.error=0}getBuffer(){return this.buffer}getPointer(){return this.pointer}}},729:(t,e,i)=>{i.d(e,{A:()=>s});var r=i(134),n=i(4624),a=i(50011);class s{constructor(t,e=!0){(0,r.A)(this,"data",void 0),(0,r.A)(this,"buffer",void 0),(0,r.A)(this,"byteStart",void 0),(0,r.A)(this,"pos",void 0),(0,r.A)(this,"size",void 0),(0,r.A)(this,"littleEndian",void 0),this.buffer=t,this.data=t instanceof Uint8Array?new DataView(t.buffer):t.view,this.byteStart=t instanceof Uint8Array?t.byteOffset:0,this.pos=0,this.size=t.byteLength,this.littleEndian=!e}writeUint8(t){this.data.setUint8(this.pos+++this.byteStart,t)}writeUint16(t){this.data.setUint16(this.pos+this.byteStart,t,this.littleEndian),this.pos+=2}writeUint24(t){const e=3840&t,i=240&t,r=15&t;this.littleEndian?(this.writeUint8(r),this.writeUint8(i),this.writeUint8(e)):(this.writeUint8(e),this.writeUint8(i),this.writeUint8(r))}writeUint32(t){this.data.setUint32(this.pos+this.byteStart,t,this.littleEndian),this.pos+=4}writeUint64(t){const e=t&BigInt(4294967295),i=(t&BigInt(4294967295)<<BigInt(32))>>BigInt(32);this.littleEndian?(this.writeUint32(Number(e)),this.writeUint32(Number(i))):(this.writeUint32(Number(i)),this.writeUint32(Number(e)))}writeInt8(t){this.data.setInt8(this.pos+++this.byteStart,t)}writeInt16(t){this.data.setInt16(this.pos+this.byteStart,t,this.littleEndian),this.pos+=2}writeInt32(t){this.data.setInt32(this.pos+this.byteStart,t,this.littleEndian),this.pos+=4}writeInt64(t){const e=t&BigInt(4294967295),i=(t&BigInt(4294967295)<<BigInt(32))>>BigInt(32);this.littleEndian?(this.writeInt32(Number(e)),this.writeInt32(Number(i))):(this.writeInt32(Number(i)),this.writeInt32(Number(e)))}writeFloat(t){this.data.setFloat32(this.pos+this.byteStart,t,this.littleEndian),this.pos+=4}writeDouble(t){this.data.setFloat64(this.pos+this.byteStart,t,this.littleEndian),this.pos+=8}getPos(){return this.pos}seek(t){t>this.size&&(t=this.size),this.pos=Math.max(0,t)}skip(t){this.seek(this.pos+t)}back(t){this.seek(this.pos-t)}remainingSize(){return this.size-this.pos}writeBuffer(t){let e=t.length;this.remainingSize()<e&&(e=this.remainingSize(),n.R8(`the remaining buffer size is smaller then the wrote buffer, hope set ${t.length}, but set ${e}`,"src/common/io/BufferWriter.ts",211)),this.buffer.set(t,this.pos),this.pos+=t.length}writeString(t){const e=a.l(t);return this.writeBuffer(e),e.length}getWroteBuffer(){return this.buffer.subarray(0,this.pos)}resetBuffer(t,e=!0){this.buffer=t,this.data=t instanceof Uint8Array?new DataView(t.buffer):t.view,this.byteStart=t instanceof Uint8Array?t.byteOffset:0,this.pos=0,this.size=t.byteLength,this.littleEndian=!e}}}}]);