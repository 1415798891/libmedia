"use strict";(self.webpackChunkAVPlayer=self.webpackChunkAVPlayer||[]).push([[717],{8469:(t,e,i)=>{i.d(e,{En:()=>n,Ij:()=>h,XC:()=>o,hY:()=>a});var r=i(7231);const s={96e3:0,88200:1,64e3:2,48e3:3,44100:4,32e3:5,24e3:6,22050:7,16e3:8,12e3:9,11025:10,8e3:11,7350:12},a=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350,r.N_,r.N_,r.N_],n=[r.N_,1,2,3,4,5,6,7];function o(t,e){if(!e&&t.sideData[1]&&(e=t.sideData[1]),e){const{profile:i,sampleRate:s,channels:o}=function(t){let e=r.N_,i=r.N_,s=r.N_;var o,h;return t.length>=2&&(e=t[0]>>3&31,i=null!==(o=a[(7&t[0])<<1|t[1]>>7])&&void 0!==o?o:48e3,s=null!==(h=n[t[1]>>3&15])&&void 0!==h?h:2),{profile:e,sampleRate:i,channels:s}}(e);t.codecpar.profile=i,t.codecpar.sampleRate=s,t.codecpar.chLayout.nbChannels=o,t.codecpar.channels=o}}function h(t){const e=s[t.sampleRate],i=t.chLayout.nbChannels,r=new Uint8Array(2);return r[0]=(31&t.profile)<<3|(14&e)>>1,r[1]=(1&e)<<7|(15&i)<<3,r}},412:(t,e,i)=>{i.d(e,{Ui:()=>a,XC:()=>s});var r=i(7246);function s(t,e){if(!e&&t.sideData[1]&&(e=t.sideData[1]),e&&e.length>=4){const i=a(e);t.codecpar.profile=i.profile,t.codecpar.level=i.level}}function a(t){const e=new r.A(t.length);e.appendBuffer(t),e.readU1(),e.readU(7);const i=e.readU(3),s=e.readU(5),a=e.readU1();let n=e.readU1()?10:8;return e.readU1()&&(n=12),{profile:i,level:s,tier:a,bitDepth:n,monochrome:e.readU1(),chromaSubsamplingX:e.readU1(),chromaSubsamplingY:e.readU1(),chromaSamplePosition:e.readU(2)}}},620:(t,e,i)=>{i.d(e,{Jk:()=>m,XC:()=>I,ci:()=>k,oT:()=>b});var r=i(3939),s=i(932),a=i(2739),n=i(729),o=i(1865),h=i(7246),d=i(4624),f=i(4686),l=i(1517),c=i(264),u=i(7837),p=i(3991),g="src/avformat/codecs/h264.ts";const w=3;function U(t,e,i=[]){t.length>32&&(d.R8(`h264 metadata's sps max length is 32, but get ${t.length}`,g,159),t=t.slice(0,32)),t.length>256&&(d.R8(`h264 metadata's pps max length is 256, but get ${t.length}`,g,163),t=t.slice(0,256));let r=7;r=t.reduce(((t,e)=>t+2+e.length),r),r=e.reduce(((t,e)=>t+2+e.length),r);const s=t[0],o=B(s);66!==o.profile&&77!==o.profile&&88!==o.profile&&(r+=4,i.length&&(r=i.reduce(((t,e)=>t+2+e.length),r)));const h=new Uint8Array(r),f=new n.A(h);return f.writeUint8(1),f.writeUint8(s[1]),f.writeUint8(s[2]),f.writeUint8(s[3]),f.writeUint8(252|w),f.writeUint8(224|31&t.length),a.__(t,(t=>{f.writeUint16(t.length),f.writeBuffer(t)})),f.writeUint8(e.length),a.__(e,(t=>{f.writeUint16(t.length),f.writeBuffer(t)})),66!==o.profile&&77!==o.profile&&88!==o.profile&&(f.writeUint8(252|o.chromaFormatIdc),f.writeUint8(248|o.bitDepthLumaMinus8),f.writeUint8(248|o.bitDepthChromaMinus8),i.length&&a.__(i,(t=>{f.writeUint16(t.length),f.writeBuffer(t)}))),h}function b(t){let e,i=(0,c.py)(t),r=!1;if(i.length>1){const t=[],r=[],s=[];i.forEach((e=>{const i=31&e[0];7===i?t.push(e):8===i?r.push(e):13===i&&s.push(e)})),t.length&&r.length&&(e=U(t,r,s)),i=i.filter((t=>{const e=31&t[0];return 9!==e&&8!==e&&7!==e&&13!==e}))}const s=i.reduce(((t,e)=>t+w+1+e.length),0),o=(0,u.sY)(s),h=(0,f.s3)(o,s),d=new n.A(h);return a.__(i,(t=>{3===w?d.writeUint32(t.length):2===w?d.writeUint24(t.length):1===w?d.writeUint16(t.length):d.writeUint8(t.length),d.writeBuffer(t.subarray(0)),5==(31&t[0])&&(r=!0)})),{bufferPointer:o,length:s,key:r,extradata:e}}function m(t,e){var i;if(!(1&r.f[15](t+36)))return;const s=(0,l.iI)(t);if((0,c.Bs)(s))return;const a=null!==(i=e.metadata.naluLengthSizeMinusOne)&&void 0!==i?i:w;let n=[],h=[],d=[],p=[];const g=new o.A(s);for(;g.remainingSize()>0;){let t=0;t=3===a?g.readUint32():2===a?g.readUint24():1===a?g.readUint16():g.readUint8();const e=s.subarray(0|Number(0xffffffffn&g.getPos()),(0|Number(0xffffffffn&g.getPos()))+t);g.skip(t);const i=31&e[0];7===i?n.push(e):8===i?h.push(e):13===i?d.push(e):p.push(e)}if(n.length||h.length){const e=U(n,h,d),i=(0,u.sY)(e.length);(0,f.lW)(i,e.length,e),(0,l.Ow)(t,1,i,e.length)}}function k(t,e=!1){if(!(1&r.f[15](t+36)||e))return;const i=(0,l.iI)(t);if(!(0,c.Bs)(i))return;let a=(0,c.py)(i);if(a.length>1){const e=[],i=[],n=[];if(a.forEach((t=>{const r=31&t[0];7===r?e.push(t):8===r?i.push(t):13===r&&n.push(t)})),e.length&&i.length){const a=U(e,i,n),o=(0,u.sY)(a.length);(0,f.lW)(o,a.length,a),(0,l.Ow)(t,1,o,a.length),s.M[15](t+36,1|r.f[15](t+36))}}}function I(t,e){if(!e&&t.sideData[1]&&(e=t.sideData[1]),e&&e.length>=6){t.metadata.naluLengthSizeMinusOne=3&e[4];const{spss:i}=function(t){const e=new o.A(t);e.skip(5);const i=[],r=[],s=[],a=31&e.readUint8();for(let t=0;t<a;t++){const t=e.readUint16();i.push(e.readBuffer(t))}const n=e.readUint8();for(let t=0;t<n;t++){const t=e.readUint16();r.push(e.readBuffer(t))}if(e.remainingSize()>4){e.skip(3);const t=e.readUint8();if(t>0)for(let i=0;i<t;i++){const t=e.readUint16();s.push(e.readBuffer(t))}}return{spss:i,ppss:r,spsExts:s}}(e);if(i.length){const{profile:e,level:r,width:s,height:a}=B(i[0]);t.codecpar.profile=e,t.codecpar.level=r,t.codecpar.width=s,t.codecpar.height=a}}}function B(t){if(!t||t.length<3)return;let e=0;0===t[0]&&0===t[1]&&0===t[2]&&1===t[3]&&(e=4);const i=(0,c.BN)(t.subarray(e)),r=new h.A(i.length);r.appendBuffer(i),r.readU1(),r.readU(2),r.readU(5);const s=r.readU(8);r.readU1(),r.readU1(),r.readU1(),r.readU1(),r.readU1(),r.readU1(),r.readU(2);const a=r.readU(8);p.xb(r);let n=1,o=0,d=0;if((100==s||110==s||122==s||244==s||44==s||83==s||86==s||118==s||128==s||138==s||139==s||134==s||135==s)&&(n=p.xb(r),3===n&&r.readU1(),o=p.xb(r),d=p.xb(r),r.readU1(),r.readU1())){const t=new Array(8);for(let e=0;e<(3!=n?8:12);e++)t[e]=r.readU1()}p.xb(r);const f=p.xb(r);if(0===f)p.xb(r);else if(1===f){r.readU1(),p.$x(r),p.$x(r);const t=p.xb(r);for(let e=0;e<t;e++)p.$x(r)}p.xb(r),r.readU1();const l=p.xb(r),u=p.xb(r),g=r.readU1();let w=16*(l+1),U=(2-g)*(u+1)*16;g||r.readU1(),r.readU1();const b=r.readU1();if(b){let t=1,e=2-b;1===n?(t=2,e=2*(2-b)):2===b&&(t=2,e=2-b),w-=t*(p.xb(r)+p.xb(r)),U-=e*(p.xb(r)+p.xb(r))}return{profile:s,level:a,width:w,height:U,chromaFormatIdc:n,bitDepthLumaMinus8:o,bitDepthChromaMinus8:d}}},3e3:(t,e,i)=>{i.d(e,{Jk:()=>U,XC:()=>m,ci:()=>b,oT:()=>w});var r=i(3939),s=i(932),a=i(2739),n=i(729),o=i(1865),h=i(7246),d=i(4686),f=i(264),l=i(1517),c=i(7837),u=i(3991);const p=3;function g(t,e,i){const r=e[0];let s=23;t.length&&(s+=3,s=t.reduce(((t,e)=>t+2+e.length),s)),e.length&&(s+=3,s=e.reduce(((t,e)=>t+2+e.length),s)),i.length&&(s+=3,s=i.reduce(((t,e)=>t+2+e.length),s));const o=new Uint8Array(s),h=new n.A(o,!0),d=k(r);h.writeUint8(1),h.writeUint8(r[1]),h.writeUint8(r[2]),h.writeUint8(r[3]),h.writeUint8(r[4]),h.writeUint8(r[5]),h.writeUint8(r[6]),h.writeUint8(r[7]),h.writeUint8(r[8]),h.writeUint8(r[9]),h.writeUint8(r[10]),h.writeUint8(r[11]),h.writeUint8(d.level),h.writeUint8(1020),h.writeUint8(0),h.writeUint8(16320),h.writeUint8(16320|d.chromaFormatIdc),h.writeUint8(8160|d.bitDepthLumaMinus8),h.writeUint8(8160|d.bitDepthChromaMinus8),h.writeUint16(0),h.writeUint8(8|(1&r[0])<<2|p);let f=0;return t.length&&f++,e.length&&f++,i.length&&f++,h.writeUint8(f),t.length&&(h.writeUint8(160),h.writeUint16(t.length),a.__(t,(t=>{h.writeUint16(t.length),h.writeBuffer(t)}))),e.length&&(h.writeUint8(161),h.writeUint16(e.length),a.__(e,(t=>{h.writeUint16(t.length),h.writeBuffer(t)}))),i.length&&(h.writeUint8(162),h.writeUint16(i.length),a.__(i,(t=>{h.writeUint16(t.length),h.writeBuffer(t)}))),o}function w(t){let e,i=!1,r=(0,f.py)(t);if(r.length>2){const t=[],i=[],s=[];r.forEach((e=>{const r=e[0]>>>1&63;32===r?t.push(e):33===r?i.push(e):34===r&&s.push(e)})),t.length&&i.length&&s.length&&(e=g(t,i,s),r=r.filter((t=>{const e=t[0]>>>1&63;return 32!==e&&33!==e&&34!==e&&35!==e})))}const s=r.reduce(((t,e)=>t+p+1+e.length),0),o=(0,c.sY)(s),h=(0,d.s3)(o,s),l=new n.A(h);return a.__(r,(t=>{3===p?l.writeUint32(t.length):2===p?l.writeUint24(t.length):1===p?l.writeUint16(t.length):l.writeUint8(t.length),l.writeBuffer(t.subarray(0));const e=t[0]>>>1&63;19!==e&&20!==e&&21!==e||(i=!0)})),{bufferPointer:o,length:s,extradata:e,key:i}}function U(t,e){var i;if(!(1&r.f[15](t+36)))return;const s=(0,l.iI)(t);if((0,f.Bs)(s))return;const a=null!==(i=e.metadata.naluLengthSizeMinusOne)&&void 0!==i?i:p;let n=[],h=[],u=[];const w=new o.A(s);for(;w.remainingSize()>0;){let t=0;t=3===a?w.readUint32():2===a?w.readUint24():1===a?w.readUint16():w.readUint8();const e=s.subarray(0|Number(0xffffffffn&w.getPos()),(0|Number(0xffffffffn&w.getPos()))+t);w.skip(t);const i=e[0]>>>1&63;33===i?h.push(e):34===i?u.push(e):32===i&&n.push(e)}if(h.length||u.length||n.length){const e=g(n,h,u),i=(0,c.sY)(e.length);(0,d.lW)(i,e.length,e),(0,l.Ow)(t,1,i,e.length)}}function b(t,e=!1){if(!(1&r.f[15](t+36)||e))return;const i=(0,l.iI)(t);if(!(0,f.Bs)(i))return;let a=(0,f.py)(i);if(a.length>2){const e=[],i=[],n=[];if(a.forEach((t=>{const r=t[0]>>>1&63;32===r?e.push(t):33===r?i.push(t):34===r&&n.push(t)})),e.length&&i.length&&n.length){const a=g(e,i,n),o=(0,c.sY)(a.length);(0,d.lW)(o,a.length,a),(0,l.Ow)(t,1,o,a.length),s.M[15](t+36,1|r.f[15](t+36))}}}function m(t,e){if(!e&&t.sideData[1]&&(e=t.sideData[1]),e&&e.length>=6){t.metadata.naluLengthSizeMinusOne=3&e[21];const{spss:i}=function(t){const e=new o.A(t,!0);e.skip(22);let i=[],r=[],s=[];const a=e.readUint8();for(let t=0;t<a;t++){const t=63&e.readUint8(),a=e.readUint16(),n=[];for(let t=0;t<a;t++){const t=e.readUint16();n.push(e.readBuffer(t))}32===t?i=n:33===t?r=n:34===t&&(s=n)}return{vpss:i,spss:r,ppss:s}}(e);if(i.length){const{profile:e,level:r,width:s,height:a}=k(i[0]);t.codecpar.profile=e,t.codecpar.level=r,t.codecpar.width=s,t.codecpar.height=a}}}function k(t){if(!t||t.length<3)return;let e=0;0===t[0]&&0===t[1]&&0===t[2]&&1===t[3]&&(e=4);let i=0,r=0,s=0,a=0,n=0,o=0,d=1,l=0,c=0,p=0,g=0;const w=(0,f.BN)(t.subarray(e)),U=new h.A(w.length);U.appendBuffer(w),U.readU1(),U.readU(6),U.readU(6),U.readU(3),U.readU(4);const b=U.readU(3);if(U.readU1(),b<=6){l=U.readU(2),c=U.readU1(),i=U.readU(5),p=U.readU(32),g=U.readU(48),r=U.readU(8);const t=new Array(6),e=new Array(6);for(let i=0;i<b;i++)t[i]=U.readU1(),e[i]=U.readU1();if(b>0)for(let t=b;t<8;t++)U.readU(2);for(let i=0;i<b;i++)t[i]&&(U.readU(2),U.readU(1),U.readU(5),U.readU(32),U.readU(1),U.readU(1),U.readU(1),U.readU(1),U.readU(44)),e[i]&&U.readU(8);u.xb(U),d=u.xb(U),3===d&&U.readU(1),s=u.xb(U),a=u.xb(U);let h=0,f=0,w=0,m=0;U.readU1()&&(h=u.xb(U),f=u.xb(U),w=u.xb(U),m=u.xb(U)),n=u.xb(U),o=u.xb(U);let k=2,I=2;0===d?k=I=0:2===d?(k=2,I=1):3===d&&(k=I=1),s-=k*(1<<n+1)*(h+f),a-=I*(1<<n+1)*(w+m)}return{profile:i,level:r,width:s,height:a,chromaFormatIdc:d,bitDepthLumaMinus8:n,bitDepthChromaMinus8:o,generalProfileSpace:l,generalTierFlag:c,generalProfileCompatibilityFlag:p,constraintFlags:g}}},8919:(t,e,i)=>{i.d(e,{U:()=>a,X:()=>s});var r=i(7246);function s(t,e){if(!e&&t.sideData[1]&&(e=t.sideData[1]),e&&e.length>=6){const i=a(e);t.codecpar.profile=i.profile,t.codecpar.level=i.level}}function a(t){const e=new r.A(t.length);return e.appendBuffer(t.subarray(4)),{profile:e.readU(8),level:e.readU(8),bitDepth:e.readU(4),chromaSubsampling:e.readU(3),fullRangeFlag:e.readU1(),colorPrimaries:e.readU(8),colorTrc:e.readU(8),colorSpace:e.readU(8)}}},681:(t,e,i)=>{i.r(e),i.d(e,{default:()=>x});var r=i(1026),s=i(3939),a=i(932);class n{constructor(){(0,r.A)(this,"signature",void 0),(0,r.A)(this,"version",void 0),(0,r.A)(this,"flags",void 0),(0,r.A)(this,"dataOffset",void 0),(0,r.A)(this,"hasVideo",void 0),(0,r.A)(this,"hasAudio",void 0),this.signature="FLV",this.version=1,this.flags=0,this.dataOffset=9,this.hasAudio=!1,this.hasVideo=!1}async read(t){this.signature=await t.readString(3),this.version=await t.readUint8(),this.flags=await t.readUint8(),this.dataOffset=await t.readUint32(),this.hasAudio=!!(4&this.flags),this.hasVideo=!!(1&this.flags)}write(t){this.flags=0,this.hasAudio&&(this.flags|=4),this.hasVideo&&(this.flags|=1),t.writeString(this.signature),t.writeUint8(this.version),t.writeUint8(this.flags),t.writeUint32(this.dataOffset)}}var o=i(5336),h=i(7672),d=i(2739),f=i(5335),l=i(2647),c=i(4624),u=i(9705);class p{constructor(){(0,r.A)(this,"onMetaData",void 0),this.onMetaData={audiocodecid:10,canSeekToEnd:!1,width:0,height:0,stereo:!0,videocodecid:7}}async parseObject(t,e){return{key:await t.readString(await t.readUint16()),value:await this.parseValue(t,e)}}async parseValue(t,e){let i;switch(await t.readUint8()){case 0:i=await t.readDouble();break;case 1:i=!!await t.readUint8();break;case 2:i=await t.readString(await t.readUint16());break;case 3:for(i={};t.getPos()<e;){const{key:r,value:s}=await this.parseObject(t,e);if(i[r]=s,9==(16777215&await t.peekUint24())){await t.skip(3);break}}break;case 8:for(i={},t.skip(4);t.getPos()<e;){const{key:r,value:s}=await this.parseObject(t,e);if(i[r]=s,9==(16777215&await t.peekUint24())){t.skip(3);break}}break;case 9:i=null;break;case 10:i=[];const r=await t.readUint32();for(let s=0;s<r;s++)i.push(await this.parseValue(t,e));break;case 11:const s=await t.readDouble(),a=await t.readInt16();i=new Date(s+60*a*1e3);break;case 12:i=await t.readString(await t.readUint32())}return i}async read(t,e){const i=t.getPos(),r=i+BigInt(Math.floor(e)),s=await this.parseValue(t,r),a=await this.parseValue(t,r);this[s]=a;const n=Number(t.getPos()-i),o=await t.readUint32();return n+11!==o?(c.R8(`script size not match, size: ${n+11}, previousTagSize: ${o}`,"src/avformat/formats/flv/FlvScriptTag.ts",150),u.LR):0}writeValue(t,e){h.ai(e)?(t.writeUint8(0),t.writeDouble(e)):h.o(e)?(t.writeUint8(0),t.writeDouble(Number(e))):h.zM(e)?(t.writeUint8(1),t.writeUint8(e?1:0)):h.Yj(e)?e.length>=65536?(t.writeUint8(12),t.writeUint32(e.length),t.writeString(e)):(t.writeUint8(2),t.writeUint16(e.length),t.writeString(e)):h.YO(e)?(t.writeUint8(10),t.writeUint32(e.length),d.__(e,(e=>{this.writeValue(t,e)}))):h.Ik(e)?(t.writeUint8(3),f.__(e,((e,i)=>{t.writeUint16(i.length),t.writeString(i),this.writeValue(t,e)})),t.writeUint24(9)):e instanceof Date&&(t.writeUint8(11),t.writeDouble(e.getTime()),t.writeInt16(0))}computeSize(){const t=[],e=new o.A;return e.onFlush=e=>(t.push(e.slice()),0),this.writeValue(e,"onMetaData"),this.writeValue(e,this.onMetaData),e.flush(),(0,l.A)(Uint8Array,t).length}write(t){if(this.onMetaData){const e=[],i=new o.A;i.onFlush=t=>(e.push(t.slice()),0),this.writeValue(i,"onMetaData"),this.writeValue(i,this.onMetaData),i.flush();const r=(0,l.A)(Uint8Array,e),s=t.getPos();!function(t,e,i,r){t.writeUint8(18),t.writeUint24(i),t.writeUint24(Number(r&BigInt(16777215))),t.writeUint8(Number(r>>BigInt(24)&BigInt(255))),t.writeUint24(0)}(t,0,r.length,BigInt(0)),t.writeBuffer(r),t.writeUint32(Number(t.getPos()-s))}}dts2Position(t){if(this.canSeek()){let e=-1;const i=this.onMetaData.keyframes.times,r=this.onMetaData.keyframes.filepositions;let s;for(s=0;s<i.length;s++){if(i[s]===t){e=s;break}if(i[s]>t){e=Math.max(s-1,0);break}}return s&&s===i.length&&(e=i.length-1),{pos:r[e],dts:i[e]}}return{pos:-1,dts:-1}}position2DTS(t){if(this.canSeek()){let i=-1;const r=this.onMetaData.keyframes.times,s=this.onMetaData.keyframes.filepositions;let a=0;for(a=0;a<s.length;a++)if(s[a]>t){i=a;break}var e;return a===s.length?null!==(e=this.onMetaData.duration)&&void 0!==e?e:r[r.length-1]:r[i]}return-1}canSeek(){return!!(this.onMetaData.keyframes&&this.onMetaData.keyframes.filepositions&&this.onMetaData.keyframes.filepositions.length)}}const g={10:86018,2:86017,11:86051},w={7:27,12:173,9:12};var U=i(620),b=i(8469),m=i(3e3),k=i(412),I=i(8919),B=i(5947),A=i(4686),y=i(7837),v=i(1517),R=i(5977),M=i(4328),P=i(7231),D=i(7550),S="src/avformat/formats/IFlvFormat.ts";class x extends B.A{constructor(t={}){super(),(0,r.A)(this,"type",0),(0,r.A)(this,"header",void 0),(0,r.A)(this,"script",void 0),(0,r.A)(this,"options",void 0),(0,r.A)(this,"firstTagPos",void 0),this.header=new n,this.script=new p,this.options=t}init(t){t.ioReader&&t.ioReader.setEndian(!0)}async readHeader(t){try{if("FLV"!==await t.ioReader.peekString(3))return c.z3("the file format is not flv",S,98),u.LR;await this.header.read(t.ioReader),0!==await t.ioReader.readUint32()&&c.R8("the previousTagSize0 is not 0",S,105);let e=0;if(18===await t.ioReader.peekUint8()){await t.ioReader.skip(1);const i=await t.ioReader.readUint24();await t.ioReader.skip(7),e=await this.script.read(t.ioReader,i)}return e>=0&&(this.firstTagPos=t.ioReader.getPos()),e}catch(e){return c.z3(e.message,S,123),t.ioReader.error}}async readCodecConfigurationRecord(t,e,i){const r=(0,y.sY)(i);e.codecpar.extradata=r,e.codecpar.extradataSize=i,await t.ioReader.readBuffer(i,(0,A.JW)(r,i)),e.sideData[1]=(0,A.s3)(r,i).slice(),27===e.codecpar.codecId||12===e.codecpar.codecId?U.XC(e):173===e.codecpar.codecId?m.XC(e):226===e.codecpar.codecId?k.XC(e):167===e.codecpar.codecId&&I.X(e)}async readAVPacketData(t,e,i,r){const s=(0,y.sY)(r);(0,v.NX)(i,s,r),await t.ioReader.readBuffer(r,(0,A.JW)(s,r)),27===e.codecpar.codecId?(U.Jk(i,e),a.M[15](i+80,1)):173===e.codecpar.codecId&&(m.Jk(i,e),a.M[15](i+80,1))}async readAVPacket_(t,e){const i=t.ioReader.getPos();a.M[17](e+56,i);const r=await t.ioReader.readUint8(),n=await t.ioReader.readUint24();let o=await t.ioReader.readUint24();const h=await t.ioReader.readUint8();if(h&&(o|=h<<24),a.M[17](e+16,BigInt(Math.floor(o))),a.M[17](e+8,BigInt(Math.floor(o))),await t.ioReader.skip(3),8===r){let i=t.getStreamByMediaType(1);i&&a.M[15](e+32,i.index);const r=await t.ioReader.readUint8();if(i)if(86018===i.codecpar.codecId){if(0===await t.ioReader.readUint8()){const i=n-2,r=(0,y.sY)(i);(0,v.Ow)(e,1,r,i),await t.ioReader.readBuffer(i,(0,A.JW)(r,i))}else await this.readAVPacketData(t,i,e,n-2);a.M[15](e+36,1|s.f[15](e+36))}else await this.readAVPacketData(t,i,e,n-1);else{if(i=t.createStream(),a.M[15](e+32,i.index),i.codecpar.codecType=1,i.timeBase.den=1e3,i.timeBase.num=1,i.startTime=s.f[17](e+8)||s.f[17](e+16),this.script.onMetaData.duration&&(i.duration=BigInt(Math.floor(1e3*this.script.onMetaData.duration))),i.codecpar.chLayout.nbChannels=1&~r?1:2,i.codecpar.channels=1&~r?1:2,i.codecpar.sampleRate=44100<<((12&r)>>>2)>>3,i.codecpar.bitsPerCodedSample=2&r?16:8,i.codecpar.codecId=g[(240&r)>>4],86018===i.codecpar.codecId){if(0===await t.ioReader.readUint8()){const e=n-2,r=(0,y.sY)(e);i.codecpar.extradata=r,i.codecpar.extradataSize=e,await t.ioReader.readBuffer(e,(0,A.JW)(r,e)),i.sideData[1]=(0,A.s3)(r,e).slice(),b.XC(i)}else await this.readAVPacketData(t,i,e,n-2);a.M[15](e+36,1|s.f[15](e+36))}else 86051===i.codecpar.codecId?(i.codecpar.sampleRate=16e3,i.codecpar.chLayout.nbChannels=1,i.codecpar.channels=1,await this.readAVPacketData(t,i,e,n-1)):await this.readAVPacketData(t,i,e,n-1);this.onStreamAdd&&this.onStreamAdd(i)}}else if(9===r){let i=t.getStreamByMediaType(0);i&&a.M[15](e+32,i.index);const r=await t.ioReader.readUint8();if(i)if((112&r)>>4==1&&a.M[15](e+36,1|s.f[15](e+36)),128&r){await t.ioReader.skip(4);const o=15&r;if(173===i.codecpar.codecId&&a.M[15](e+80,1),0===o){const i=n-5,r=(0,y.sY)(i);(0,v.Ow)(e,1,r,i),await t.ioReader.readBuffer(i,(0,A.JW)(r,i))}else if(2===o)a.M[15](e+36,32|s.f[15](e+36));else if(1===o||3===o)if(1===o&&173===i.codecpar.codecId){const r=await t.ioReader.readUint24();a.M[17](e+8,s.f[17](e+16)+BigInt(Math.floor(r))),await this.readAVPacketData(t,i,e,n-8)}else await this.readAVPacketData(t,i,e,n-5)}else if(27===i.codecpar.codecId||173===i.codecpar.codecId||12===i.codecpar.codecId){a.M[15](e+80,1);const r=await t.ioReader.readUint8(),o=await t.ioReader.readUint24();if(a.M[17](e+8,s.f[17](e+16)+BigInt(Math.floor(o))),0===r){const i=n-5,r=(0,y.sY)(i);(0,v.Ow)(e,1,r,i),await t.ioReader.readBuffer(i,(0,A.JW)(r,i))}else 2===r?a.M[15](e+36,32|s.f[15](e+36)):await this.readAVPacketData(t,i,e,n-5)}else await this.readAVPacketData(t,i,e,n-1);else{if(i=t.createStream(),a.M[15](e+32,i.index),i.codecpar.codecType=0,i.timeBase.den=1e3,i.timeBase.num=1,i.startTime=s.f[17](e+8)||s.f[17](e+16),this.script.onMetaData.duration&&(i.duration=BigInt(Math.floor(1e3*this.script.onMetaData.duration))),this.script.onMetaData.width>0&&(i.codecpar.width=this.script.onMetaData.width),this.script.onMetaData.height>0&&(i.codecpar.height=this.script.onMetaData.height),(112&r)>>4==1&&a.M[15](e+36,1|s.f[15](e+36)),128&r){const o=await t.ioReader.readUint32();o===(0,R.A)("hvc1")?(i.codecpar.codecId=173,a.M[15](e+80,1)):o===(0,R.A)("av01")?i.codecpar.codecId=226:o===(0,R.A)("vp09")&&(i.codecpar.codecId=167);const h=15&r;if(0===h)await this.readCodecConfigurationRecord(t,i,n-5);else if(2===h)a.M[15](e+36,32|s.f[15](e+36));else if(1===h||3===h)if(1===h&&173===i.codecpar.codecId){const r=await t.ioReader.readUint24();a.M[17](e+8,s.f[17](e+16)+BigInt(Math.floor(r))),await this.readAVPacketData(t,i,e,n-8)}else await this.readAVPacketData(t,i,e,n-5)}else if(i.codecpar.codecId=w[15&r],27===i.codecpar.codecId||173===i.codecpar.codecId||12===i.codecpar.codecId){a.M[15](e+80,1);const r=await t.ioReader.readUint8(),o=await t.ioReader.readUint24();a.M[17](e+8,s.f[17](e+16)+BigInt(Math.floor(o))),0===r?await this.readCodecConfigurationRecord(t,i,n-5):2===r?a.M[15](e+36,32|s.f[15](e+36)):await this.readAVPacketData(t,i,e,n-5)}else await this.readAVPacketData(t,i,e,n-1);this.onStreamAdd&&this.onStreamAdd(i)}}else if(18===r){let i=await this.script.read(t.ioReader,n);return i<0?i:await this.readAVPacket_(t,e)}const d=t.ioReader.getPos()-i,f=BigInt(Math.floor(await t.ioReader.readUint32()));return d!==f?(c.R8(`tag ${r} size not match, size: ${d}, previousTagSize: ${f}`,S,435),u.LR):0}async readAVPacket(t,e){try{return a.M[15](e+76,1e3),a.M[15](e+72,1),await this.readAVPacket_(t,e)}catch(e){return-1048576!==t.ioReader.error&&c.z3(e.message,S,451),t.ioReader.error}}async syncTag(t){let e=P.Dh;for(;;)try{const i=await t.ioReader.readUint8();if(8===i||9===i){e=t.ioReader.getPos()-BigInt(1);const i=await t.ioReader.readUint24();if(i>10485760){await t.ioReader.seek(e+BigInt(1));continue}await t.ioReader.skip(7+i);if(t.ioReader.getPos()-e!==BigInt(Math.floor(await t.ioReader.readUint32()))){await t.ioReader.seek(e+BigInt(1)),e=P.Dh;continue}{let i=0;for(;i<=3;){const e=t.ioReader.getPos(),r=await t.ioReader.readUint8();if(8!==r&&9!==r&&18!==r)break;{const r=await t.ioReader.readUint24();await t.ioReader.skip(7+r);if(t.ioReader.getPos()-e!==BigInt(Math.floor(await t.ioReader.readUint32())))break;i++}}if(!(i<3))break;await t.ioReader.seek(e+BigInt(1)),e=P.Dh}}}catch(t){break}e!==P.Dh&&await t.ioReader.seek(e)}async seek(t,e,i,r){const s=t.ioReader.getPos();if(e&&e.sampleIndexes.length){let r=d.El(e.sampleIndexes,(t=>t.pts>i?-1:1));if(r>0&&(0,M.k)(i-e.sampleIndexes[r-1].pts,e.timeBase,P.i0)<BigInt(1e4))return c.Yz(`seek in sampleIndexes, found index: ${r}, pts: ${e.sampleIndexes[r-1].pts}, pos: ${e.sampleIndexes[r-1].pos}`,S,541),await t.ioReader.seek(e.sampleIndexes[r-1].pos),s}if(this.script.canSeek()){const{pos:r,dts:a}=this.script.dts2Position(Number((0,M.k)(i,e.timeBase,P.i0)/BigInt(1e3)));if(r>0)return c.Yz(`seek in filepositions, found pts: ${a}, pos: ${r}`,S,550),await t.ioReader.seek(BigInt(Math.floor(r))),s}return 2&r?(await t.ioReader.seek(i),4&r||await this.syncTag(t),s):(c.Yz("not found any keyframe index, try to seek in bytes",S,563),(0,D.A)(t,e,i,this.firstTagPos,this.readAVPacket.bind(this),this.syncTag.bind(this)))}getAnalyzeStreamsCount(){let t=0;return this.header.hasAudio&&t++,this.header.hasVideo&&t++,t}}},5947:(t,e,i)=>{i.d(e,{A:()=>s});var r=i(1026);class s{constructor(){(0,r.A)(this,"type",-1),(0,r.A)(this,"onStreamAdd",void 0)}destroy(t){}}},5977:(t,e,i)=>{i.d(e,{A:()=>a});var r=i(4624),s="src/avformat/function/mktag.ts";function a(t){4!==t.length&&r.R8(`tag length is not 4, tag: ${t}`,s,30);let e=0;for(let i=0;i<4;i++)e=e<<8|t.charCodeAt(i);return e}},7550:(t,e,i)=>{i.d(e,{A:()=>p});var r=i(3939),s=i(9599),a=i(915),n=i(7231),o=i(4328),h=i(2739);function d(t,e,i){let r=BigInt(0);return h.__(t,(t=>{r+=t.codecpar.bitRate*(0,o.k)(e,i,n.i0)/BigInt(8e3)})),r}var f=i(1517),l=i(9705),c=i(4624),u="src/avformat/function/seekInBytes.ts";async function p(t,e,i,h,p,g){const w=t.ioReader.getPos(),U=await t.ioReader.fileSize();let b=n.Dh,m=i;e.startTime!==n.Dh?m-=e.startTime:m-=e.firstDTS;const k=(0,o.k)(i,e.timeBase,n.i0);if(k<BigInt(1e4))return c.Yz(`seek pts is earlier then 10s, seek to first packet pos(${h}) directly`,u,63),await t.ioReader.seek(h),w;let I=d(t.streams,m,e.timeBase);const B=U-d(t.streams,BigInt(5e3),n.i0),A=d(t.streams,BigInt(1e4),n.i0);if(I>B&&(I=B),I<h)return await t.ioReader.seek(h),w;const y=(0,f._5)();let v=U,R=BigInt(0);for(;;){if(v-R<A){b=R;break}await t.ioReader.seek(I),await g(t);const e=t.ioReader.getPos();if(!(await p(t,y)>=0))break;{const t=(0,o.k)(r.f[17](y+8),(0,a.A)(y+72,s.P),n.i0),i=t-k;if(c.Yz(`try to seek to pos: ${I}, got packet pts: ${r.f[17](y+8)}(${t}ms), diff: ${i}ms`,u,98),i<=BigInt(0)&&-i<BigInt(1e4)){b=e;break}i>BigInt(0)?(v=I,I=R+v>>BigInt(1)):(R=I,I=R+v>>BigInt(1))}}return(0,f.Qe)(y),b!==n.Dh?(c.Yz(`finally seek to pos ${b}`,u,124),await t.ioReader.seek(b),await g(t),w):(await t.ioReader.seek(w),BigInt(l.E$))}},null:()=>{},3991:(t,e,i)=>{function r(t){let e=0,i=0;for(;i<32&&0===t.readU1();)i++;return e=t.readU(i),e+=(1<<i)-1,e}function s(t){let e=r(t);return e=1&e?(e+1)/2:-e/2,e}i.d(e,{$x:()=>s,xb:()=>r})},264:(t,e,i)=>{function r(t){return t.length>4&&0===t[0]&&0===t[1]&&(1===t[2]||0===t[2]&&1===t[3])}function s(t,e){let i=0;for(let r=e;r<t.length;r++)switch(t[r]){case 0:i++;break;case 1:if(i>=2)return{offset:r-Math.min(i,3),startCode:Math.min(i+1,4)};i=0;break;default:i=0}return{offset:-1,startCode:0}}function a(t){const e=[];let i=s(t,0),r={offset:-1,startCode:0};for(;r=s(t,i.offset+i.startCode),r.offset>-1;)e.push(t.subarray(i.offset+i.startCode,r.offset,!0)),i=r;return e.push(t.subarray(i.offset+i.startCode,void 0,!0)),e}function n(t,e=0,i){i||(i=t.length);const r=new Uint8Array(t.length);let s=0,a=0;for(let n=0;n<t.length;n++){if(n>=e&&n<i)if(0===t[n])s++;else if(3===t[n]&&2===s&&n+1<t.length&&t[n+1]<=3){if(n++,n===t.length)break;s=0===t[n]?1:0}else s=0;r[a++]=t[n]}return r.slice(0,a)}i.d(e,{BN:()=>n,Bs:()=>r,py:()=>a})},7246:(t,e,i)=>{i.d(e,{A:()=>a});var r=i(1026),s=i(4624);class a{constructor(t=1048576){(0,r.A)(this,"buffer",void 0),(0,r.A)(this,"pointer",void 0),(0,r.A)(this,"bitsLeft",void 0),(0,r.A)(this,"size",void 0),(0,r.A)(this,"endPointer",void 0),(0,r.A)(this,"error",void 0),(0,r.A)(this,"onFlush",void 0),this.pointer=0,this.bitsLeft=8,this.size=t,this.endPointer=0,this.error=0,this.buffer=new Uint8Array(this.size)}peekU1(){let t=0;(this.remainingLength()<1||1===this.remainingLength()&&0===this.bitsLeft)&&this.flush();let e=this.pointer,i=this.bitsLeft;return 0===i&&(e++,i=8),t=this.buffer[e]>>i-1&1,t}readU1(){let t=0;return(this.remainingLength()<1||1===this.remainingLength()&&0===this.bitsLeft)&&this.flush(),this.bitsLeft--,t=this.buffer[this.pointer]>>this.bitsLeft&1,0===this.bitsLeft&&(this.pointer++,this.bitsLeft=8),t}readU(t){let e=0;for(let i=0;i<t;i++)e|=this.readU1()<<t-i-1;return e}remainingLength(){return this.endPointer-this.pointer}flush(){if(!this.onFlush)throw this.error=-1048574,Error("IOReader error, flush failed because of no flush callback");if(0===this.bitsLeft&&this.pointer++,!(this.size-this.remainingLength()<=0))if(this.pointer<this.endPointer){this.buffer.set(this.buffer.subarray(this.pointer,this.endPointer),0);const t=this.onFlush(this.buffer.subarray(this.endPointer-this.pointer,this.size));if(t<0)throw this.error=t,Error("IOReader error, flush failed");this.endPointer=this.endPointer-this.pointer+t,this.pointer=0}else{const t=this.onFlush(this.buffer);if(this.endPointer=t,this.pointer=0,this.bitsLeft=8,t<0)throw this.error=t,Error("IOReader error, flush failed")}}getBuffer(){return this.buffer}appendBuffer(t){if(this.size-this.endPointer>=t.length)this.buffer.set(t,this.endPointer),this.endPointer+=t.length;else if(this.buffer.set(this.buffer.subarray(this.pointer,this.endPointer),0),this.endPointer=this.endPointer-this.pointer,this.pointer=0,this.size-this.endPointer>=t.length)this.buffer.set(t,this.endPointer),this.endPointer+=t.length;else{const e=Math.min(this.size-this.endPointer,t.length);this.buffer.set(t.subarray(0,e),this.endPointer),this.endPointer+=e,s.R8("BSReader, call appendBuffer but the buffer's size is lagger then the remaining size","src/common/io/BitReader.ts",170)}}clear(){this.pointer=this.endPointer=0,this.bitsLeft=8,this.error=0}skipPadding(){this.bitsLeft<8&&(this.bitsLeft=8,this.pointer++)}}},729:(t,e,i)=>{i.d(e,{A:()=>n});var r=i(1026),s=i(4624),a=i(11);class n{constructor(t,e=!0){(0,r.A)(this,"data",void 0),(0,r.A)(this,"buffer",void 0),(0,r.A)(this,"byteStart",void 0),(0,r.A)(this,"pos",void 0),(0,r.A)(this,"size",void 0),(0,r.A)(this,"littleEndian",void 0),this.buffer=t,this.data=t instanceof Uint8Array?new DataView(t.buffer):t.view,this.byteStart=t instanceof Uint8Array?t.byteOffset:0,this.pos=0,this.size=t.byteLength,this.littleEndian=!e}writeUint8(t){this.data.setUint8(this.pos+++this.byteStart,t)}writeUint16(t){this.data.setUint16(this.pos+this.byteStart,t,this.littleEndian),this.pos+=2}writeUint24(t){const e=3840&t,i=240&t,r=15&t;this.littleEndian?(this.writeUint8(r),this.writeUint8(i),this.writeUint8(e)):(this.writeUint8(e),this.writeUint8(i),this.writeUint8(r))}writeUint32(t){this.data.setUint32(this.pos+this.byteStart,t,this.littleEndian),this.pos+=4}writeUint64(t){const e=t&BigInt(4294967295),i=(t&BigInt(4294967295)<<BigInt(32))>>BigInt(32);this.littleEndian?(this.writeUint32(Number(e)),this.writeUint32(Number(i))):(this.writeUint32(Number(i)),this.writeUint32(Number(e)))}writeInt8(t){this.data.setInt8(this.pos+++this.byteStart,t)}writeInt16(t){this.data.setInt16(this.pos+this.byteStart,t,this.littleEndian),this.pos+=2}writeInt32(t){this.data.setInt32(this.pos+this.byteStart,t,this.littleEndian),this.pos+=4}writeInt64(t){const e=t&BigInt(4294967295),i=(t&BigInt(4294967295)<<BigInt(32))>>BigInt(32);this.littleEndian?(this.writeInt32(Number(e)),this.writeInt32(Number(i))):(this.writeInt32(Number(i)),this.writeInt32(Number(e)))}writeFloat(t){this.data.setFloat32(this.pos+this.byteStart,t,this.littleEndian),this.pos+=4}writeDouble(t){this.data.setFloat64(this.pos+this.byteStart,t,this.littleEndian),this.pos+=8}getPos(){return this.pos}seek(t){t>this.size&&(t=this.size),this.pos=Math.max(0,t)}skip(t){this.seek(this.pos+t)}back(t){this.seek(this.pos-t)}remainingSize(){return this.size-this.pos}writeBuffer(t){let e=t.length;this.remainingSize()<e&&(e=this.remainingSize(),s.R8(`the remaining buffer size is smaller then the wrote buffer, hope set ${t.length}, but set ${e}`,"src/common/io/BufferWriter.ts",211)),this.buffer.set(t,this.pos),this.pos+=t.length}writeString(t){const e=a.l(t);return this.writeBuffer(e),e.length}getWroteBuffer(){return this.buffer.subarray(0,this.pos)}resetBuffer(t,e=!0){this.buffer=t,this.data=t instanceof Uint8Array?new DataView(t.buffer):t.view,this.byteStart=t instanceof Uint8Array?t.byteOffset:0,this.pos=0,this.size=t.byteLength,this.littleEndian=!e}}},5336:(t,e,i)=>{i.d(e,{A:()=>a});var r=i(1026),s=i(11);class a{constructor(t=1048576,e=!0,i){(0,r.A)(this,"data",void 0),(0,r.A)(this,"buffer",void 0),(0,r.A)(this,"pointer",void 0),(0,r.A)(this,"pos",void 0),(0,r.A)(this,"size",void 0),(0,r.A)(this,"littleEndian",void 0),(0,r.A)(this,"error",void 0),(0,r.A)(this,"onFlush",void 0),(0,r.A)(this,"onSeek",void 0),this.pointer=0,this.pos=BigInt(0),this.size=t,this.littleEndian=!e,this.error=0,i?(this.buffer=i,this.data=i.view):(this.buffer=new Uint8Array(this.size),this.data=new DataView(this.buffer.buffer))}writeUint8(t){this.remainingLength()<1&&this.flush(),this.data.setUint8(this.pointer,t),this.pointer++,this.pos++}writeUint16(t){this.remainingLength()<2&&this.flush(),this.data.setUint16(this.pointer,t,this.littleEndian),this.pointer+=2,this.pos+=BigInt(2)}writeUint24(t){this.remainingLength()<3&&this.flush();const e=(16711680&t)>>16,i=(65280&t)>>8,r=255&t;this.littleEndian?(this.writeUint8(r),this.writeUint8(i),this.writeUint8(e)):(this.writeUint8(e),this.writeUint8(i),this.writeUint8(r))}writeUint32(t){this.remainingLength()<4&&this.flush(),this.data.setUint32(this.pointer,t,this.littleEndian),this.pointer+=4,this.pos+=BigInt(4)}writeUint64(t){this.remainingLength()<8&&this.flush(),this.data.setBigUint64(this.pointer,t,this.littleEndian),this.pointer+=8,this.pos+=BigInt(8)}writeInt8(t){this.remainingLength()<1&&this.flush(),this.data.setInt8(this.pointer,t),this.pointer++,this.pos++}writeInt16(t){this.remainingLength()<2&&this.flush(),this.data.setInt16(this.pointer,t,this.littleEndian),this.pointer+=2,this.pos+=BigInt(2)}writeInt32(t){this.remainingLength()<4&&this.flush(),this.data.setInt32(this.pointer,t,this.littleEndian),this.pointer+=4,this.pos+=BigInt(4)}writeInt64(t){this.remainingLength()<8&&this.flush(),this.data.setBigInt64(this.pointer,t,this.littleEndian),this.pointer+=8,this.pos+=BigInt(8)}writeFloat(t){this.remainingLength()<4&&this.flush(),this.data.setFloat32(this.pointer,t,this.littleEndian),this.pointer+=4,this.pos+=BigInt(4)}writeDouble(t){this.remainingLength()<8&&this.flush(),this.data.setFloat64(this.pointer,t,this.littleEndian),this.pointer+=8,this.pos+=BigInt(8)}getPointer(){return this.pointer}getPos(){return this.pos}remainingLength(){return this.size-this.pointer}writeBuffer(t){if(!t.length)return;let e=t.length;if(this.remainingLength()<e){let i=0;for(;e>0;){this.flush();const r=Math.min(this.size,e);this.buffer.set(t.subarray(i,i+r),this.pointer),this.pointer+=r,this.pos+=BigInt(r),i+=r,e-=r}}else this.buffer.set(t,this.pointer),this.pointer+=e,this.pos+=BigInt(e)}writeString(t){const e=s.l(t);return this.writeBuffer(e),e.length}encodeString(t){return s.l(t)}flush(){if(!this.onFlush)throw this.error=-1048574,Error("IOWriter error, flush failed because of no flush callback");if(this.pointer){const t=this.onFlush(this.buffer.subarray(0,this.pointer));if(0!==t)throw this.error=t,Error("IOWriter error, flush failed")}this.pointer=0}flushToPos(t){if(!this.onFlush)throw this.error=-1048574,Error("IOWriter error, flush failed because of no flush callback");if(this.pointer){const e=this.onFlush(this.buffer.subarray(0,this.pointer),t);if(0!==e)throw this.error=e,Error("IOWriter error, flush failed")}this.pointer=0}seek(t){if(!this.onSeek)throw this.error=-1048574,Error("IOWriter error, seek failed because of no seek callback");this.flush();const e=this.onSeek(t);if(0!==e)throw this.error=e,Error("IOWriter error, seek failed");this.pos=t}seekInline(t){const e=this.pointer;this.pointer=Math.max(0,Math.min(this.size,t)),this.pos+=BigInt(this.pointer-e)}skip(t){const e=this.pointer;this.pointer=Math.min(this.size,this.pointer+t),this.pos+=BigInt(this.pointer-e)}back(t){const e=this.pointer;this.pointer=Math.max(0,this.pointer-t),this.pos+=BigInt(this.pointer-e)}getBuffer(){return this.buffer.subarray(0,this.pointer)}setEndian(t){this.littleEndian=!t}reset(){this.pointer=0,this.pos=BigInt(0),this.error=0}getBufferSize(){return this.size}}}}]);