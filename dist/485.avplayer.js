"use strict";(self.webpackChunkAVPlayer=self.webpackChunkAVPlayer||[]).push([[485],{4436:(t,e,i)=>{i.d(e,{A:()=>o});var r=i(1026),a=i(3939),n=i(7837),s=i(5546);class o{constructor(){(0,r.A)(this,"inCodecpar",void 0),(0,r.A)(this,"inTimeBase",void 0),(0,r.A)(this,"outCodecpar",void 0)}init(t,e){return this.inCodecpar=(0,n.Gy)(184),(0,s.Yi)(this.inCodecpar,t),this.inTimeBase={den:a.f[15](e+4),num:a.f[15](e)},0}destroy(){this.inCodecpar&&((0,s.dn)(this.inCodecpar),this.inCodecpar=0)}}},8469:(t,e,i)=>{i.d(e,{En:()=>s,Ij:()=>c,XC:()=>o,hY:()=>n});var r=i(7231);const a={96e3:0,88200:1,64e3:2,48e3:3,44100:4,32e3:5,24e3:6,22050:7,16e3:8,12e3:9,11025:10,8e3:11,7350:12},n=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350,r.N_,r.N_,r.N_],s=[r.N_,1,2,3,4,5,6,7];function o(t,e){if(!e&&t.sideData[1]&&(e=t.sideData[1]),e){const{profile:i,sampleRate:a,channels:o}=function(t){let e=r.N_,i=r.N_,a=r.N_;var o,c;return t.length>=2&&(e=t[0]>>3&31,i=null!==(o=n[(7&t[0])<<1|t[1]>>7])&&void 0!==o?o:48e3,a=null!==(c=s[t[1]>>3&15])&&void 0!==c?c:2),{profile:e,sampleRate:i,channels:a}}(e);t.codecpar.profile=i,t.codecpar.sampleRate=a,t.codecpar.chLayout.nbChannels=o,t.codecpar.channels=o}}function c(t){const e=a[t.sampleRate],i=t.chLayout.nbChannels,r=new Uint8Array(2);return r[0]=(31&t.profile)<<3|(14&e)>>1,r[1]=(1&e)<<7|(15&i)<<3,r}},620:(t,e,i)=>{i.d(e,{Jk:()=>U,XC:()=>A,ci:()=>w,oT:()=>b});var r=i(3939),a=i(2739),n=i(6079),s=i(6795),o=i(7246),c=i(4624),h=i(4686),d=i(1517),l=i(264),f=i(7837),p=i(3991),u="src/avformat/codecs/h264.ts";const g=3;function m(t,e,i=[]){t.length>32&&(c.R8(`h264 metadata's sps max length is 32, but get ${t.length}`,u,159),t=t.slice(0,32)),t.length>256&&(c.R8(`h264 metadata's pps max length is 256, but get ${t.length}`,u,163),t=t.slice(0,256));let r=7;r=t.reduce(((t,e)=>t+2+e.length),r),r=e.reduce(((t,e)=>t+2+e.length),r);const s=t[0],o=y(s);66!==o.profile&&77!==o.profile&&88!==o.profile&&(r+=4,i.length&&(r=i.reduce(((t,e)=>t+2+e.length),r)));const h=new Uint8Array(r),d=new n.A(h);return d.writeUint8(1),d.writeUint8(s[1]),d.writeUint8(s[2]),d.writeUint8(s[3]),d.writeUint8(252|g),d.writeUint8(224|31&t.length),a.__(t,(t=>{d.writeUint16(t.length),d.writeBuffer(t)})),d.writeUint8(e.length),a.__(e,(t=>{d.writeUint16(t.length),d.writeBuffer(t)})),66!==o.profile&&77!==o.profile&&88!==o.profile&&(d.writeUint8(252|o.chromaFormatIdc),d.writeUint8(248|o.bitDepthLumaMinus8),d.writeUint8(248|o.bitDepthChromaMinus8),i.length&&a.__(i,(t=>{d.writeUint16(t.length),d.writeBuffer(t)}))),h}function b(t){let e,i=(0,l.py)(t),r=!1;if(i.length>1){const t=[],r=[],a=[];i.forEach((e=>{const i=31&e[0];7===i?t.push(e):8===i?r.push(e):13===i&&a.push(e)})),t.length&&r.length&&(e=m(t,r,a)),i=i.filter((t=>{const e=31&t[0];return 9!==e&&8!==e&&7!==e&&13!==e}))}const s=i.reduce(((t,e)=>t+g+1+e.length),0),o=(0,f.sY)(s),c=(0,h.s3)(o,s),d=new n.A(c);return a.__(i,(t=>{3===g?d.writeUint32(t.length):2===g?d.writeUint24(t.length):1===g?d.writeUint16(t.length):d.writeUint8(t.length),d.writeBuffer(t.subarray(0)),5==(31&t[0])&&(r=!0)})),{bufferPointer:o,length:s,key:r,extradata:e}}function U(t,e){var i;if(!(1&r.f[15](t+36)))return;const a=(0,d.iI)(t);if((0,l.Bs)(a))return;const n=null!==(i=e.metadata.naluLengthSizeMinusOne)&&void 0!==i?i:g;let o=[],c=[],p=[],u=[];const b=new s.A(a);for(;b.remainingSize()>0;){let t=0;t=3===n?b.readUint32():2===n?b.readUint24():1===n?b.readUint16():b.readUint8();const e=a.subarray(b.getPos(),b.getPos()+t);b.skip(t);const i=31&e[0];7===i?o.push(e):8===i?c.push(e):13===i?p.push(e):u.push(e)}if(o.length||c.length){const e=m(o,c,p),i=(0,f.sY)(e.length);(0,h.lW)(i,e.length,e),(0,d.Ow)(t,1,i,e.length)}}function w(t){if(!(1&r.f[15](t+36)))return;const e=(0,d.iI)(t);if(!(0,l.Bs)(e))return;let i=(0,l.py)(e);if(i.length>1){const e=[],r=[],a=[];if(i.forEach((t=>{const i=31&t[0];7===i?e.push(t):8===i?r.push(t):13===i&&a.push(t)})),e.length&&r.length){const i=m(e,r,a),n=(0,f.sY)(i.length);(0,h.lW)(n,i.length,i),(0,d.Ow)(t,1,n,i.length)}}}function A(t,e){if(!e&&t.sideData[1]&&(e=t.sideData[1]),e&&e.length>=6){t.metadata.naluLengthSizeMinusOne=3&e[4];const{spss:i}=function(t){const e=new s.A(t);e.skip(5);const i=[],r=[],a=[],n=31&e.readUint8();for(let t=0;t<n;t++){const t=e.readUint16();i.push(e.readBuffer(t))}const o=e.readUint8();for(let t=0;t<o;t++){const t=e.readUint16();r.push(e.readBuffer(t))}if(e.remainingSize()>4){e.skip(3);const t=e.readUint8();if(t>0)for(let i=0;i<t;i++){const t=e.readUint16();a.push(e.readBuffer(t))}}return{spss:i,ppss:r,spsExts:a}}(e);if(i.length){const{profile:e,level:r,width:a,height:n}=y(i[0]);t.codecpar.profile=e,t.codecpar.level=r,t.codecpar.width=a,t.codecpar.height=n}}}function y(t){if(!t||t.length<3)return;let e=0;0===t[0]&&0===t[1]&&0===t[2]&&1===t[3]&&(e=4);const i=(0,l.BN)(t.subarray(e)),r=new o.A(i.length);r.appendBuffer(i),r.readU1(),r.readU(2),r.readU(5);const a=r.readU(8);r.readU1(),r.readU1(),r.readU1(),r.readU1(),r.readU1(),r.readU1(),r.readU(2);const n=r.readU(8);p.xb(r);let s=1,c=0,h=0;if((100==a||110==a||122==a||244==a||44==a||83==a||86==a||118==a||128==a||138==a||139==a||134==a||135==a)&&(s=p.xb(r),3===s&&r.readU1(),c=p.xb(r),h=p.xb(r),r.readU1(),r.readU1())){const t=new Array(8);for(let e=0;e<(3!=s?8:12);e++)t[e]=r.readU1()}p.xb(r);const d=p.xb(r);if(0===d)p.xb(r);else if(1===d){r.readU1(),p.$x(r),p.$x(r);const t=p.xb(r);for(let e=0;e<t;e++)p.$x(r)}p.xb(r),r.readU1();const f=p.xb(r),u=p.xb(r),g=r.readU1();let m=16*(f+1),b=(2-g)*(u+1)*16;g||r.readU1(),r.readU1();const U=r.readU1();if(U){let t=1,e=2-U;1===s?(t=2,e=2*(2-U)):2===U&&(t=2,e=2-U),m-=t*(p.xb(r)+p.xb(r)),b-=e*(p.xb(r)+p.xb(r))}return{profile:a,level:n,width:m,height:b,chromaFormatIdc:s,bitDepthLumaMinus8:c,bitDepthChromaMinus8:h}}},3e3:(t,e,i)=>{i.d(e,{Jk:()=>m,XC:()=>U,ci:()=>b,oT:()=>g});var r=i(3939),a=i(2739),n=i(6079),s=i(6795),o=i(7246),c=i(4686),h=i(264),d=i(1517),l=i(7837),f=i(3991);const p=3;function u(t,e,i){const r=e[0];let s=23;t.length&&(s+=3,s=t.reduce(((t,e)=>t+2+e.length),s)),e.length&&(s+=3,s=e.reduce(((t,e)=>t+2+e.length),s)),i.length&&(s+=3,s=i.reduce(((t,e)=>t+2+e.length),s));const o=new Uint8Array(s),c=new n.A(o,!0),h=w(r);c.writeUint8(1),c.writeUint8(r[1]),c.writeUint8(r[2]),c.writeUint8(r[3]),c.writeUint8(r[4]),c.writeUint8(r[5]),c.writeUint8(r[6]),c.writeUint8(r[7]),c.writeUint8(r[8]),c.writeUint8(r[9]),c.writeUint8(r[10]),c.writeUint8(r[11]),c.writeUint8(h.level),c.writeUint8(1020),c.writeUint8(0),c.writeUint8(16320),c.writeUint8(16320|h.chromaFormatIdc),c.writeUint8(8160|h.bitDepthLumaMinus8),c.writeUint8(8160|h.bitDepthChromaMinus8),c.writeUint16(0),c.writeUint8(8|(1&r[0])<<2|p);let d=0;return t.length&&d++,e.length&&d++,i.length&&d++,c.writeUint8(d),t.length&&(c.writeUint8(160),c.writeUint16(t.length),a.__(t,(t=>{c.writeUint16(t.length),c.writeBuffer(t)}))),e.length&&(c.writeUint8(161),c.writeUint16(e.length),a.__(e,(t=>{c.writeUint16(t.length),c.writeBuffer(t)}))),i.length&&(c.writeUint8(162),c.writeUint16(i.length),a.__(i,(t=>{c.writeUint16(t.length),c.writeBuffer(t)}))),o}function g(t){let e,i=!1,r=(0,h.py)(t);if(r.length>2){const t=[],i=[],a=[];r.forEach((e=>{const r=e[0]>>>1&63;32===r?t.push(e):33===r?i.push(e):34===r&&a.push(e)})),t.length&&i.length&&a.length&&(e=u(t,i,a),r=r.filter((t=>{const e=t[0]>>>1&63;return 32!==e&&33!==e&&34!==e&&35!==e})))}const s=r.reduce(((t,e)=>t+p+1+e.length),0),o=(0,l.sY)(s),d=(0,c.s3)(o,s),f=new n.A(d);return a.__(r,(t=>{3===p?f.writeUint32(t.length):2===p?f.writeUint24(t.length):1===p?f.writeUint16(t.length):f.writeUint8(t.length),f.writeBuffer(t.subarray(0));const e=t[0]>>>1&63;19!==e&&20!==e&&21!==e||(i=!0)})),{bufferPointer:o,length:s,extradata:e,key:i}}function m(t,e){var i;if(!(1&r.f[15](t+36)))return;const a=(0,d.iI)(t);if((0,h.Bs)(a))return;const n=null!==(i=e.metadata.naluLengthSizeMinusOne)&&void 0!==i?i:p;let o=[],f=[],g=[];const m=new s.A(a);for(;m.remainingSize()>0;){let t=0;t=3===n?m.readUint32():2===n?m.readUint24():1===n?m.readUint16():m.readUint8();const e=a.subarray(m.getPos(),m.getPos()+t);m.skip(t);const i=e[0]>>>1&63;33===i?f.push(e):34===i?g.push(e):32===i&&o.push(e)}if(f.length||g.length||o.length){const e=u(o,f,g),i=(0,l.sY)(e.length);(0,c.lW)(i,e.length,e),(0,d.Ow)(t,1,i,e.length)}}function b(t){if(!(1&r.f[15](t+36)))return;const e=(0,d.iI)(t);if(!(0,h.Bs)(e))return;let i=(0,h.py)(e);if(i.length>2){const e=[],r=[],a=[];if(i.forEach((t=>{const i=t[0]>>>1&63;32===i?e.push(t):33===i?r.push(t):34===i&&a.push(t)})),e.length&&r.length&&a.length){const i=u(e,r,a),n=(0,l.sY)(i.length);(0,c.lW)(n,i.length,i),(0,d.Ow)(t,1,n,i.length)}}}function U(t,e){if(!e&&t.sideData[1]&&(e=t.sideData[1]),e&&e.length>=6){t.metadata.naluLengthSizeMinusOne=3&e[21];const{spss:i}=function(t){const e=new s.A(t,!0);e.skip(22);let i=[],r=[],a=[];const n=e.readUint8();for(let t=0;t<n;t++){const t=63&e.readUint8(),n=e.readUint16(),s=[];for(let t=0;t<n;t++){const t=e.readUint16();s.push(e.readBuffer(t))}32===t?i=s:33===t?r=s:34===t&&(a=s)}return{vpss:i,spss:r,ppss:a}}(e);if(i.length){const{profile:e,level:r,width:a,height:n}=w(i[0]);t.codecpar.profile=e,t.codecpar.level=r,t.codecpar.width=a,t.codecpar.height=n}}}function w(t){if(!t||t.length<3)return;let e=0;0===t[0]&&0===t[1]&&0===t[2]&&1===t[3]&&(e=4);let i=0,r=0,a=0,n=0,s=0,c=0,d=1,l=0,p=0,u=0,g=0;const m=(0,h.BN)(t.subarray(e)),b=new o.A(m.length);b.appendBuffer(m),b.readU1(),b.readU(6),b.readU(6),b.readU(3),b.readU(4);const U=b.readU(3);if(b.readU1(),U<=6){l=b.readU(2),p=b.readU1(),i=b.readU(5),u=b.readU(32),g=b.readU(48),r=b.readU(8);const t=new Array(6),e=new Array(6);for(let i=0;i<U;i++)t[i]=b.readU1(),e[i]=b.readU1();if(U>0)for(let t=U;t<8;t++)b.readU(2);for(let i=0;i<U;i++)t[i]&&(b.readU(2),b.readU(1),b.readU(5),b.readU(32),b.readU(1),b.readU(1),b.readU(1),b.readU(1),b.readU(44)),e[i]&&b.readU(8);f.xb(b),d=f.xb(b),3===d&&b.readU(1),a=f.xb(b),n=f.xb(b);let o=0,h=0,m=0,w=0;b.readU1()&&(o=f.xb(b),h=f.xb(b),m=f.xb(b),w=f.xb(b)),s=f.xb(b),c=f.xb(b);let A=2,y=2;0===d?A=y=0:2===d?(A=2,y=1):3===d&&(A=y=1),a-=A*(1<<s+1)*(o+h),n-=y*(1<<s+1)*(m+w)}return{profile:i,level:r,width:a,height:n,chromaFormatIdc:d,bitDepthLumaMinus8:s,bitDepthChromaMinus8:c,generalProfileSpace:l,generalTierFlag:p,generalProfileCompatibilityFlag:u,constraintFlags:g}}},9088:(t,e,i)=>{i.d(e,{Au:()=>U,Y2:()=>g,hG:()=>m,oz:()=>b});var r=i(7231);const a=[44100,48e3,32e3,0],n=[22050,24e3,16e3,0],s=[11025,12e3,8e3,0],o=[0,1152,1152,384],c=[0,576,1152,384],h=[0,576,1152,384],d=[0,32,64,96,128,160,192,224,256,288,320,352,384,416,448,-1],l=[0,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1],f=[0,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1],p=[0,32,48,56,64,80,96,112,128,144,160,176,192,224,256,-1],u=[0,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1];function g(t,e){switch(t){case 0:return s[e];case 2:return n[e];case 3:return a[e]}return r.N_}function m(t,e){switch(t){case 0:return h[e];case 2:return c[e];case 3:return o[e]}return r.N_}function b(t,e,i){switch(e){case 1:switch(t){case 0:case 2:return u[i];case 3:return f[i]}break;case 2:switch(t){case 0:case 2:return u[i];case 3:return l[i]}case 3:switch(t){case 0:case 2:return p[i];case 3:return d[i]}}return r.N_}function U(t){switch(t){case 1:return 34;case 2:return 33;case 3:return 32}return r.N_}},5451:(t,e,i)=>{i.d(e,{Ij:()=>h,XC:()=>c,kt:()=>o});var r=i(6795),a=i(6079),n=i(4328);const s=[480,960,1920,2880,480,960,1920,2880,480,960,1920,2880,480,960,480,960,120,240,480,960,120,240,480,960,120,240,480,960,120,240,480,960];function o(t){let e=0,i=0,r=0;if(t.length<1)return 0;switch(e=t[0],i=s[e>>3],3&e){case 0:r=1;break;case 1:case 2:r=2;break;case 3:if(t.length<2)return 0;r=63&t[1]}return r*i}function c(t,e){if(!e&&t.sideData[1]&&(e=t.sideData[1]),e&&e.length>=19){const i=new r.A(e,!1);i.skip(9),t.codecpar.chLayout.nbChannels=i.readUint8(),t.codecpar.channels=t.codecpar.chLayout.nbChannels,t.codecpar.initialPadding=i.readUint16(),t.codecpar.sampleRate=i.readUint32(),t.codecpar.seekPreroll=Number((0,n.k)(BigInt(80),{den:1e3,num:1},{den:48e3,num:1}))}}function h(t){const e=new Uint8Array(19),i=new a.A(e,!1);return i.writeString("OpusHead"),i.writeUint8(1),i.writeUint8(t.chLayout.nbChannels),i.writeUint16(t.initialPadding),i.writeUint32(t.sampleRate),e}},5947:(t,e,i)=>{i.d(e,{A:()=>a});var r=i(1026);class a{constructor(){(0,r.A)(this,"type",-1),(0,r.A)(this,"onStreamAdd",void 0)}destroy(t){}}},6485:(t,e,i)=>{i.r(e),i.d(e,{default:()=>it});var r=i(1026),a=i(3939),n=i(932),s=i(4624),o=i(662),c=i.n(o),h=i(7231);class d{constructor(){(0,r.A)(this,"discontinuityIndicator",0),(0,r.A)(this,"randomAccessIndicator",0),(0,r.A)(this,"elementaryStreamPriorityIndicator",0),(0,r.A)(this,"pcrFlag",0),(0,r.A)(this,"opcrFlag",0),(0,r.A)(this,"splicingPointFlag",0),(0,r.A)(this,"transportPrivateDataFlag",0),(0,r.A)(this,"adaptationFieldExtensionFlag",0),(0,r.A)(this,"pcr",BigInt(0)),(0,r.A)(this,"opcr",BigInt(0)),(0,r.A)(this,"spliceCountDown",0),(0,r.A)(this,"transportPrivateData",null),(0,r.A)(this,"extension",null)}}class l{constructor(){(0,r.A)(this,"pos",h.Dh),(0,r.A)(this,"payloadUnitStartIndicator",0),(0,r.A)(this,"transportPriority",0),(0,r.A)(this,"pid",h.N_),(0,r.A)(this,"adaptationFieldControl",0),(0,r.A)(this,"continuityCounter",0),(0,r.A)(this,"transportScramblingControl",0),(0,r.A)(this,"adaptationFieldInfo",new d),(0,r.A)(this,"payload",null)}}class f{constructor(){(0,r.A)(this,"slices",[]),(0,r.A)(this,"totalLength",0),(0,r.A)(this,"expectedLength",h.N_),(0,r.A)(this,"randomAccessIndicator",0),(0,r.A)(this,"pid",h.N_),(0,r.A)(this,"streamType",0),(0,r.A)(this,"pos",h.Dh)}}class p{constructor(){(0,r.A)(this,"versionNumber",0),(0,r.A)(this,"networkPid",h.N_),(0,r.A)(this,"program2PmtPid",new(c()))}}class u{constructor(){(0,r.A)(this,"tag",void 0),(0,r.A)(this,"buffer",void 0)}}class g{constructor(){(0,r.A)(this,"versionNumber",0),(0,r.A)(this,"programNumber",0),(0,r.A)(this,"pcrPid",0),(0,r.A)(this,"pid2StreamType",new(c())),(0,r.A)(this,"pid2ESDescriptor",new(c()))}}class m{constructor(){(0,r.A)(this,"pid",h.N_),(0,r.A)(this,"streamType",0),(0,r.A)(this,"streamId",h.N_),(0,r.A)(this,"dts",h.Dh),(0,r.A)(this,"pts",h.Dh),(0,r.A)(this,"pos",h.Dh),(0,r.A)(this,"payload",null),(0,r.A)(this,"data",null),(0,r.A)(this,"randomAccessIndicator",0)}}const b=204,U=192,w=188,A={15:[1,86018],17:[1,86018],3:[1,86017],4:[1,86017],27:[0,27],36:[0,173],129:[1,86019],135:[1,86056]};function y(t,e,i){const r=new Uint8Array(204);let a=0,n=0;for(let s=0;s<t.length-3;s++)if(71===t[s]){const o=8191&(t[s+1]<<8|t[s+2]);let c=48&t[s+3];if(!i||8191===o||c){const t=s%e;r[t]++,a++,r[t]>n&&(n=r[t])}}return n-Math.max(a-10*n,0)/10}function x(t,e){let i=0,r=t[i++];if(e.adaptationFieldInfo.discontinuityIndicator=r>>7&1,e.adaptationFieldInfo.randomAccessIndicator=r>>6&1,e.adaptationFieldInfo.elementaryStreamPriorityIndicator=r>>5&1,e.adaptationFieldInfo.pcrFlag=r>>4&1,e.adaptationFieldInfo.opcrFlag=r>>3&1,e.adaptationFieldInfo.splicingPointFlag=r>>2&1,e.adaptationFieldInfo.transportPrivateDataFlag=r>>1&1,e.adaptationFieldInfo.adaptationFieldExtensionFlag=1&r,e.adaptationFieldInfo.pcrFlag){const r=BigInt(Math.floor(t[i++]<<25|t[i++]<<17|t[i++]<<9|t[i++]<<1|t[i]>>7)),a=BigInt(Math.floor((1&t[i++])<<8|t[i++]));e.adaptationFieldInfo.pcr=r*BigInt(300)+a}if(e.adaptationFieldInfo.opcrFlag){const r=BigInt(Math.floor(t[i++]<<25|t[i++]<<17|t[i++]<<9|t[i++]<<1|t[i]>>7)),a=BigInt(Math.floor((1&t[i++])<<8|t[i++]));e.adaptationFieldInfo.pcr=r*BigInt(300)+a}if(e.adaptationFieldInfo.splicingPointFlag&&(e.adaptationFieldInfo.spliceCountDown=t[i++]),e.adaptationFieldInfo.transportPrivateDataFlag){const r=t[i++];e.adaptationFieldInfo.transportPrivateData=t.subarray(i,i+r),i+=r}if(e.adaptationFieldInfo.adaptationFieldExtensionFlag){const r=t[i++];e.adaptationFieldInfo.extension=t.subarray(i,i+r),i+=r}}var P="src/avformat/formats/mpegts/impegts.ts";async function I(t,e){const i=t.getPos();let r=0;e.tsPacketSize===U&&t.skip(4);const a=await t.readUint8();71!==a&&s.h2(`found syncByte not 0x47, value: ${a.toString(16)}`,P,94);const n=new l;n.pos=i,r=await t.readUint16(),n.payloadUnitStartIndicator=r>>14&1,n.transportPriority=r>>13&1,n.pid=8191&r,r=await t.readUint8(),n.adaptationFieldControl=r>>4&3,n.continuityCounter=15&r;let o=4;if(2===n.adaptationFieldControl||3===n.adaptationFieldControl){const i=await t.readUint8();if(5+i===w)return x(await t.readBuffer(i),n),e.tsPacketSize===b&&t.skip(16),n;i>0&&x(await t.readBuffer(i),n),o=5+i}return 1!==n.adaptationFieldControl&&3!==n.adaptationFieldControl||(n.payload=await t.readBuffer(w-o)),e.tsPacketSize===b&&t.skip(16),n}function k(t){t.slices=[],t.totalLength=0,t.expectedLength=-1}var M=i(6795),S=i(2647),v="src/avformat/formats/mpegts/function/parsePAT.ts",R="src/avformat/formats/mpegts/function/parsePMT.ts";function C(t,e,i){0===t?function(t,e){let i=0;const r=new M.A((0,S.A)(Uint8Array,t.slices),!0),a=r.readUint8();0!==a&&s.z3(`parsePAT: table_id ${a} is not corresponded to PAT!`,v,40);const n=4095&r.readUint16();r.readUint16(),i=r.readUint8();const o=i>>1&31,c=1&i,h=r.readUint8();let d;if(r.readUint8(),1===c&&0===h)d=new p,d.versionNumber=o;else if(d=e.pat,!d)return void s.z3("can not found PAT in mpegts context",v,64);const l=n-5-4,f=r.getPos()+l;let u=-1,g=-1;for(;r.getPos()<f;){const t=r.readUint16(),e=8191&r.readUint16();0===t?d.networkPid=e:(d.program2PmtPid.set(t,e),-1===u&&(u=t),-1===g&&(g=e))}1===c&&0===h&&(e.pat||s.pq("parsed first PAT",v,100),e.pat=d,e.currentProgram=u,e.currentPmtPid=g,e.hasPAT=!0)}(e,i):t===i.currentPmtPid?function(t,e){let i=0;const r=new M.A((0,S.A)(Uint8Array,t.slices),!0),a=r.readUint8();2!==a&&s.z3(`parse PMT: table_id ${a} is not corresponded to PAT!`,R,40);const n=4095&r.readUint16(),o=r.readUint16();i=r.readUint8();const c=i>>1&31,h=1&i,d=r.readUint8();let l;if(r.readUint8(),1===h&&0===d)l=new g,l.programNumber=o,l.versionNumber=c,e.program2Pmt.set(o,l),e.hasPMT=!0;else if(l=e.program2Pmt.get(o),!l)return void s.z3("can not found PMT in mpegts context",R,68);l.pcrPid=8191&r.readUint16();const f=4095&r.readUint16();r.skip(f);let p=r.getPos()+(n-9-f-4);for(;r.getPos()<p;){const t=r.readUint8(),e=8191&r.readUint16(),i=4095&r.readUint16();if(l.pid2StreamType.set(e,t),i>0){const t=[],a=r.getPos()+i;for(;r.getPos()<a;){const e=new u;e.tag=r.readUint8();const i=r.readUint8();i>0&&(e.buffer=r.readBuffer(i)),t.push(e)}l.pid2ESDescriptor.set(e,t)}}o===e.currentProgram&&(e.pmt||s.pq("parsed first PMT",R,111),e.pmt=l)}(e,i):i.pmt&&i.pmt.pid2StreamType.get(t)}function B(t,e){const i=e.tsSliceQueueMap.get(t.pid);if(t.payloadUnitStartIndicator){const n=t.payload[0];if(i&&i.totalLength>0){const r=t.payload.slice(1,Math.min(1+n,t.payload.length));i.slices.push(r),i.totalLength+=r.length,i.totalLength===i.expectedLength?(C(t.pid,i,e),k(i)):(k(i),e.tsSliceQueueMap.delete(t.pid))}for(let i=1+n;i<t.payload.length;){var r,a;if(255===t.payload[i])break;const n=(15&t.payload[i+1])<<8|t.payload[i+2],s=new f;s.pid=t.pid,s.expectedLength=n+3,s.randomAccessIndicator=null!==(r=null===(a=t.adaptationFieldInfo)||void 0===a?void 0:a.randomAccessIndicator)&&void 0!==r?r:0;const o=t.payload.slice(i,Math.min(i+s.expectedLength-s.totalLength,t.payload.length));s.slices.push(o),s.totalLength+=o.length,e.tsSliceQueueMap.set(t.pid,s),s.totalLength===s.expectedLength?(C(t.pid,s,e),k(s)):(k(s),e.tsSliceQueueMap.delete(t.pid)),i+=o.length}}else if(i&&0!==i.totalLength){const r=t.payload.slice(0,Math.min(i.expectedLength-i.totalLength,t.payload.length));i.slices.push(r),i.totalLength+=r.length,i.totalLength===i.expectedLength?(C(t.pid,i,e),k(i)):(k(i),e.tsSliceQueueMap.delete(t.pid))}}var L=i(9705),F=i(1517),z=i(7837),T=i(4686),_=i(5947),E=i(1499),D=i(5495),N=i(915),V=i(4436),Y=i(8469),$=i(4328);class W extends V.A{constructor(...t){super(...t),(0,r.A)(this,"streamMuxConfig",void 0),(0,r.A)(this,"caches",void 0)}init(t,e){return super.init(t,e),this.caches=[],this.streamMuxConfig={profile:h.N_,sampleRate:h.N_,channels:h.N_},0}sendAVPacket(t){let e=0,i=a.f[17](t+16)||a.f[17](t+8);const r=(0,T.s3)(a.f[20](t+24),a.f[15](t+28)).slice();for(;e<r.length;){const t=r[e]<<4|r[e+1]>>4;if(4095!==t)return s.z3(`found syncWord not 0xFFF, got: 0x${t.toString(16)}`,"src/avformat/bsf/aac/ADTS2RawFilter.ts",103),L.LR;const o=1&r[e+1],c=(192&r[e+2])>>>6,d=(60&r[e+2])>>>2,l=(1&r[e+2])<<2|(192&r[e+3])>>>6,f=(3&r[e+3])<<11|r[e+4]<<3|(224&r[e+5])>>>5,p=3&r[6];let u=1===o?7:9,g=f-u;const m={dts:i,buffer:null,extradata:null,duration:h.N_};m.buffer=r.subarray(e+u,e+u+g),this.streamMuxConfig.profile=c+1,this.streamMuxConfig.sampleRate=Y.hY[d],this.streamMuxConfig.channels=Y.En[l];const b=a.f[15](this.inCodecpar+40)!==this.streamMuxConfig.profile||a.f[15](this.inCodecpar+108)!==this.streamMuxConfig.sampleRate||a.f[15](this.inCodecpar+140)!==this.streamMuxConfig.channels,U=(0,$.k)(BigInt(Math.floor(1024*(p+1)/this.streamMuxConfig.sampleRate*h.SF)),h.KR,this.inTimeBase);if(m.duration=Number(U),b){n.M[15](this.inCodecpar+40,this.streamMuxConfig.profile),n.M[15](this.inCodecpar+108,this.streamMuxConfig.sampleRate),n.M[15](this.inCodecpar+140,this.streamMuxConfig.channels),n.M[15](this.inCodecpar+104,this.streamMuxConfig.channels);const t=(0,Y.Ij)((0,N.A)(this.inCodecpar,D.A));a.f[20](this.inCodecpar+12)&&(0,z.Eb)(a.f[20](this.inCodecpar+12)),n.M[20](this.inCodecpar+12,(0,z.sY)(t.length)),(0,T.lW)(a.f[20](this.inCodecpar+12),t.length,t),n.M[15](this.inCodecpar+16,t.length),m.extradata=t}this.caches.push(m),e+=f,i+=U}}receiveAVPacket(t){if(this.caches.length){(0,F.Up)(t);const e=this.caches.shift(),i=(0,z.sY)(e.buffer.length);if((0,T.lW)(i,e.buffer.length,e.buffer),(0,F.NX)(t,i,e.buffer.length),n.M[17](t+16,e.dts),n.M[17](t+8,e.dts),n.M[17](t+48,BigInt(Math.floor(e.duration))),n.M[15](t+36,1|a.f[15](t+36)),e.extradata){const i=(0,z.sY)(e.extradata.length);(0,T.lW)(i,e.extradata.length,e.extradata),(0,F.Ow)(t,1,i,e.extradata.length)}return 0}return L.LR}}var O=i(7246),Q="src/avformat/bsf/aac/LATM2RawFilter.ts";class X extends V.A{constructor(...t){super(...t),(0,r.A)(this,"bitReader",void 0),(0,r.A)(this,"streamMuxConfig",void 0),(0,r.A)(this,"caches",void 0),(0,r.A)(this,"refSampleDuration",void 0)}init(t,e){return super.init(t,e),this.caches=[],this.refSampleDuration=BigInt(0),this.bitReader=new O.A,this.streamMuxConfig={profile:h.N_,sampleRate:h.N_,channels:h.N_},0}getLATMValue(){const t=this.bitReader.readU(2);let e=0;for(let i=0;i<=t;i++)e<<=8,e|=this.bitReader.readU(8);return e}sendAVPacket(t){const e=(0,T.s3)(a.f[20](t+24),a.f[15](t+28));this.bitReader.clear(),this.bitReader.appendBuffer(e);let i=a.f[17](t+16)||a.f[17](t+8);for(;this.bitReader.remainingLength()>3;){const t=this.bitReader.readU(11);if(695!==t)return s.z3(`AACLATMParser found syncWord not 0x2B7, got: 0x${t.toString(16)}`,Q,103),this.bitReader.clear(),L.LR;if(this.bitReader.readU(13)>this.bitReader.remainingLength())break;if(1!==this.bitReader.readU1()){const t=1===this.bitReader.readU1();if(t&&1===this.bitReader.readU1())return s.z3("audioMuxVersionA is Not Supported",Q,119),this.bitReader.clear(),L.LR;if(t&&this.getLATMValue(),1!==this.bitReader.readU1())return s.z3("allStreamsSameTimeFraming zero is Not Supported",Q,128),this.bitReader.clear(),L.LR;if(0!==this.bitReader.readU(6))return s.z3("more than 2 numSubFrames Not Supported",Q,134),this.bitReader.clear(),L.LR;if(0!==this.bitReader.readU(4))return s.z3("more than 2 numProgram Not Supported",Q,141),this.bitReader.clear(),L.LR;if(0!==this.bitReader.readU(3))return s.z3("more than 2 numLayer Not Supported'",Q,148),this.bitReader.clear(),L.LR;let e=t?this.getLATMValue():0;const i=this.bitReader.readU(5);e-=5;const r=this.bitReader.readU(4);e-=4;const a=this.bitReader.readU(4);e-=4,this.bitReader.readU(3),e-=3,e>0&&this.bitReader.readU(e);const n=this.bitReader.readU(3);if(0!==n)return s.z3(`frameLengthType = ${n}, only frameLengthType = 0 supported`,Q,176),this.bitReader.clear(),L.LR;if(this.bitReader.readU(8),1===this.bitReader.readU1())if(t)this.getLATMValue();else{let t=0;for(;;){t<<=8;const e=1===this.bitReader.readU1();if(t+=this.bitReader.readU(8),!e)break}}1===this.bitReader.readU1()&&this.bitReader.readU(8),this.streamMuxConfig.profile=i+1,this.streamMuxConfig.sampleRate=Y.hY[r],this.streamMuxConfig.channels=Y.En[a]}let e=0;for(;;){const t=this.bitReader.readU(8);if(e+=t,255!==t)break}const r=new Uint8Array(e);for(let t=0;t<e;t++)r[t]=this.bitReader.readU(8);const o={dts:i,buffer:r,extradata:null};if(a.f[15](this.inCodecpar+40)!==this.streamMuxConfig.profile||a.f[15](this.inCodecpar+108)!==this.streamMuxConfig.sampleRate||a.f[15](this.inCodecpar+140)!==this.streamMuxConfig.channels){this.refSampleDuration=(0,$.k)(BigInt(Math.floor(1024/this.streamMuxConfig.sampleRate*h.SF)),h.KR,this.inTimeBase),n.M[15](this.inCodecpar+40,this.streamMuxConfig.profile),n.M[15](this.inCodecpar+108,this.streamMuxConfig.sampleRate),n.M[15](this.inCodecpar+140,this.streamMuxConfig.channels),n.M[15](this.inCodecpar+104,this.streamMuxConfig.channels);const t=(0,Y.Ij)((0,N.A)(this.inCodecpar,D.A));a.f[20](this.inCodecpar+12)&&(0,z.Eb)(a.f[20](this.inCodecpar+12)),n.M[20](this.inCodecpar+12,(0,z.sY)(t.length)),(0,T.lW)(a.f[20](this.inCodecpar+12),t.length,t),n.M[15](this.inCodecpar+16,t.length),o.extradata=t}this.caches.push(o),i+=this.refSampleDuration,this.bitReader.skipPadding()}}receiveAVPacket(t){if(this.caches.length){(0,F.Up)(t);const e=this.caches.shift(),i=(0,z.sY)(e.buffer.length);if((0,T.lW)(i,e.buffer.length,e.buffer),(0,F.NX)(t,i,e.buffer.length),n.M[17](t+16,e.dts),n.M[17](t+8,e.dts),n.M[15](t+36,1|a.f[15](t+36)),e.extradata){const i=(0,z.sY)(e.extradata.length);(0,T.lW)(i,e.extradata.length,e.extradata),(0,F.Ow)(t,1,i,e.extradata.length)}return 0}return L.LR}}var J=i(5451);class j extends V.A{constructor(...t){super(...t),(0,r.A)(this,"caches",void 0)}init(t,e){return super.init(t,e),this.caches=[],0}sendAVPacket(t){let e=0,i=a.f[17](t+16)||a.f[17](t+8);const r=(0,F.iI)(t);for(;e<r.length;){const t=r[e]<<3|r[e+1]>>5;if(1023!==t)return s.z3(`MpegtsOpusParser found syncWord not 0x3ff, got: 0x${t.toString(16)}`,"src/avformat/bsf/opus/Mpegts2RawFilter.ts",67),L.LR;const n=!!(16&r[e+1]),o=!!(8&r[e+1]);let c=e+2,d=0;for(;255===r[c];)d+=255,c++;d+=r[c],c++,c+=n?2:0,c+=o?2:0;let l=r.subarray(c,c+d);const f=a.f[15](this.inCodecpar+108)>0?a.f[15](this.inCodecpar+108):48e3,p=(0,$.k)(BigInt(Math.floor(J.kt(l)/f*h.SF)),h.KR,this.inTimeBase);this.caches.push({dts:i,buffer:l.slice(),duration:Number(p)}),i+=p,e=c+d}}receiveAVPacket(t){if(this.caches.length){(0,F.Up)(t);const e=this.caches.shift(),i=(0,z.sY)(e.buffer.length);return(0,T.lW)(i,e.buffer.length,e.buffer),(0,F.NX)(t,i,e.buffer.length),n.M[17](t+16,e.dts),n.M[17](t+8,e.dts),n.M[15](t+36,1|a.f[15](t+36)),n.M[17](t+48,BigInt(Math.floor(e.duration))),0}return L.LR}}function K(t,e,i){e.timeBase.den=9e4,e.timeBase.num=1;const r={pid:h.N_,filter:null,tsPacket:null,pes:null,continuityCounter:0,pesSlices:{total:0,buffers:[]},latm:!1};r.pid=t,e.privData=r;const a=i.pmt.pid2StreamType.get(t);if(6===a){const r=i.pmt.pid2ESDescriptor.get(t);if(e.codecpar.codecType=2,r){var n;const t=r.find((t=>5===t.tag));if(t&&(null===(n=t.buffer)||void 0===n?void 0:n.length)>=4&&("O"===String.fromCharCode(t.buffer[0])||"p"===String.fromCharCode(t.buffer[1])||"u"===String.fromCharCode(t.buffer[2])||"s"===String.fromCharCode(t.buffer[3]))){e.codecpar.codecType=1,e.codecpar.codecId=86076,e.codecpar.sampleRate=48e3;const t=r.find((t=>127===t.tag));if(t&&128===t.buffer[0]){e.codecpar.chLayout.nbChannels=15&t.buffer[1]?15&t.buffer[1]:2,e.codecpar.channels=e.codecpar.chLayout.nbChannels;const i=J.Ij(e.codecpar);i&&(e.codecpar.extradata=(0,z.sY)(i.length),(0,T.lW)(e.codecpar.extradata,i.length,i),e.codecpar.extradataSize=i.length)}}}}else{const t=A[a];t?(e.codecpar.codecType=t[0],e.codecpar.codecId=t[1]):e.codecpar.codecType=2}let s;switch(a){case 15:s=new W;break;case 17:s=new X;break;case 27:case 36:break;case 6:86076===e.codecpar.codecId&&(s=new j)}return s&&(e.privData.filter=s,s.init(e.codecpar[E.o9],e.timeBase[E.o9])),e}var q=i(7550),G=i(2739),H=i(9088),Z=i(620),tt=i(3e3),et="src/avformat/formats/IMpegtsFormat.ts";class it extends _.A{constructor(){super(),(0,r.A)(this,"type",2),(0,r.A)(this,"context",void 0),(0,r.A)(this,"firstTSPacketPos",void 0),(0,r.A)(this,"cacheAVPacket",void 0),this.context={currentProgram:h.N_,currentPmtPid:h.N_,tsPacketSize:h.N_,hasPAT:!1,hasPMT:!1,tsSliceQueueMap:new(c()),pat:new p,pmt:new g,program2Pmt:new(c()),ioEnd:!1,startPid:256,delay:BigInt(0)}}init(t){t.ioReader&&t.ioReader.setEndian(!0),this.cacheAVPacket=0}destroy(t){super.destroy(t),this.cacheAVPacket&&((0,F.Qe)(this.cacheAVPacket),this.cacheAVPacket=0),G.__(t.streams,(t=>{const e=t.privData;e.filter&&(e.filter.destroy(),e.filter=null)}))}async readHeader(t){try{let e=0,i=await async function(t){let e;try{e=await t.peekBuffer(8192)}catch(i){-1048576!==t.error&&(e=await t.peekBuffer(t.remainingLength()))}if(e&&e.length>=w){const t=y(e,w,!1),n=y(e,U,!1),o=y(e,b,!1);let c=(a=n,(i=t)>(r=o)?a>r&&(r=a>i?i:a):r>a&&(r=a>i?a:i),r);e.length<8192&&(c+=5);let h=w;return t>c?h=w:n>c?h=U:o>c&&(h=b),s.Yz(`got ts packet size: ${h}`,P,72),h}var i,r,a;return 0}(t.ioReader);for(i||(i=w),this.context.tsPacketSize=i;!this.context.hasPAT||!this.context.hasPMT;){const e=await I(t.ioReader,this.context);e.payload&&(0!==e.pid&&e.pid!==this.context.currentPmtPid&&134!==this.context.pmt.pid2StreamType.get(e.pid)||B(e,this.context))}return this.context.hasPAT&&this.context.hasPMT?(this.firstTSPacketPos=t.ioReader.getPos(),e):L.LR}catch(e){return s.z3(e.message,et,134),t.ioReader.error}}checkExtradata(t,e){if(!e.codecpar.extradata){let i=(0,F.rU)(t,1);if(!i)return;e.codecpar.extradata=(0,z.sY)(a.f[15](i+4)),(0,T.Mr)(e.codecpar.extradata,a.f[20](i),a.f[15](i+4)),e.codecpar.extradataSize=a.f[15](i+4),(0,F.Is)(t,1),27===e.codecpar.codecId||12===e.codecpar.codecId?Z.XC(e,(0,T.JW)(e.codecpar.extradata,e.codecpar.extradataSize)):173===e.codecpar.codecId?tt.XC(e,(0,T.JW)(e.codecpar.extradata,e.codecpar.extradataSize)):86018===e.codecpar.codecId?Y.XC(e,(0,T.JW)(e.codecpar.extradata,e.codecpar.extradataSize)):86076===e.codecpar.codecId&&J.XC(e,(0,T.JW)(e.codecpar.extradata,e.codecpar.extradataSize))}}parsePESSlice(t,e,i,r){const o=function(t){let e=new Uint8Array(t.totalLength);for(let i=0,r=0;i<t.slices.length;i++){let a=t.slices[i];e.set(a,r),r+=a.byteLength}const i=e[3],r=e[4]<<8|e[5],a=new m;if(a.data=e,a.pid=t.pid,a.streamId=i,a.streamType=t.streamType,a.pos=t.pos,a.randomAccessIndicator=t.randomAccessIndicator,188!==i&&190!==i&&191!==i&&240!==i&&241!==i&&255!==i&&242!==i&&248!==i){const t=(192&e[7])>>>6,i=e[8];let n=h.Dh,o=h.Dh;2!==t&&3!==t||(n=BigInt(Math.floor(536870912*(14&e[9])+4194304*(255&e[10])+16384*(254&e[11])+128*(255&e[12])+(254&e[13])/2)),o=3===t?BigInt(Math.floor(536870912*(14&e[14])+4194304*(255&e[15])+16384*(254&e[16])+128*(255&e[17])+(254&e[18])/2)):n),a.dts=o,a.pts=n;const c=9+i;let d=0;if(0!==r){if(r<3+i)return void s.z3("Malformed PES: PES_packet_length < 3 + PES_header_data_length","src/avformat/formats/mpegts/function/parsePESSlice.ts",93);d=r-3-i}else d=e.byteLength-c;a.payload=e.subarray(c,c+d)}else if((188===i||191===i||240===i||241===i||255===i||242===i||248===i)&&6===a.streamId){const t=6;let i=0;i=0!==r?r:e.byteLength-t,a.payload=e.subarray(t,t+i)}return a}(i);!function(t,e,i){t.randomAccessIndicator&&n.M[15](e+36,1|a.f[15](e+36));const r=i.codecpar.codecId;27!==r&&173!==r||n.M[15](e+80,2),n.M[15](e+32,i.index),n.M[17](e+16,t.dts),n.M[17](e+8,t.pts),n.M[17](e+56,t.pos),n.M[15](e+76,9e4),n.M[15](e+72,1),i.startTime===h.Dh&&(i.startTime=a.f[17](e+8)||a.f[17](e+16));const s=(0,z.sY)(t.payload.length);(0,T.lW)(s,t.payload.length,t.payload),(0,F.NX)(e,s,t.payload.length)}(o,e,r),k(i);const c=r.privData;if(c.filter){let i=0;if(i=c.filter.sendAVPacket(e),i<0)return s.z3("send avpacket to bsf failed",et,179),L.LR;if(i=c.filter.receiveAVPacket(e),i<0)return s.z3("receive avpacket from bsf failed",et,186),L.LR;for(n.M[15](e+76,9e4),n.M[15](e+72,1),n.M[15](e+32,r.index),this.checkExtradata(e,r);;){const e=this.cacheAVPacket||(0,F._5)();if(i=c.filter.receiveAVPacket(e),0!==i){this.cacheAVPacket=e;break}n.M[15](e+76,9e4),n.M[15](e+72,1),n.M[15](e+32,r.index),this.checkExtradata(e,r),t.interval.packetBuffer.push(e),this.cacheAVPacket=0}}else{const t=this.context.pmt.pid2StreamType.get(c.pid);if(3===t||4===t){n.M[15](e+36,1|a.f[15](e+36));const t=(0,F.iI)(e),i=t[1]>>>3&3,s=(6&t[1])>>1,o=(12&t[2])>>>2,c=3&~(t[3]>>>6)?2:1,h=H.Au(s),d=H.Y2(i,o);(r.codecpar.profile!==h||r.codecpar.sampleRate!==d||r.codecpar.chLayout.nbChannels!==c)&&(r.codecpar.profile=h,r.codecpar.sampleRate=d,r.codecpar.chLayout.nbChannels=c,r.codecpar.channels=c)}else 27===r.codecpar.codecId?r.codecpar.extradata||(Z.ci(e),this.checkExtradata(e,r),r.codecpar.bitFormat=2):173===r.codecpar.codecId&&(r.codecpar.extradata||(tt.ci(e),this.checkExtradata(e,r),r.codecpar.bitFormat=2))}return 0}async readAVPacket_(t,e){if(this.context.ioEnd){if(!this.context.tsSliceQueueMap.size)return-1048576;const i=this.context.tsSliceQueueMap.values();let r;for(;;){const t=i.next();if(t.value&&t.value.slices.length){r=t.value;break}if(t.done)break}if(!r)return-1048576;const a=t.streams.find((t=>t.privData.pid===r.pid));return a?this.parsePESSlice(t,e,r,a):(k(r),this.readAVPacket_(t,e))}try{for(;;){const a=await I(t.ioReader,this.context);if(!a.payload)continue;if(0===a.pid||a.pid===this.context.currentPmtPid||134===this.context.pmt.pid2StreamType.get(a.pid)){B(a,this.context);continue}const n=this.context.pmt.pid2StreamType.get(a.pid);if(!n)continue;let s=t.streams.find((t=>t.privData.pid===a.pid));s||(s=t.createStream(),K(a.pid,s,this.context));let o=a.payload[4]<<8|a.payload[5],c=this.context.tsSliceQueueMap.get(a.pid),h=!1;if(c){if(c.totalLength>0&&a.payloadUnitStartIndicator){const i=this.parsePESSlice(t,e,c,s);if(i<0)return i;h=!0}}else{if(!a.payloadUnitStartIndicator)continue;c=new f,this.context.tsSliceQueueMap.set(a.pid,c)}var i,r;if(a.payloadUnitStartIndicator&&(c.randomAccessIndicator=null!==(i=null===(r=a.adaptationFieldInfo)||void 0===r?void 0:r.randomAccessIndicator)&&void 0!==i?i:0,c.pos=a.pos,c.pid=a.pid,c.streamType=n,c.expectedLength=0===o?0:o+6),c.slices.push(a.payload),c.totalLength+=a.payload.length,c.expectedLength>0&&c.expectedLength===c.totalLength){const i=this.parsePESSlice(t,e,c,s);if(i<0)return i;h=!0}if(h)return 0}}catch(i){if(-1048576!==t.ioReader.error||this.context.ioEnd){if(-1048576===t.ioReader.error)return-1048576;throw i}return this.context.ioEnd=!0,this.readAVPacket_(t,e)}}async readAVPacket(t,e){try{return this.readAVPacket_(t,e)}catch(e){return-1048576!==t.ioReader.error&&s.z3(e.message,et,406),t.ioReader.error}}async syncTSPacket(t){let e=h.Dh;for(;;)try{if(71===await t.ioReader.readUint8()){e=this.context.tsPacketSize===U?t.ioReader.getPos()-BigInt(5):t.ioReader.getPos()-BigInt(1);let i=0,r=t.ioReader.getPos();for(;i<=10&&(await t.ioReader.skip(this.context.tsPacketSize-1),71===await t.ioReader.readUint8());)i++;if(i<10){e=h.Dh,await t.ioReader.seek(r);continue}break}}catch(t){e=h.Dh;break}if(e!==h.Dh)for(await t.ioReader.seek(e);;){if((await I(t.ioReader,this.context)).payloadUnitStartIndicator){await t.ioReader.seek(e),t.streams.forEach((t=>{let e=this.context.tsSliceQueueMap.get(t.privData.pid);e&&k(e)}));break}e=t.ioReader.getPos()}}async seek(t,e,i,r){let a=t.ioReader.getPos();if(this.context.tsSliceQueueMap.forEach((t=>{t.slices.length&&t.pos<a&&(a=t.pos),k(t)})),this.context.pmt.pid2StreamType.forEach(((t,e)=>{this.context.tsSliceQueueMap.delete(e)})),16&r){const r=(0,$.k)(i,e.timeBase,h.i0);return await t.ioReader.seek(r,!0),this.context.ioEnd=!1,BigInt(0)}if(e&&e.sampleIndexes.length){let r=G.El(e.sampleIndexes,(t=>t.pts>i?-1:1));if(r>0&&(0,$.k)(i-e.sampleIndexes[r-1].pts,e.timeBase,h.i0)<BigInt(1e4))return s.Yz(`seek in sampleIndexes, found index: ${r}, pts: ${e.sampleIndexes[r-1].pts}, pos: ${e.sampleIndexes[r-1].pos}`,et,516),await t.ioReader.seek(e.sampleIndexes[r-1].pos),this.context.ioEnd=!1,a}if(2&r){const e=await t.ioReader.fileSize();return e<=BigInt(0)?BigInt(L.E$):(i<BigInt(0)?i=BigInt(0):i>e&&(i=e),await t.ioReader.seek(i),4&r||await this.syncTSPacket(t),this.context.ioEnd=!1,a)}{s.Yz("not found any keyframe index, try to seek in bytes",et,548);let r=await(0,q.A)(t,e,i,this.firstTSPacketPos,this.readAVPacket.bind(this),this.syncTSPacket.bind(this));return r>=0&&(this.context.ioEnd=!1),r}}getAnalyzeStreamsCount(){var t,e;return null!==(t=null===(e=this.context.pmt)||void 0===e?void 0:e.pid2StreamType.size)&&void 0!==t?t:0}}},7550:(t,e,i)=>{i.d(e,{A:()=>u});var r=i(3939),a=i(9599),n=i(915),s=i(7231),o=i(4328),c=i(2739);function h(t,e,i){let r=BigInt(0);return c.__(t,(t=>{r+=t.codecpar.bitRate*(0,o.k)(e,i,s.i0)/BigInt(8e3)})),r}var d=i(1517),l=i(9705),f=i(4624),p="src/avformat/function/seekInBytes.ts";async function u(t,e,i,c,u,g){const m=t.ioReader.getPos(),b=await t.ioReader.fileSize();let U=s.Dh,w=i;e.startTime!==s.Dh?w-=e.startTime:w-=e.firstDTS;const A=(0,o.k)(i,e.timeBase,s.i0);if(A<BigInt(1e4))return f.Yz(`seek pts is earlier then 10s, seek to first packet pos(${c}) directly`,p,63),await t.ioReader.seek(c),m;let y=h(t.streams,w,e.timeBase);const x=b-h(t.streams,BigInt(5e3),s.i0),P=h(t.streams,BigInt(1e4),s.i0);if(y>x&&(y=x),y<c)return await t.ioReader.seek(c),m;const I=(0,d._5)();let k=b,M=BigInt(0);for(;;){if(k-M<P){U=M;break}await t.ioReader.seek(y),await g(t);const e=t.ioReader.getPos();if(!(await u(t,I)>=0))break;{const t=(0,o.k)(r.f[17](I+8),(0,n.A)(I+72,a.P),s.i0),i=t-A;if(f.Yz(`try to seek to pos: ${y}, got packet pts: ${r.f[17](I+8)}(${t}ms), diff: ${i}ms`,p,98),i<=BigInt(0)&&-i<BigInt(1e4)){U=e;break}i>BigInt(0)?(k=y,y=M+k>>BigInt(1)):(M=y,y=M+k>>BigInt(1))}}return(0,d.Qe)(I),U!==s.Dh?(f.Yz(`finally seek to pos ${U}`,p,124),await t.ioReader.seek(U),await g(t),m):(await t.ioReader.seek(m),BigInt(l.E$))}},3991:(t,e,i)=>{function r(t){let e=0,i=0;for(;i<32&&0===t.readU1();)i++;return e=t.readU(i),e+=(1<<i)-1,e}function a(t){let e=r(t);return e=1&e?(e+1)/2:-e/2,e}i.d(e,{$x:()=>a,xb:()=>r})},264:(t,e,i)=>{function r(t){return t.length>4&&0===t[0]&&0===t[1]&&(1===t[2]||0===t[2]&&1===t[3])}function a(t,e){let i=0;for(let r=e;r<t.length;r++)switch(t[r]){case 0:i++;break;case 1:if(i>=2)return{offset:r-Math.min(i,3),startCode:Math.min(i+1,4)};i=0;break;default:i=0}return{offset:-1,startCode:0}}function n(t){const e=[];let i=a(t,0),r={offset:-1,startCode:0};for(;r=a(t,i.offset+i.startCode),r.offset>-1;)e.push(t.subarray(i.offset+i.startCode,r.offset,!0)),i=r;return e.push(t.subarray(i.offset+i.startCode,void 0,!0)),e}function s(t,e=0,i){i||(i=t.length);const r=new Uint8Array(t.length);let a=0,n=0;for(let s=0;s<t.length;s++){if(s>=e&&s<i)if(0===t[s])a++;else if(3===t[s]&&2===a&&s+1<t.length&&t[s+1]<=3){if(s++,s===t.length)break;a=0===t[s]?1:0}else a=0;r[n++]=t[s]}return r.slice(0,n)}i.d(e,{BN:()=>s,Bs:()=>r,py:()=>n})},7246:(t,e,i)=>{i.d(e,{A:()=>n});var r=i(1026),a=i(4624);class n{constructor(t=1048576){(0,r.A)(this,"buffer",void 0),(0,r.A)(this,"pointer",void 0),(0,r.A)(this,"bitsLeft",void 0),(0,r.A)(this,"size",void 0),(0,r.A)(this,"endPointer",void 0),(0,r.A)(this,"error",void 0),(0,r.A)(this,"onFlush",void 0),this.pointer=0,this.bitsLeft=8,this.size=t,this.endPointer=0,this.error=0,this.buffer=new Uint8Array(this.size)}peekU1(){let t=0;(this.remainingLength()<1||1===this.remainingLength()&&0===this.bitsLeft)&&this.flush();let e=this.pointer,i=this.bitsLeft;return 0===i&&(e++,i=8),t=this.buffer[e]>>i-1&1,t}readU1(){let t=0;return(this.remainingLength()<1||1===this.remainingLength()&&0===this.bitsLeft)&&this.flush(),this.bitsLeft--,t=this.buffer[this.pointer]>>this.bitsLeft&1,0===this.bitsLeft&&(this.pointer++,this.bitsLeft=8),t}readU(t){let e=0;for(let i=0;i<t;i++)e|=this.readU1()<<t-i-1;return e}remainingLength(){return this.endPointer-this.pointer}flush(){if(!this.onFlush)throw this.error=-1048575,Error("IOReader error, flush failed because of no flush callback");if(0===this.bitsLeft&&this.pointer++,!(this.size-this.remainingLength()<=0))if(this.pointer<this.endPointer){this.buffer.set(this.buffer.subarray(this.pointer,this.endPointer),0);const t=this.onFlush(this.buffer.subarray(this.endPointer-this.pointer,this.size));if(t<0)throw this.error=t,Error("IOReader error, flush failed");this.endPointer=this.endPointer-this.pointer+t,this.pointer=0}else{const t=this.onFlush(this.buffer);if(this.endPointer=t,this.pointer=0,this.bitsLeft=8,t<0)throw this.error=t,Error("IOReader error, flush failed")}}getBuffer(){return this.buffer}appendBuffer(t){if(this.size-this.endPointer>=t.length)this.buffer.set(t,this.endPointer),this.endPointer+=t.length;else if(this.buffer.set(this.buffer.subarray(this.pointer,this.endPointer),0),this.endPointer=this.endPointer-this.pointer,this.pointer=0,this.size-this.endPointer>=t.length)this.buffer.set(t,this.endPointer),this.endPointer+=t.length;else{const e=Math.min(this.size-this.endPointer,t.length);this.buffer.set(t.subarray(0,e),this.endPointer),this.endPointer+=e,a.R8("BSReader, call appendBuffer but the buffer's size is lagger then the remaining size","src/common/io/BitReader.ts",170)}}clear(){this.pointer=this.endPointer=0,this.bitsLeft=8,this.error=0}skipPadding(){this.bitsLeft<8&&(this.bitsLeft=8,this.pointer++)}}},6079:(t,e,i)=>{i.d(e,{A:()=>s});var r=i(1026),a=i(4624),n=i(11);class s{constructor(t,e=!0){(0,r.A)(this,"data",void 0),(0,r.A)(this,"buffer",void 0),(0,r.A)(this,"byteStart",void 0),(0,r.A)(this,"pos",void 0),(0,r.A)(this,"size",void 0),(0,r.A)(this,"littleEndian",void 0),this.buffer=t,this.data=t instanceof Uint8Array?new DataView(t.buffer):t.view,this.byteStart=t instanceof Uint8Array?t.byteOffset:0,this.pos=0,this.size=t.byteLength,this.littleEndian=!e}writeUint8(t){this.data.setUint8(this.pos+++this.byteStart,t)}writeUint16(t){this.data.setUint16(this.pos+this.byteStart,t,this.littleEndian),this.pos+=2}writeUint24(t){const e=3840&t,i=240&t,r=15&t;this.littleEndian?(this.writeUint8(r),this.writeUint8(i),this.writeUint8(e)):(this.writeUint8(e),this.writeUint8(i),this.writeUint8(r))}writeUint32(t){this.data.setUint32(this.pos+this.byteStart,t,this.littleEndian),this.pos+=4}writeUint64(t){const e=t&BigInt(4294967295),i=(t&BigInt(4294967295)<<BigInt(32))>>BigInt(32);this.littleEndian?(this.writeUint32(Number(e)),this.writeUint32(Number(i))):(this.writeUint32(Number(i)),this.writeUint32(Number(e)))}writeInt8(t){this.data.setInt8(this.pos+++this.byteStart,t)}writeInt16(t){this.data.setInt16(this.pos+this.byteStart,t,this.littleEndian),this.pos+=2}writeInt32(t){this.data.setInt32(this.pos+this.byteStart,t,this.littleEndian),this.pos+=4}writeInt64(t){const e=t&BigInt(4294967295),i=(t&BigInt(4294967295)<<BigInt(32))>>BigInt(32);this.littleEndian?(this.writeInt32(Number(e)),this.writeInt32(Number(i))):(this.writeInt32(Number(i)),this.writeInt32(Number(e)))}writeFloat(t){this.data.setFloat32(this.pos+this.byteStart,t,this.littleEndian),this.pos+=4}writeDouble(t){this.data.setFloat64(this.pos+this.byteStart,t,this.littleEndian),this.pos+=8}getPos(){return this.pos}seek(t){t>this.size&&(t=this.size),this.pos=Math.max(0,t)}skip(t){this.seek(this.pos+t)}back(t){this.seek(this.pos-t)}remainingSize(){return this.size-this.pos}writeBuffer(t){let e=t.length;this.remainingSize()<e&&(e=this.remainingSize(),a.R8(`the remaining buffer size is smaller then the wrote buffer, hope set ${t.length}, but set ${e}`,"src/common/io/StreamWriter.ts",211)),this.buffer.set(t,this.pos),this.pos+=t.length}writeString(t){const e=n.l(t);return this.writeBuffer(e),e.length}getWroteBuffer(){return this.buffer.subarray(0,this.pos)}resetBuffer(t,e=!0){this.buffer=t,this.data=t instanceof Uint8Array?new DataView(t.buffer):t.view,this.byteStart=t instanceof Uint8Array?t.byteOffset:0,this.pos=0,this.size=t.byteLength,this.littleEndian=!e}}}}]);